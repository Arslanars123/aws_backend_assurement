import{r as m,b as _,a as V,j as e,R as r,C as o}from"./index-B342vN8a.js";import{C as H}from"./ComponentContainerCard-BIxSgnld.js";import{P as J}from"./PageMetaData-__vP5leC.js";import{B as x}from"./urls-CvG9cD6N.js";import{F as l}from"./FormLabel-f-qql_Cp.js";import{F as i}from"./FormControl-CJr_RFax.js";import{I as M}from"./Image-B0PQ6faj.js";import{B as C}from"./Button-BnzdNfRx.js";import{A as W,C as Y,T as q}from"./TextField-BYbQgC-7.js";import"./Card-CI8IuqFE.js";import"./divWithClassName-BnSMb2ls.js";import"./FormContext-BMEMUOIr.js";import"./useFormControl-CZmJVi9l.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const z={name:"",username:"",role:"Independent Controller",phone:"",address:"",city:"",postalCode:"",startDate:"",cvr:"",contactPerson:"",contactPhone:""},de=()=>{const[t,y]=m.useState(z),[w,D]=m.useState([]),[g,F]=m.useState([]),[b,P]=m.useState(null),[N,j]=m.useState(null),[v,S]=m.useState({}),[A,E]=m.useState(!1),f=m.useRef(null),{companyId:p,projectId:u=null}=_(),I=V(),d=n=>{const{name:a,value:s}=n.target;y({...t,[a]:s}),a==="username"&&s&&O(s)},R=n=>{const a=n.target.files[0];if(P(a),a){const s=URL.createObjectURL(a);j(s)}},T=()=>{P(null),j(null),f.current&&(f.current.value="")},O=async n=>{try{const s=await(await fetch(`${x}/check-user-exists?username=${encodeURIComponent(n)}`)).json();if(s.exists&&s.user){const h={name:s.user.name||"",phone:s.user.phone||"",address:s.user.address||"",city:s.user.city||"",postalCode:s.user.postalCode||"",startDate:s.user.startDate||"",cvr:s.user.cvr||"",contactPerson:s.user.contactPerson||"",contactPhone:s.user.contactPhone||""};if(S(h),E(!0),y(c=>({...c,name:s.user.name||c.name,phone:s.user.phone||c.phone,address:s.user.address||c.address,city:s.user.city||c.city,postalCode:s.user.postalCode||c.postalCode,startDate:s.user.startDate||c.startDate,cvr:s.user.cvr||c.cvr,contactPerson:s.user.contactPerson||c.contactPerson,contactPhone:s.user.contactPhone||c.contactPhone})),s.user.picture){const c=s.user.picture.startsWith("http")?s.user.picture:`${x.replace("/api","")}/uploads/${s.user.picture}`;j(c)}alert(`User with email ${n} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(a){console.error("Error checking user existence:",a)}},$=()=>{if(!A)return!1;const n={name:t.name||"",phone:t.phone||"",address:t.address||"",city:t.city||"",postalCode:t.postalCode||"",startDate:t.startDate||"",cvr:t.cvr||"",contactPerson:t.contactPerson||"",contactPhone:t.contactPhone||""};return Object.keys(v).some(a=>n[a]!==v[a])},k=async()=>{try{if($()){if(!window.confirm("You have modified some auto-filled fields. This will update the existing user's information across all documents. Are you sure you want to continue?"))return;await U()}const n=new FormData;Object.keys(t).forEach(s=>{n.append(s,t[s])}),n.append("companyId",p),n.append("projectsId",u),b&&n.append("contactPicture",b);const a=await fetch(`${x}/store-user`,{method:"POST",body:n});if(a.ok){const s=await a.json();I(`/dashboard/companies/view/${p}`,{state:{success:"IndependentController added successfully!"}})}else console.error("Error:",a.statusText)}catch(n){console.error("Fetch error:",n)}},U=async()=>{try{const n=await fetch(`${x}/update-existing-user`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t.username,name:t.name,phone:t.phone,address:t.address,city:t.city,postalCode:t.postalCode,startDate:t.startDate})});n.ok||console.error("Error updating existing user:",n.statusText)}catch(n){console.error("Error updating existing user:",n)}},L=async()=>{try{const a=await(await fetch(`${x}/get-independent-controller?companyId=${p}`)).json();D(a)}catch(n){console.log("error",n)}};m.useEffect(()=>{p&&u&&L()},[p,u]);const B=async()=>{try{const a={userIds:g.map(h=>h._id),projectId:u},s=await fetch(`${x}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(s.ok){const h=await s.json();I(`/dashboard/companies/view/${p}/projects/view/${u}`,{state:{success:"Advisor added successfully!"}})}else console.error("Error:",s.statusText)}catch(n){console.log("Error adding Advisor to project:",n)}};return e.jsxs(e.Fragment,{children:[e.jsx(J,{title:"Add Independent Controller"}),!u&&e.jsx(r,{className:"justify-content-center",children:e.jsx(o,{children:e.jsxs(H,{title:"Add Independent Controller",children:[e.jsxs(r,{children:[e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.name,onChange:d,name:"name",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.username,onChange:d,name:"username",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"phone-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.phone,onChange:d,name:"phone",type:"text",id:"phone-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"address-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.address,onChange:d,name:"address",type:"text",id:"address-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"city-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.city,onChange:d,name:"city",type:"text",id:"city-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"postalCode-input",className:"col-sm-2 col-form-label text-end",children:"Postal Code"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.postalCode,onChange:d,name:"postalCode",type:"text",id:"postalCode-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"startDate-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t==null?void 0:t.startDate,onChange:d,name:"startDate",type:"date",id:"startDate-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"CVR. NR."}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t.cvr,onChange:d,name:"cvr",type:"text",id:"cvr-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"Contact Person"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t.contactPerson,onChange:d,name:"contactPerson",type:"text",id:"contact-person-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"Phone (Contact)"}),e.jsx(o,{sm:"10",children:e.jsx(i,{value:t.contactPhone,onChange:d,name:"contactPhone",type:"text",id:"contact-phone-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"Picture (Contact)"}),e.jsxs(o,{sm:"10",children:[e.jsx(i,{type:"file",id:"contact-picture-input",name:"contactPicture",onChange:R,accept:"image/*",ref:f}),N&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(M,{src:N,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(C,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:T,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]})]})]})})]}),e.jsx(r,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(C,{onClick:k,variant:"primary",className:"me-1",children:"Submit"})})})]})})}),u&&e.jsxs(r,{className:"mb-3",children:[e.jsx(l,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Independent Controller for this Project"}),e.jsx(o,{sm:"10",children:e.jsx(W,{multiple:!0,options:w,getOptionLabel:n=>n.name,isOptionEqualToValue:(n,a)=>n._id===a._id,value:g,onChange:(n,a)=>{F(a)},renderInput:n=>e.jsx(q,{...n,variant:"outlined",placeholder:"Search and select Inspector..."}),renderTags:(n,a)=>n.map((s,h)=>e.jsx(Y,{label:s.name,...a({index:h})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})}),e.jsx(r,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(C,{type:"submit",variant:"primary",className:"me-1",onClick:B,children:"Submit"})})})]})]})};export{de as default};
