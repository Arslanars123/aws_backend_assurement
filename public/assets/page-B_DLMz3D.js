import{r as i,b as H,a as W,ab as q,j as e,R as o,C as n}from"./index-S4cPkaXI.js";import{C as G}from"./ComponentContainerCard-CPsL5TPV.js";import{P as J}from"./PageMetaData-u0IuTTri.js";import{B as g}from"./urls-DHmWp6-I.js";import{F as d}from"./FormLabel-xT7fLwVI.js";import{F as b}from"./FormControl-DZh-Msrb.js";import{F as R}from"./FormSelect--prDjbZc.js";import{I}from"./Image-C0iuPhbd.js";import{B as v}from"./Button-BdLFNPe1.js";import"./Card-DerqaWgt.js";import"./divWithClassName-23-JlBVG.js";import"./FormContext-3vyf8OR-.js";const oe=()=>{const[r,m]=i.useState(null),[$,P]=i.useState(!1),[D,L]=i.useState(!0),[N,K]=i.useState(null),[Q,_]=i.useState(null),[h,S]=i.useState([]),[x,y]=i.useState([]),{deviationId:p}=H(),k=W(),[B]=q(),w=B.get("report");i.useRef(null);const f=i.useRef(null),[T,F]=i.useState([]);i.useEffect(()=>{p&&fetch(`${g}/get-deviation-detail/${p}`).then(async s=>{const t=await s.json();m({...t,picture2:t.picture,pictures2:t.pictures}),t.picture&&t.picture!=="null"&&_(`https://147.93.94.31/uploads/${t.picture}`),t.pictures&&t.pictures.length>0&&F(t.pictures.map(a=>`https://147.93.94.31/uploads/${a}`))}).catch(s=>console.error(s)).finally(()=>L(!1))},[p]);const C=s=>{const{name:t,value:a}=s.target;m({...r,[t]:a})},E=s=>{const{name:t,value:a,multiple:c,options:l}=s.target;if(c){const u=Array.from(l).filter(j=>j.selected).map(j=>j.value);m({...r,[t]:u})}else m({...r,[t]:a})};i.useEffect(()=>{(async()=>{try{const a=await(await fetch(`${g}/get-projects`)).json();A(a)}catch(t){console.error("Error fetching projects:",t)}})()},[]);const[U,A]=i.useState([]),M=s=>{const t=Array.from(s.target.files),a=[...h,...t],c=[...x,...t.map(l=>URL.createObjectURL(l))];S(a),y(c)},O=s=>{const t=h.filter((l,u)=>u!==s),a=x.filter((l,u)=>u!==s);S(t),y(a);const c=new DataTransfer;t.forEach(l=>c.items.add(l)),f.current&&(f.current.files=c.files)},V=async s=>{s.preventDefault(),P(!0);const t=new FormData;Object.keys(r).forEach(a=>{t.append(a,r[a])}),N&&t.append("picture",N),h.forEach(a=>{t.append("pictures",a)});try{const a=await fetch(`${g}/update-deviation/${p}`,{method:"POST",body:t});if(a.ok){const c=await a.json(),l=w?`/dashboard/projects?report=${w}`:"/dashboard/deviations";k(l,{state:{success:"Deviation updated successfully!"}})}else console.error("Error:",a.statusText)}catch(a){console.error("Fetch error:",a)}P(!1)},z=s=>{F(t=>t.filter((a,c)=>c!==s)),m(t=>{if(!t)return null;const a=t.pictures2.filter((c,l)=>l!==s);return{...t,pictures2:a.length>0?a:[]}})};return e.jsxs(e.Fragment,{children:[e.jsx(J,{title:"Edit Deviation"}),D?null:e.jsx("form",{onSubmit:V,children:e.jsx(o,{className:"justify-content-center",children:e.jsx(n,{children:e.jsx(G,{title:"Edit Deviation",children:e.jsxs(o,{children:[e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Serial Number"}),e.jsx(n,{sm:"10",children:e.jsx(b,{value:r==null?void 0:r.serialNumber,onChange:C,name:"serialNumber",type:"text",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(n,{sm:"10",children:e.jsx(b,{value:r==null?void 0:r.comment,onChange:C,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(n,{sm:"10",children:e.jsxs(R,{value:r.profession,name:"profession",onChange:E,children:[e.jsx("option",{defaultValue:"",children:"Select Profession"}),professions.map(s=>e.jsxs("option",{value:s.indexNumber,children:[s.indexNumber," "]},s.id))]})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Select Projects"}),e.jsx(n,{sm:"10",children:e.jsxs(R,{value:r.projectsId,name:"projectsId",onChange:E,multiple:!0,children:[e.jsx("option",{defaultValue:"",children:"Select Projects"}),U.map(s=>e.jsxs("option",{value:s._id,children:[s.name," "]},s.id))]})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(n,{sm:"10",children:[e.jsx(b,{type:"file",id:"multiple-file-input",name:"pictures",onChange:M,accept:"image/*",multiple:!0,ref:f}),e.jsxs("div",{className:"mt-3 d-flex flex-wrap",children:[x.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(I,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(v,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>O(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)),T.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(I,{src:s,alt:`Existing Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(v,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>z(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},`existing-${t}`))]})]})]})}),e.jsx(o,{className:"mb-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(v,{disabled:$,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{oe as default};
