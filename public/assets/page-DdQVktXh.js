import{r as i,a as ce,b as de,j as e,R as l,C as o}from"./index-CcXmhF8I.js";import{C as me}from"./ComponentContainerCard-DfOGF2MZ.js";import{P as pe}from"./PageMetaData-_VBvv3yh.js";import{B as f}from"./urls-BhGeBsON.js";import{D as ue}from"./page-BhJyEnzt.js";import{P as he}from"./page-BssMbynW.js";import{F as m}from"./FormLabel-ur_7HqrZ.js";import{F as D}from"./FormControl-IaSihKBy.js";import{F as xe}from"./FormSelect-Cej4LfTs.js";import{A as C,C as I,T as b}from"./TextField-DX6iEtHg.js";import{I as ge}from"./Image-BA0SNZ1J.js";import{B as T}from"./Button-Bb5NLKr0.js";import"./Card-BbEwloSO.js";import"./divWithClassName-stAqo3H6.js";import"./Modal-DS3RX9z9.js";import"./useWindow-Dt3mh2_H.js";import"./DataKey-SibGzzBh.js";import"./NoopTransition-C0OklqXl.js";import"./FormRange-CQhrKEDN.js";import"./PDFButton-ck9OA1nG.js";import"./Alert-BzuID01t.js";import"./Anchor-CgtXfp9s.js";import"./useFormControl-DAPC7iVt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const fe={supplementory:"",time:"",item:null,selectedDrawing:null,projectManager:null,recipients:null},Je=()=>{var M,R,$,E;const[a,p]=i.useState(fe),[O,F]=i.useState(!1),[U,z]=i.useState([]),[j,B]=i.useState({show:!1,imgUrl:null}),L=i.useRef(),[P,W]=i.useState(null),[J,_]=i.useState([]),[V,q]=i.useState([]),[H,G]=i.useState([]),[K,Q]=i.useState(10),[x,v]=i.useState({show:!1,pdfFile:null,name:null}),[X,Y]=i.useState({}),[u,y]=i.useState([]),[N,A]=i.useState([]),S=i.useRef(null),Z=ce(),{companyId:g,projectId:h}=de(),k=t=>{const{name:s,value:n}=t.target;p({...a,[s]:n})};i.useEffect(()=>{ee(),se(),ae()},[h]);const ee=async()=>{try{const s=await(await fetch(`${f}/get-draws?companyId=${g}&projectId=${h}`)).json();z(s)}catch(t){console.error("Error fetching workers:",t)}},te=t=>{const{name:s,value:n,multiple:r,options:c}=t.target;if(r){const d=Array.from(c).filter(w=>w.selected).map(w=>w.value);p({...a,[s]:d})}else p({...a,[s]:n})},se=async()=>{try{const t=`${f}/get-project-managers?companyId=${g}&projectId=${h}`,n=await(await fetch(t)).json();_(n)}catch(t){console.error("Error fetching project managers:",t)}},ae=async()=>{try{const t=`${f}/get-filter-users`,r=await(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:g,projectId:h})})).json();q(r)}catch(t){console.error("Error fetching users:",t)}},ne=t=>{const s=Array.from(t.target.files),n=s.map(d=>({file:d,description:""})),r=[...u,...n],c=[...N,...s.map(d=>URL.createObjectURL(d))];y(r),A(c)},re=t=>{const s=u.filter((c,d)=>d!==t),n=N.filter((c,d)=>d!==t);y(s),A(n);const r=new DataTransfer;s.forEach(c=>r.items.add(c.file)),S.current&&(S.current.files=r.files)},oe=(t,s)=>{const n=[...u];n[t].description=s,y(n)},ie=async t=>{t.preventDefault(),F(!0);try{const s=new FormData;Object.keys(a).forEach(r=>{r==="projectManager"||r==="selectedDrawing"||r==="recipients"||s.append(r,a[r])}),s.append("companyId",g),s.append("projectsId",h),s.append("drawing",JSON.stringify(a.selectedDrawing)),s.append("projectManager",JSON.stringify(a.projectManager)),s.append("recipients",JSON.stringify(a.recipients)),P&&s.append("annotatedImage",P),u.length>0&&u.forEach((r,c)=>{s.append("pictures",r.file),s.append("pictureDescriptions",r.description||"")}),Object.entries(X).forEach(([r,c])=>{const le=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;s.append("annotatedPdfs",c,le)});const n=await fetch(`${f}/store-new`,{method:"POST",body:s});if(n.ok){const r=await n.json();Z(`/dashboard/companies/view/${g}/projects/view/${h}`,{state:{success:"New Aggrement added successfully!"}})}else console.error("Error:",n.statusText)}catch(s){console.error("Fetch error:",s)}F(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(pe,{title:"Add New Aggrement"}),e.jsx("form",{onSubmit:ie,children:e.jsx(l,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(me,{title:"Add New Aggrement",children:e.jsxs(l,{children:[e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Extra info"}),e.jsx(o,{sm:"10",children:e.jsx(D,{value:a.supplementory,onChange:k,name:"supplementory",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Days | Hours"}),e.jsx(o,{sm:"10",children:e.jsx(D,{value:a.time,onChange:k,name:"time",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(o,{sm:"10",children:e.jsxs(xe,{value:a.item,name:"item",onChange:te,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"A new agreement has been concluded with construction management today.",children:"A new agreement has been concluded with construction management today."}),e.jsx("option",{value:"Change work has been notified.",children:"Change work has been notified."}),e.jsx("option",{value:"Forced work must be agreed, due to delays from other contractors",children:"Forced work must be agreed, due to delays from other contractors"}),e.jsx("option",{value:"The construction management has instructed a change in the work that must be carried out in accounting work.",children:"The construction management has instructed a change in the work that must be carried out in accounting work."}),e.jsx("option",{value:"Work that has been necessary for safety or for the sake of construction.",children:"Work that has been necessary for safety or for the sake of construction."}),e.jsx("option",{value:"Someone has destroyed my work after final inspection.",children:"Someone has destroyed my work after final inspection."})]})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(o,{sm:"10",children:e.jsx(C,{multiple:!1,options:V,getOptionLabel:t=>t.name,value:a==null?void 0:a.recipients,onChange:(t,s)=>{p({...a,recipients:s})},renderInput:t=>e.jsx(b,{...t,variant:"outlined",placeholder:"Search and select Project Users..."}),renderTags:(t,s)=>t.map((n,r)=>e.jsx(I,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(o,{sm:"10",children:e.jsx(C,{multiple:!1,options:J,getOptionLabel:t=>t.name,value:a==null?void 0:a.projectManager,onChange:(t,s)=>{p({...a,projectManager:s})},renderInput:t=>e.jsx(b,{...t,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(t,s)=>t.map((n,r)=>e.jsx(I,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(C,{multiple:!1,options:U,getOptionLabel:t=>t.name,value:a==null?void 0:a.selectedDrawing,onChange:(t,s)=>{p({...a,selectedDrawing:s})},renderInput:t=>e.jsx(b,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t.map((n,r)=>e.jsx(I,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(m,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(o,{sm:"10",children:[e.jsx(D,{type:"file",id:"multiple-file-input",name:"pictures",onChange:ne,accept:"image/*",multiple:!0,ref:S}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:N.map((t,s)=>{var n;return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(ge,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:((n=u[s])==null?void 0:n.description)||"",onChange:r=>oe(s,r.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(T,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>re(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s)})})]})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(o,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(R=(M=a==null?void 0:a.selectedDrawing)==null?void 0:M.mainDrawings)==null?void 0:R.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=t.original;v({show:!0,pdfFile:`${f}/uploads/${t.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`main-${s}`))})]}),(x==null?void 0:x.show)&&e.jsx(he,{pdfUrl:x.pdfFile,onClose:()=>v({show:!1,pdfFile:null}),onSave:t=>{Y(s=>({...s,[x.name]:t})),v({show:!1,pdfFile:null})}}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(o,{lg:"12",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(E=($=a==null?void 0:a.selectedDrawing)==null?void 0:$.childDrawings)==null?void 0:E.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`child-${s}`))})]}),(j==null?void 0:j.show)&&e.jsx(o,{lg:"6",children:e.jsx(l,{children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(ue,{ref:L,drawDotsOnImage:j,setDrawDotsAnImage:B,onSave:t=>{W(t)},setMarkers:G,markers:H,dotSize:K,setDotSize:Q})})})}),e.jsx(l,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(T,{disabled:O,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Je as default};
