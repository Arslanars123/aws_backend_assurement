import{r as l,a as Z,b as V,j as e,R as i,C as o}from"./index-DXGzwTDX.js";import{C as ee}from"./ComponentContainerCard-BdqSoKWJ.js";import{B as g}from"./urls-BhGeBsON.js";import{D as se}from"./index-BxxeenNT.js";import{P as te}from"./page-DEewqJvp.js";import{F as f}from"./FormLabel-MRPFOBK0.js";import{A as v,C as w,T as j}from"./TextField-DD5ZZLTe.js";import{I as ae}from"./Image-DXZMDITT.js";import{B as O}from"./Button-Q8P5klcO.js";import"./Card-BF03U0a9.js";import"./divWithClassName-WthjuUgX.js";import"./page-DRHJaXUb.js";import"./Modal-pNXPnpNb.js";import"./useWindow-D1WaCGvc.js";import"./DataKey-DeFhA7Nw.js";import"./NoopTransition-CDGbDsLX.js";import"./FormRange-B5lnwdc-.js";import"./PDFButton-CA3UgHlN.js";import"./Alert-BIE78wlt.js";import"./Anchor-OB-3XvKs.js";import"./useFormControl-BMCg-VWj.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const re={profession:null,user:null,controlPlan:null,comment:null,date:null,drawing:null},ne=["understood and is buildable","Approved","is not clearly described","Accepted","Follows the project material"];function De(){var $,D,I,E,F,A;const[a,h]=l.useState(re),[R,M]=l.useState(!0),T=Z(),{companyId:b,projectId:d,staticReportId:L}=V(),[U,_]=l.useState([]),[m,N]=l.useState({show:!1,pdfFile:null,name:null}),[z,W]=l.useState({}),[J,B]=l.useState([]),[G,Y]=l.useState([]),[S,H]=l.useState(0),[x,y]=l.useState([]),[C,k]=l.useState([]);l.useRef(null),l.useEffect(()=>{(async()=>{try{const r=await(await fetch(`${g}/get-company-professions?companyId=${b}&projectId=${d}`)).json();B(r)}catch(t){console.error("Error fetching professions:",t)}})()},[]),l.useEffect(()=>{a.profession&&a.controlPlan&&a.comment&&a.date&&a.drawing&&M(!1),a.profession&&q()},[a]);const q=async()=>{var s;try{const t={companyId:b,projectId:d,professionsIds:[(s=a==null?void 0:a.profession)==null?void 0:s._id],roles:["Sub Contractor","Worker"]},n=await(await fetch(`${g}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();_(n)}catch(t){console.error("Error fetching project managers:",t)}},K=async()=>{try{const t=await(await fetch(`${g}/get-draws?companyId=${b}&projectId=${d}`)).json();Y(t)}catch(s){console.error("Error fetching workers:",s)}};l.useEffect(()=>{d&&K()},[b,d]);const Q=async()=>{try{const s=new FormData;s.append("projectId",d),s.append("staticReportId",L),s.append("profession",JSON.stringify(a.profession)),s.append("user",JSON.stringify(a.user)),s.append("controlPlan",JSON.stringify(a.controlPlan)),s.append("comment",a.comment),s.append("date",a.date),s.append("drawing",JSON.stringify(a.drawing)),Object.entries(z).forEach(([r,n])=>{if(n){const c=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;s.append("annotatedPdfs",n,c)}}),x.length>0&&x.forEach((r,n)=>{if(r.file){s.append("pictures",r.file);const p=r.markNumber?`Mark #${r.markNumber}: ${r.description||""}`:r.description||"";s.append("pictureDescriptions",p)}}),(await fetch(`${g}/submit-static-report`,{method:"POST",body:s})).ok&&T(`/dashboard/companies/view/${b}/projects/view/${d}`)}catch(s){console.log("error",s)}};return e.jsx(i,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(ee,{title:"Static Reports Submit",children:e.jsxs(i,{children:[e.jsx(o,{lg:"6",children:e.jsxs(i,{className:"mb-3",children:[e.jsx(f,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(o,{sm:"10",children:e.jsx(v,{multiple:!1,options:J,getOptionLabel:s=>s.GroupName,value:a.profession??null,onChange:(s,t)=>{var r;((r=t==null?void 0:t.EuroCode)==null?void 0:r.length)>0&&(t==null?void 0:t.Static_report)==="Y"||!t?h({...a,profession:t}):alert("you can't submit this checklist against this profession")},renderInput:s=>e.jsx(j,{...s,variant:"outlined",placeholder:"Search and select profession..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(w,{label:r.GroupName,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(i,{className:"mb-3",children:[e.jsx(f,{className:"col-sm-2 col-form-label text-end",children:"Select User"}),e.jsx(o,{sm:"10",children:e.jsx(v,{multiple:!1,options:U,getOptionLabel:s=>{var t;return`${s.name} (${(t=s.userProfession)==null?void 0:t.map(r=>r.GroupName).join(", ")})`},value:a.user??null,onChange:(s,t)=>{h({...a,user:t})},renderInput:s=>e.jsx(j,{...s,variant:"outlined",placeholder:"Search and select project Manager..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(w,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(i,{className:"mb-3",children:[e.jsx(f,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(o,{sm:"10",children:e.jsx(v,{multiple:!1,options:ne,value:a.controlPlan??null,onChange:(s,t)=>{h({...a,controlPlan:t})},renderInput:s=>e.jsx(j,{...s,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(w,{label:r,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(i,{className:"mb-3",children:[e.jsx(f,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(o,{sm:"10",children:e.jsx(j,{variant:"outlined",placeholder:"Add some comments...",value:a==null?void 0:a.comment,onChange:s=>{var t;h({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(i,{className:"mb-3",children:[e.jsx(f,{className:"col-sm-2 col-form-label text-end",children:"Select Date"}),e.jsx(o,{sm:"10",children:e.jsx(se,{value:a==null?void 0:a.date,onChange:s=>{const r=s[0].toISOString().split("T")[0];h({...a,date:r})},className:"form-control",options:{dateFormat:"Y-m-d"}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(i,{className:"mb-3",children:[e.jsx(f,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(v,{multiple:!1,options:G,getOptionLabel:s=>s.name,value:a==null?void 0:a.drawing,onChange:(s,t)=>{h({...a,drawing:t})},renderInput:s=>e.jsx(j,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(w,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsx(i,{className:"",children:(D=($=a==null?void 0:a.drawing)==null?void 0:$.mainDrawings)==null?void 0:D.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=s.original;N({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s.original})]},`main-${t}`))})}),((E=(I=a==null?void 0:a.drawing)==null?void 0:I.childDrawings)==null?void 0:E.length)>0&&e.jsx(o,{lg:"6",children:e.jsx(i,{className:"",children:(A=(F=a==null?void 0:a.drawing)==null?void 0:F.childDrawings)==null?void 0:A.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=s.original;N({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s.original})]},`child-${t}`))})}),(m==null?void 0:m.show)&&e.jsx(te,{pdfUrl:m.pdfFile,onClose:()=>N({show:!1,pdfFile:null}),onSave:(s,t)=>{H(t),W(r=>({...r,[m.name.endsWith(".png")?m.name:`${m.name}.png`]:s})),N({show:!1,pdfFile:null})}}),S>0&&e.jsx(o,{lg:"12",children:e.jsxs(i,{className:"mb-3",children:[e.jsxs(f,{className:"col-sm-2 col-form-label text-end",children:["Pictures for Marks (",S,")"]}),e.jsx(o,{sm:"10",children:e.jsx("div",{className:"mb-3",children:Array.from({length:S}).map((s,t)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),e.jsx(FormControl,{type:"file",name:`picture-mark-${t+1}`,onChange:r=>{const n=Array.from(r.target.files);if(n.length>0){const p=[...x];n.forEach(c=>{p.push({file:c,description:"",markNumber:t+1})}),y(p);const u=[...C];n.forEach(c=>{u.push(URL.createObjectURL(c))}),k(u)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:x.map((r,n)=>{if(r.markNumber===t+1){const p=C[n];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(ae,{src:p,alt:`Preview ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(j,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:u=>{const c=[...x];c[n]={...c[n],description:u.target.value},y(c)},fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(O,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>{const u=x.filter((X,P)=>P!==n);y(u);const c=C.filter((X,P)=>P!==n);k(c)},style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},n)}return null})})]},t))})})]})}),e.jsx(i,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(O,{variant:"primary",className:"me-1",disabled:R,onClick:Q,children:"Submit"})})})]})})})})}export{De as default};
