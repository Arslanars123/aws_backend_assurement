import{r as i,b as V,a as z,j as e,R as o,C as n}from"./index-BfjhYpb5.js";import{C as H}from"./ComponentContainerCard-BbSfpbsX.js";import{P as W}from"./PageMetaData-CFx5C9vJ.js";import{B as g}from"./urls-CXtk4x-h.js";import{F as d}from"./FormLabel-9Op50W6F.js";import{F as v}from"./FormControl-u0lKnE3u.js";import{F as E}from"./FormSelect-CIOplRxv.js";import{I as R}from"./Image-D3CG5EY4.js";import{B as b}from"./Button-0d7iDM-S.js";import"./Card-CjeZJw7I.js";import"./divWithClassName-CLs3g5aQ.js";const ie=()=>{const[r,m]=i.useState(null),[I,N]=i.useState(!1),[$,D]=i.useState(!0),[P,q]=i.useState(null),[G,L]=i.useState(null),[h,S]=i.useState([]),[x,y]=i.useState([]),{deviationId:p}=V(),_=z();i.useRef(null);const f=i.useRef(null),[B,w]=i.useState([]);i.useEffect(()=>{p&&fetch(`${g}/get-deviation-detail/${p}`).then(async s=>{const t=await s.json();m({...t,picture2:t.picture,pictures2:t.pictures}),t.picture&&t.picture!=="null"&&L(`https://147.93.94.31/uploads/${t.picture}`),t.pictures&&t.pictures.length>0&&w(t.pictures.map(a=>`https://147.93.94.31/uploads/${a}`))}).catch(s=>console.error(s)).finally(()=>D(!1))},[p]);const F=s=>{const{name:t,value:a}=s.target;m({...r,[t]:a})},C=s=>{const{name:t,value:a,multiple:l,options:c}=s.target;if(l){const u=Array.from(c).filter(j=>j.selected).map(j=>j.value);m({...r,[t]:u})}else m({...r,[t]:a})};i.useEffect(()=>{(async()=>{try{const a=await(await fetch(`${g}/get-projects`)).json();k(a)}catch(t){console.error("Error fetching projects:",t)}})()},[]);const[T,k]=i.useState([]),A=s=>{const t=Array.from(s.target.files),a=[...h,...t],l=[...x,...t.map(c=>URL.createObjectURL(c))];S(a),y(l)},M=s=>{const t=h.filter((c,u)=>u!==s),a=x.filter((c,u)=>u!==s);S(t),y(a);const l=new DataTransfer;t.forEach(c=>l.items.add(c)),f.current&&(f.current.files=l.files)},O=async s=>{s.preventDefault(),N(!0);const t=new FormData;Object.keys(r).forEach(a=>{t.append(a,r[a])}),P&&t.append("picture",P),h.forEach(a=>{t.append("pictures",a)});try{const a=await fetch(`${g}/update-deviation/${p}`,{method:"POST",body:t});if(a.ok){const l=await a.json();_("/dashboard/deviations",{state:{success:"Deviation updated successfully!"}})}else console.error("Error:",a.statusText)}catch(a){console.error("Fetch error:",a)}N(!1)},U=s=>{w(t=>t.filter((a,l)=>l!==s)),m(t=>{if(!t)return null;const a=t.pictures2.filter((l,c)=>c!==s);return{...t,pictures2:a.length>0?a:[]}})};return e.jsxs(e.Fragment,{children:[e.jsx(W,{title:"Edit Deviation"}),$?null:e.jsx("form",{onSubmit:O,children:e.jsx(o,{className:"justify-content-center",children:e.jsx(n,{children:e.jsx(H,{title:"Edit Deviation",children:e.jsxs(o,{children:[e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Serial Number"}),e.jsx(n,{sm:"10",children:e.jsx(v,{value:r==null?void 0:r.serialNumber,onChange:F,name:"serialNumber",type:"text",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(n,{sm:"10",children:e.jsx(v,{value:r==null?void 0:r.comment,onChange:F,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(n,{sm:"10",children:e.jsxs(E,{value:r.profession,name:"profession",onChange:C,children:[e.jsx("option",{defaultValue:"",children:"Select Profession"}),professions.map(s=>e.jsxs("option",{value:s.indexNumber,children:[s.indexNumber," "]},s.id))]})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Select Projects"}),e.jsx(n,{sm:"10",children:e.jsxs(E,{value:r.projectsId,name:"projectsId",onChange:C,multiple:!0,children:[e.jsx("option",{defaultValue:"",children:"Select Projects"}),T.map(s=>e.jsxs("option",{value:s._id,children:[s.name," "]},s.id))]})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(n,{sm:"10",children:[e.jsx(v,{type:"file",id:"multiple-file-input",name:"pictures",onChange:A,accept:"image/*",multiple:!0,ref:f}),e.jsxs("div",{className:"mt-3 d-flex flex-wrap",children:[x.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(R,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(b,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>M(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)),B.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(R,{src:s,alt:`Existing Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(b,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>U(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},`existing-${t}`))]})]})]})}),e.jsx(o,{className:"mb-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(b,{disabled:I,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{ie as default};
