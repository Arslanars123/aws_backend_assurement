import{r as l,b as de,ab as me,a as pe,G as ue,j as e,R as m,C as c}from"./index-CEbbE1Sf.js";import{C as ge}from"./ComponentContainerCard-BpYspYtC.js";import{P as he}from"./PageMetaData-qE4R9bbS.js";import{B as f}from"./urls-CvG9cD6N.js";import{P as je}from"./page-CBT_MneI.js";import{F as w}from"./FormLabel-WQTNbj7P.js";import{F as fe}from"./FormSelect-Dmi-PE_I.js";import{A as U,C as I,T as P}from"./TextField-CeDJPKh1.js";import{F as J}from"./FormControl-DFJ9Ydzw.js";import{I as R}from"./Image-ULHo9GWi.js";import{B as $}from"./Button-CWQV4UHt.js";import"./Card-mt6mV6AB.js";import"./divWithClassName-CT9nWrpT.js";import"./Modal-C5567GrF.js";import"./useWindow-Bj2vCJZa.js";import"./useEventCallback-C6szz9nn.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-PrPCoCM2.js";import"./FormRange-MzNiwPri.js";import"./FormContext-CSwRqVJr.js";import"./PDFButton-m7iMGlez.js";import"./Alert-DHIJxZou.js";import"./hook-CyH9mnqt.js";import"./Anchor-BXgEd0Ob.js";import"./useFormControl-BPpZZpE7.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Xe=()=>{var O,L,_,z,W,B;const[a,p]=l.useState(null),[H,E]=l.useState(!1),[G,Q]=l.useState(!0),[T,xe]=l.useState(null),[we,K]=l.useState(null),[u,b]=l.useState([]),[x,F]=l.useState([]),{requestId:v,companyId:d,projectId:g}=de(),[V]=me(),X=pe();l.useRef(null);const M=l.useRef(null),[Y,A]=l.useState([]),{selectedCompany:be,selectedProjects:ve,selectedProfession:Ne,companies:ye}=l.useContext(ue),[N,Z]=l.useState([]),[y,ee]=l.useState([]),[D,se]=l.useState([]),[h,S]=l.useState({show:!1,pdfFile:null,name:null}),[te,re]=l.useState({}),[C,ae]=l.useState(0),k=V.get("report");l.useEffect(()=>{v&&fetch(`${f}/get-request-detail/${v}`).then(async t=>{const s=await t.json(),r={item:s.item||"",selectedDrawing:s.drawing||s.selectedDrawing||null,projectUsers:s.projectUsers||s.users||null,projectManager:s.projectManager||null,comment:s.comment||""};p(r),s.picture&&s.picture!=="null"&&K(`https://147.93.94.31/uploads/${s.picture}`),s.pictures&&s.pictures.length>0&&A(s.pictures.map(n=>`https://147.93.94.31/uploads/${n}`))}).catch(t=>console.error(t)).finally(()=>Q(!1))},[v]),l.useEffect(()=>{const t=async()=>{try{const i=await(await fetch(`${f}/get-draws?companyId=${d}&projectId=${g}`)).json();Z(i)}catch(n){console.error("Error fetching drawings:",n)}},s=async()=>{try{const n=`${f}/get-filter-users`,j=await(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:d,projectId:g})})).json();ee(j)}catch(n){console.error("Error fetching users:",n)}};(async()=>{try{const n=`${f}/get-project-managers?companyId=${d}&projectId=${g}`,o=await(await fetch(n)).json();se(o)}catch(n){console.error("Error fetching project managers:",n)}})(),s(),t()},[d,g]),l.useEffect(()=>{if(a&&N.length>0&&y.length>0&&D.length>0){let t={...a},s=!1;if(a.selectedDrawing&&typeof a.selectedDrawing=="string"&&a.selectedDrawing.trim()!==""){const r=N.find(n=>n._id===a.selectedDrawing||n.id===a.selectedDrawing);r&&(t.selectedDrawing=r,s=!0)}if(a.projectUsers&&typeof a.projectUsers=="string"&&a.projectUsers.trim()!==""){const r=y.find(n=>n._id===a.projectUsers||n.id===a.projectUsers);r&&(t.projectUsers=r,s=!0)}if(a.projectManager&&typeof a.projectManager=="string"&&a.projectManager.trim()!==""){const r=D.find(n=>n._id===a.projectManager||n.id===a.projectManager);r&&(t.projectManager=r,s=!0)}s&&p(t)}},[N,y,D]);const ne=t=>{const{name:s,value:r}=t.target;p({...a,[s]:r})},ie=t=>{const s=Array.from(t.target.files),r=[...u,...s],n=[...x,...s.map(i=>URL.createObjectURL(i))];b(r),F(n)},q=t=>{const s=u.filter((i,o)=>o!==t),r=x.filter((i,o)=>o!==t);b(s),F(r);const n=new DataTransfer;s.forEach(i=>n.items.add(i)),M.current&&(M.current.files=n.files)},le=(t,s)=>{const r=[...u];r[t].description=s,b(r)},oe=async t=>{t.preventDefault(),E(!0);const s=new FormData;s.append("companyId",d),s.append("projectsId",g),s.append("comment",a.comment),s.append("item",a.item),s.append("projectUsers",JSON.stringify(a.projectUsers)),s.append("projectManager",JSON.stringify(a.projectManager)),s.append("drawing",JSON.stringify(a.selectedDrawing)),T&&s.append("picture",T),u.length>0&&u.forEach((r,n)=>{s.append("pictures",r.file),s.append("pictureDescriptions",r.description||"")}),Object.entries(te).forEach(([r,n])=>{const j=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;s.append("annotatedPdfs",n,j)});try{const r=await fetch(`${f}/update-request/${v}`,{method:"POST",body:s});if(r.ok){const n=await r.json(),i=g?`/dashboard/companies/view/${d}/projects/view/${g}`:d?`/dashboard/companies/view/${d}/requests`:"/dashboard/requests",o=k?`?report=${encodeURIComponent(k)}`:"";X(`${i}${o}`,{state:{success:"Technical Request updated successfully!"}})}else console.error("Error:",r.statusText)}catch(r){console.error("Fetch error:",r)}E(!1)},ce=t=>{A(s=>s.filter((r,n)=>n!==t)),p(s=>{if(!s)return null;const r=s.pictures2.filter((n,i)=>i!==t);return{...s,pictures2:r.length>0?r:[]}})};return e.jsxs(e.Fragment,{children:[e.jsx(he,{title:"Edit Technical Request"}),G||!a?e.jsxs("div",{className:"text-center p-4",children:[e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2",children:"Loading request data..."})]}):e.jsx("form",{onSubmit:oe,children:e.jsx(m,{className:"justify-content-center",children:e.jsx(c,{children:e.jsx(ge,{title:"Edit Technical Request",children:e.jsxs(m,{children:[e.jsx(c,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(w,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(c,{sm:"10",children:e.jsxs(fe,{value:a.item||"",name:"item",onChange:ne,children:[e.jsx("option",{value:"",children:"Select Item"}),e.jsx("option",{value:"Does not include project material.",children:"Does not include project material."}),e.jsx("option",{value:"Meeting at the construction site is required.",children:"Meeting at the construction site is required."}),e.jsx("option",{value:"There is no preparation as told.",children:"There is no preparation as told."}),e.jsx("option",{value:"A new instruction is requested here, as it is not possible",children:"A new instruction is requested here, as it is not possible"})]})})]})}),e.jsx(c,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(w,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(c,{sm:"10",children:e.jsx(U,{multiple:!1,options:D,getOptionLabel:t=>t.name,value:a==null?void 0:a.projectManager,onChange:(t,s)=>{p({...a,projectManager:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(t,s)=>t.map((r,n)=>e.jsx(I,{label:r.name,...s({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(c,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(w,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(c,{sm:"10",children:e.jsx(U,{multiple:!1,options:y,getOptionLabel:t=>t.name,value:a==null?void 0:a.projectUsers,onChange:(t,s)=>{p({...a,projectUsers:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and project Users drawing..."}),renderTags:(t,s)=>t.map((r,n)=>e.jsx(I,{label:r.name,...s({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(c,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(w,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(c,{sm:"10",children:e.jsx(U,{multiple:!1,options:N,getOptionLabel:t=>t.name?t.name:t.mainDrawings&&t.mainDrawings.length>0&&t.mainDrawings[0].original||"No name available",value:a==null?void 0:a.selectedDrawing,onChange:(t,s)=>{p({...a,selectedDrawing:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t.map((r,n)=>{const i=r.name||(r.mainDrawings&&r.mainDrawings.length>0?r.mainDrawings[0].original:"No name available");return e.jsx(I,{label:i,...s({index:n})})}),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(c,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(L=(O=a==null?void 0:a.selectedDrawing)==null?void 0:O.mainDrawings)==null?void 0:L.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=t.original;S({show:!0,pdfFile:`${f}/uploads/${t.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`main-${s}`))})]}),(h==null?void 0:h.show)&&e.jsx(je,{pdfUrl:h.pdfFile,onClose:()=>S({show:!1,pdfFile:null}),onSave:(t,s)=>{ae(s),re(r=>({...r,[h.name.endsWith(".png")?h.name:`${h.name}.png`]:t})),S({show:!1,pdfFile:null})}}),(a==null?void 0:a.selectedDrawing)&&((z=(_=a==null?void 0:a.selectedDrawing)==null?void 0:_.childDrawings)==null?void 0:z.length)>0&&e.jsxs(c,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(B=(W=a==null?void 0:a.selectedDrawing)==null?void 0:W.childDrawings)==null?void 0:B.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=t.original;S({show:!0,pdfFile:`${f}/uploads/${t.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`child-${s}`))})]}),e.jsx(c,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(w,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:C>0?`Pictures (${C} marks)`:"Pictures"}),e.jsx(c,{sm:"10",children:C>0?e.jsx("div",{className:"mb-3",children:Array.from({length:C}).map((t,s)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",s+1]}),e.jsx(J,{type:"file",name:`picture-mark-${s+1}`,onChange:r=>{const n=Array.from(r.target.files);if(n.length>0){const i=[...u];n.forEach(j=>{i.push({file:j,description:"",markNumber:s+1})}),b(i);const o=[...x];n.forEach(j=>{o.push(URL.createObjectURL(j))}),F(o)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:u.map((r,n)=>{if(r.markNumber===s+1){const i=x[n];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(R,{src:i,alt:`Preview ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(P,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:o=>le(n,o.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx($,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>q(n),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},n)}return null})})]},s))}):e.jsxs(e.Fragment,{children:[e.jsx(J,{type:"file",id:"multiple-file-input",name:"pictures",onChange:ie,accept:"image/*",multiple:!0,ref:M}),e.jsxs("div",{className:"mt-3 d-flex flex-wrap",children:[x.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(R,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx($,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>q(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},s)),Y.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(R,{src:t,alt:`Existing Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx($,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ce(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},`existing-${s}`))]})]})})]})}),e.jsx(m,{className:"mb-3 d-flex justify-content-center",children:e.jsx(c,{sm:"12",className:"d-flex justify-content-end",children:e.jsx($,{disabled:H,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Xe as default};
