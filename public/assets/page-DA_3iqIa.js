import{r as n,G as Z,a as ee,b as te,j as t,R as c,C as o}from"./index-Bhcfarzr.js";import{C as se}from"./ComponentContainerCard-CdRpaZOK.js";import{B as d}from"./urls-BhGeBsON.js";import{D as ae}from"./page-DsBsX5T8.js";import{F as g}from"./FormLabel-DMds24G0.js";import{F}from"./FormControl-7WYzlHOA.js";import{A as y,T as S,C}from"./TextField-Cu90f4AT.js";import{I as R}from"./Image-C3Ku7nKI.js";import{B}from"./Button-COOVOJrI.js";import"./Card-CWpROabE.js";import"./divWithClassName-DTdHczRx.js";import"./Modal-Bdr1VgJM.js";import"./useWindow-Bs6pFJHF.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-f-8MxV6X.js";import"./FormRange-PkgODM1Q.js";import"./useSlot-B59Th0xZ.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-BcofISFZ.js";const re={comment:"",selectBuildingParts:null,selectedDrawing:null,selectUser:null},ne={Process:"yellow",Receive:"purple",Final:"green"};function Pe(){var D,$;const[a,h]=n.useState(re),{clickTask:l}=n.useContext(Z),[O,T]=n.useState([]),[U,A]=n.useState([]),f=n.useRef(null),[j,w]=n.useState([]),[x,b]=n.useState({show:!1,imgUrl:null}),[v,P]=n.useState([]),N=ee(),{companyId:p,projectId:m,taskId:I}=te(),E=n.useRef(),[k,L]=n.useState(null),[M,_]=n.useState([]),[J,W]=n.useState([]),[z,q]=n.useState(10),G=e=>{const{name:s,value:r}=e.target;h({...a,[s]:r})},H=async()=>{try{const s=await(await fetch(`${d}/get-draws?companyId=${p}&projectId=${m}`)).json();T(s)}catch(e){console.error("Error fetching workers:",e)}},V=async()=>{try{const e=`${d}/get-parts`,r=await(await fetch(e)).json();A(r)}catch(e){console.log(e)}},K=async()=>{try{const e=`${d}/get-filter-users`,r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:p,projectId:m,taskId:I,roles:["Sub Contractor","Worker"]})});if(!r.ok)throw new Error("Failed to fetch users");const i=await r.json();_(i)}catch(e){console.error("Error fetching users:",e)}};n.useEffect(()=>{if(l&&(h({comment:l.comment||"",selectBuildingParts:l.buildingParts||null,selectedDrawing:l.drawing||null,selectUser:l.user||null}),l.annotatedImage&&b({show:!0,imgUrl:`${d}/uploads/${l.annotatedImage}`}),l.pictures&&l.pictures.length>0)){const e=l.pictures.map(s=>`${d}/uploads/${s}`);w(e)}},[l]),n.useEffect(()=>{p&&m&&(H(),V(),K())},[p,m]);const Q=e=>{const s=Array.from(e.target.files),r=[...v,...s],i=[...j,...s.map(u=>URL.createObjectURL(u))];P(r),w(i)},X=e=>{const s=v.filter((i,u)=>u!==e),r=j.filter((i,u)=>u!==e);if(P(s),w(r),f.current){const i=new DataTransfer;s.forEach(u=>i.items.add(u)),f.current.files=i.files}},Y=async()=>{if(!p||!m){N("/dashboard/companies");return}if(!a.selectedDrawing||!a.selectBuildingParts){alert("Please select both a drawing and building part.");return}try{const e=new FormData;e.append("comment",a.comment),e.append("projectId",m),e.append("taskId",I),e.append("buildingParts",JSON.stringify(a.selectBuildingParts)),e.append("drawing",JSON.stringify(a.selectedDrawing)),e.append("user",JSON.stringify(a.selectUser)),k&&e.append("annotatedImage",k),v.forEach(r=>{e.append("pictures",r)});const s=await fetch(`${d}/submit-task`,{method:"POST",body:e});if(s.ok)N(`/dashboard/companies/view/${p}/projects/view/${m}`);else{const r=await s.json();alert(`Error: ${r.message||"Failed to update task."}`)}}catch(e){console.error("Submit error:",e),alert("Something went wrong while submitting the task.")}};return t.jsx(c,{className:"justify-content-center",children:t.jsx(o,{children:t.jsx(se,{title:"Submit Task",children:t.jsxs(c,{children:[t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),t.jsx(o,{sm:"10",children:t.jsx(F,{value:a==null?void 0:a.comment,onChange:G,name:"comment",type:"text",id:"example-text-input"})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),t.jsx(o,{sm:"10",children:t.jsx(y,{multiple:!1,options:U,getOptionLabel:e=>e.name,value:a.selectBuildingParts,onChange:(e,s)=>{h({...a,selectBuildingParts:s})},renderInput:e=>t.jsx(S,{...e,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(e,s)=>e.map((r,i)=>t.jsx(C,{label:r.name,...s({index:i})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"select User"}),t.jsx(o,{sm:"10",children:t.jsx(y,{multiple:!1,options:M,getOptionLabel:e=>e.name,value:a.selectUser,onChange:(e,s)=>{h({...a,selectUser:s})},renderOption:(e,s)=>n.createElement("li",{...e,key:s._id},s.name),renderInput:e=>t.jsx(S,{...e,variant:"outlined",placeholder:"Search and select user for this task..."}),renderTags:(e,s)=>e.map((r,i)=>t.jsx(C,{label:r.name,...s({index:i})},r._id)),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),t.jsxs(o,{sm:"10",children:[t.jsx(F,{type:"file",id:"multiple-file-input",name:"pictures",onChange:Q,accept:"image/*",multiple:!0,ref:f}),t.jsx("div",{className:"mt-3 d-flex flex-wrap",children:j.map((e,s)=>t.jsxs("div",{className:"position-relative me-2 mb-2",children:[t.jsx(R,{src:e,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),t.jsx(B,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>X(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s))})]})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),t.jsx(o,{sm:"10",children:t.jsx(y,{multiple:!1,options:O,getOptionLabel:e=>e.name,value:a==null?void 0:a.selectedDrawing,onChange:(e,s)=>{h({...a,selectedDrawing:s})},renderInput:e=>t.jsx(S,{...e,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(e,s)=>e.map((r,i)=>t.jsx(C,{label:r.name,...s({index:i})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsx(c,{className:"",children:($=(D=a==null?void 0:a.selectedDrawing)==null?void 0:D.pictures)==null?void 0:$.map((e,s)=>t.jsx("div",{className:"position-relative me-2 mb-2",children:t.jsx(R,{src:`${d}/uploads/${e}`,onClick:()=>{b({show:!0,imgUrl:`${d}/uploads/${e}`})},alt:`Existing Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}})},`existing-${s}`))})}),(x==null?void 0:x.show)&&t.jsx(o,{lg:"6",children:t.jsx(c,{children:t.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:t.jsx(ae,{ref:E,backgroundColor:ne[l==null?void 0:l.Type],drawDotsOnImage:x,setDrawDotsAnImage:b,onSave:e=>{L(e)},setMarkers:W,markers:J,dotSize:z,setDotSize:q})})})}),t.jsx(c,{className:"mb-3 d-flex justify-content-center",children:t.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:t.jsx(B,{type:"submit",variant:"primary",className:"me-1",onClick:Y,children:"Submit"})})})]})})})})}export{Pe as default};
