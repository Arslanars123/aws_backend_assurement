import{r as o,a as Z,b as ee,j as e,R as l,C as i}from"./index-DpbIAROa.js";import{C as se}from"./ComponentContainerCard-kAFFVE0Z.js";import{P as te}from"./PageMetaData-C6UhIQjj.js";import{B as c}from"./urls-CXtk4x-h.js";import{D as ae}from"./page-BNX7ZN3D.js";import{F as u}from"./FormLabel-BVfCwwhh.js";import{F as A}from"./FormControl-CRveXHIl.js";import{A as w,T as v,C as y}from"./TextField-FXRTZwW7.js";import{I as R}from"./Image-B69svh6Q.js";import{B as k}from"./Button-DGaw8vsr.js";import"./Card-DYgbdisJ.js";import"./divWithClassName-DPLQ3Lm2.js";import"./Modal-C9CqSm-2.js";import"./useWindow-9G6U8rOx.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-YmUpd_Fy.js";import"./FormRange-BeCgdMae.js";import"./useSlot-DUXHA9fQ.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-BcofISFZ.js";const ne={comment:"",profession:null,selectBuildingParts:null,selectedDrawing:null},Ne=({type:B})=>{var $,F;const[a,f]=o.useState(ne),[E,S]=o.useState(!1),I=Z(),[O,M]=o.useState([]),[h,N]=o.useState([]),[g,P]=o.useState([]),[T,L]=o.useState([]),[U,z]=o.useState([]),[J,W]=o.useState([]),[x,C]=o.useState({show:!1,imgUrl:null}),[_,G]=o.useState(10),[D,H]=o.useState(null),j=o.useRef(null),{companyId:d,projectId:m}=ee(),Q=o.useRef(),V=t=>{const{name:s,value:n}=t.target;f({...a,[s]:n})},Y=async()=>{var t;try{const s=`${c}/get-parts?SubjectMatterId=${(t=a==null?void 0:a.profession)==null?void 0:t.SubjectMatterId}`,r=await(await fetch(s)).json();z(r)}catch(s){console.log(s)}};o.useEffect(()=>{a.profession&&Y()},[a.profession]),console.log("form.profession",a.profession),o.useEffect(()=>{const t=async()=>{try{const r=await(await fetch(`${c}/get-company-professions?companyId=${d}&projectId=${m}`)).json();L(r)}catch(n){console.error("Error fetching professions:",n)}},s=async()=>{try{const r=await(await fetch(`${c}/get-draws?companyId=${d}&projectId=${m}`)).json();W(r)}catch(n){console.error("Error fetching workers:",n)}};t(),s()},[]);const q=t=>{const s=Array.from(t.target.files),n=[...h,...s],r=[...g,...s.map(p=>URL.createObjectURL(p))];N(n),P(r)},K=t=>{const s=h.filter((p,b)=>b!==t),n=g.filter((p,b)=>b!==t);N(s),P(n);const r=new DataTransfer;s.forEach(p=>r.items.add(p)),j.current&&(j.current.files=r.files)},X=async t=>{if(t.preventDefault(),!(a!=null&&a.profession)){alert("You must select company, project and profession"),I(`/dashboard/companies/view/${d}/projects/view/${m}`);return}S(!0);try{const s=new FormData;s.append("type",B),s.append("companyId",d),s.append("projectId",m),s.append("comment",a.comment),s.append("profession",JSON.stringify(a.profession)),s.append("buildingParts",JSON.stringify(a.selectBuildingParts)),s.append("drawing",JSON.stringify(a.selectedDrawing)),D&&s.append("annotatedImage",D),h.forEach(r=>{s.append("pictures",r)});const n=await fetch(`${c}/store-deviation`,{method:"POST",body:s});if(n.ok)I(`/dashboard/companies/view/${d}/projects/view/${m}`);else{const r=await n.json();alert(`Error: ${r.message||"Failed to update task."}`)}}catch(s){console.error("Fetch error:",s)}S(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(te,{title:"Add Deviation In Quality Assurance"}),e.jsx("form",{onSubmit:X,children:e.jsx(l,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(se,{title:"Add Deviation In Quality Assurance",children:e.jsxs(l,{children:[e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(A,{value:a.comment,onChange:V,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:T,getOptionLabel:t=>t.GroupName,value:a.profession??null,onChange:(t,s)=>{f({...a,profession:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(t,s)=>t.map((n,r)=>e.jsx(y,{label:n.GroupName,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:U,getOptionLabel:t=>t.name,value:a.selectBuildingParts,onChange:(t,s)=>{f({...a,selectBuildingParts:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(t,s)=>t.map((n,r)=>e.jsx(y,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:J,getOptionLabel:t=>t.name,value:a==null?void 0:a.selectedDrawing,onChange:(t,s)=>{f({...a,selectedDrawing:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t.map((n,r)=>e.jsx(y,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsx(l,{className:"",children:(F=($=a==null?void 0:a.selectedDrawing)==null?void 0:$.pictures)==null?void 0:F.map((t,s)=>e.jsx("div",{className:"position-relative me-2 mb-2",children:e.jsx(R,{src:`${c}/uploads/${t}`,onClick:()=>{C({show:!0,imgUrl:`${c}/uploads/${t}`})},alt:`Existing Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}})},`existing-${s}`))})}),(x==null?void 0:x.show)&&e.jsx(i,{lg:"6",children:e.jsx(l,{children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(ae,{ref:Q,drawDotsOnImage:x,setDrawDotsAnImage:C,onSave:t=>{H(t)},setMarkers:M,markers:O,dotSize:_,setDotSize:G})})})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(i,{sm:"10",children:[e.jsx(A,{type:"file",id:"multiple-file-input",name:"pictures",onChange:q,accept:"image/*",multiple:!0,ref:j}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:g.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(R,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(k,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>K(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s))})]})]})}),e.jsx(l,{className:"mb-3 d-flex justify-content-center",children:e.jsx(i,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(k,{disabled:E,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Ne as default};
