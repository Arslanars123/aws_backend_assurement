import{r as i,a as B,b as H,j as e,R as c,C as n}from"./index-CAFh8Qe-.js";import{C as z}from"./ComponentContainerCard-BHLb5dlU.js";import{P as J}from"./PageMetaData-BdrMy3rA.js";import{B as f}from"./urls-D84fNQqS.js";import{F as d}from"./FormLabel-DJooOqJq.js";import{F as p}from"./FormControl-D6Fi2fvk.js";import{F as Y}from"./FormSelect-DckZIl1p.js";import{I as q}from"./Image-CbaU3Ogc.js";import{B as C}from"./Button-DUm19Z6r.js";import{A as G,C as K,T as Q}from"./TextField-DXeN24BL.js";import"./Card-B6ongrnB.js";import"./divWithClassName-Ds10gy6J.js";import"./FormContext-CVQotS7s.js";import"./useFormControl-BV-vA5Rt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const X={username:"",role:"Construction Manager",phone:"",case:"",startDate:"",name:"",address:"",postalCode:"",city:"",mainId:null},je=()=>{const[l,g]=i.useState(X),[N,I]=i.useState(!1),v=B(),[S,w]=i.useState(null),[F,y]=i.useState(null),b=i.useRef(null),[$,k]=i.useState([]),[P,D]=i.useState([]),[Z,M]=i.useState(null),[ee,A]=i.useState(!1),{companyId:u,projectId:m}=H(),x=s=>{const{name:a,value:t}=s.target;g({...l,[a]:t}),a==="username"&&t&&E(t)},E=async s=>{try{const t=await(await fetch(`${f}/check-user-exists?username=${encodeURIComponent(s)}`)).json();if(t.exists&&t.user){const r={name:t.user.name||"",phone:t.user.phone||"",address:t.user.address||"",city:t.user.city||"",postalCode:t.user.postalCode||"",startDate:t.user.startDate||"",mainId:t.user.mainId||""};if(M(r),A(!0),g(o=>({...o,name:t.user.name||o.name,phone:t.user.phone||o.phone,address:t.user.address||o.address,city:t.user.city||o.city,postalCode:t.user.postalCode||o.postalCode,startDate:t.user.startDate||o.startDate,mainId:t.user.mainId||o.mainId})),t.user.picture){const o=t.user.picture.startsWith("http")?t.user.picture:`${f.replace("/api","")}/uploads/${t.user.picture}`;y(o)}alert(`User with email ${s} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(a){console.error("Error checking user existence:",a)}},R=s=>{const a=s.target.files[0];if(w(a),a){const t=URL.createObjectURL(a);y(t)}},V=async s=>{s.preventDefault();const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,t=/^[0-9]{8,15}$/;if(!a.test(l.username)){alert("Please enter a valid email address.");return}if(!t.test(l.phone)){alert("Please enter a valid phone number (only digits, 8 to 15 characters).");return}I(!0);try{const r=new FormData;Object.keys(l).forEach(h=>{r.append(h,l[h])}),S&&r.append("picture",S),r.append("companyId",u),r.append("projectsId",m);const o=await fetch(`${f}/store-user`,{method:"POST",body:r});if(o.ok){const h=await o.json();v(`/dashboard/companies/view/${u}`,{state:{success:"Construction Manager added successfully!"}})}else console.error("Error:",o.statusText)}catch(r){console.error("Fetch error:",r)}I(!1)},O=s=>{const{name:a,value:t,multiple:r,options:o}=s.target;if(r){const h=Array.from(o).filter(j=>j.selected).map(j=>j.value);g({...l,[a]:h})}else g({...l,[a]:t})},T=()=>{w(null),y(null),b.current&&(b.current.value="")};i.useEffect(()=>{(async()=>{try{const t=await(await fetch(`${f}/get-mains?companyId=${u}`)).json();W(t)}catch(a){console.error("Error fetching mains:",a)}})()},[]);const[U,W]=i.useState([]);i.useEffect(()=>{u&&m&&L()},[u,m]);const L=async()=>{try{const a=await(await fetch(`${f}/get-cons?companyId=${u}`)).json(),r=await(await fetch(`${f}/get-cons?companyId=${u}&projectId=${m}`)).json(),o=a.filter(h=>!r.some(j=>j._id===h._id));k(o)}catch(s){console.error("Error fetching workers:",s)}},_=async()=>{try{if(!m)return;const a={userIds:P.map(r=>r._id),projectId:m},t=await fetch(`${f}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(t.ok){const r=await t.json();v(`/dashboard/companies/view/${u}/projects/view/${m}`,{state:{success:"Construction Manager added successfully!"}})}else console.error("Error:",t.statusText)}catch(s){console.log("Error adding Construction Manager to project:",s)}};return e.jsxs(e.Fragment,{children:[e.jsx(J,{title:"Add Construction Manager"}),!m&&e.jsx("form",{onSubmit:V,children:e.jsx(c,{className:"justify-content-center",children:e.jsx(n,{children:e.jsx(z,{title:"Add Construction Manager",children:e.jsxs(c,{children:[e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.username,onChange:x,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.name,onChange:x,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.phone,onChange:x,name:"phone",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.address,onChange:x,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.city,onChange:x,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.postalCode,onChange:x,name:"postalCode",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(n,{sm:"10",children:e.jsx(p,{value:l.startDate,onChange:x,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Select Main Constructor"}),e.jsx(n,{sm:"10",children:e.jsxs(Y,{value:l.mainId,name:"mainId",onChange:O,children:[e.jsx("option",{defaultValue:"",children:"Select Main Constructor"}),U.map(s=>e.jsxs("option",{value:s._id,children:[s.username," "]},s.id))]})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(n,{sm:"10",children:[e.jsx(p,{type:"file",id:"file-input",name:"picture",onChange:R,accept:"image/*",ref:b}),F&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(q,{src:F,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(C,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:T,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]})]})]})}),e.jsx(c,{className:"mb-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(C,{disabled:N,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),m&&e.jsxs(c,{className:"mb-3",children:[e.jsx(d,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Construction Manager for this Project"}),e.jsxs(n,{sm:"10",children:[e.jsx(G,{multiple:!0,options:$,getOptionLabel:s=>s.name,value:P,onChange:(s,a)=>{D(a)},renderInput:s=>e.jsx(Q,{...s,variant:"outlined",placeholder:"Search and select Construction Manager..."}),renderTags:(s,a)=>s.map((t,r)=>e.jsx(K,{label:t.name,...a({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(c,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(C,{disabled:N,type:"submit",variant:"primary",className:"me-1",onClick:_,children:"Submit"})})})]})]})]})};export{je as default};
