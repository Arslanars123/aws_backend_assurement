import{r as i,a as pe,b as ue,j as e,R as d,C as o}from"./index-DXGzwTDX.js";import{C as he}from"./ComponentContainerCard-BdqSoKWJ.js";import{P as xe}from"./PageMetaData-DqMiWj9r.js";import{B as w}from"./urls-BhGeBsON.js";import{D as ge}from"./page-DRHJaXUb.js";import{P as fe}from"./page-DEewqJvp.js";import{F as u}from"./FormLabel-MRPFOBK0.js";import{F as S}from"./FormControl-gHzxXlg1.js";import{F as je}from"./FormSelect-BwnGZFNn.js";import{A as P,C as F,T as b}from"./TextField-DD5ZZLTe.js";import{I as L}from"./Image-DXZMDITT.js";import{B as A}from"./Button-Q8P5klcO.js";import"./Card-BF03U0a9.js";import"./divWithClassName-WthjuUgX.js";import"./Modal-pNXPnpNb.js";import"./useWindow-D1WaCGvc.js";import"./DataKey-DeFhA7Nw.js";import"./NoopTransition-CDGbDsLX.js";import"./FormRange-B5lnwdc-.js";import"./PDFButton-CA3UgHlN.js";import"./Alert-BIE78wlt.js";import"./Anchor-OB-3XvKs.js";import"./useFormControl-BMCg-VWj.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const we={supplementory:"",time:"",item:null,selectedDrawing:null,projectManager:null,recipients:null},He=()=>{var T,U,O,z;const[n,h]=i.useState(we),[W,I]=i.useState(!1),[B,_]=i.useState([]),[v,J]=i.useState({show:!1,imgUrl:null}),H=i.useRef(),[M,V]=i.useState(null),[q,G]=i.useState([]),[K,Q]=i.useState([]),[X,Y]=i.useState([]),[Z,ee]=i.useState(10),[g,C]=i.useState({show:!1,pdfFile:null,name:null}),[te,se]=i.useState({}),[y,ae]=i.useState(0),[m,N]=i.useState([]),[f,D]=i.useState([]),k=i.useRef(null),ne=pe(),{companyId:j,projectId:x}=ue(),$=t=>{const{name:s,value:r}=t.target;h({...n,[s]:r})};i.useEffect(()=>{re(),le(),ie()},[x]);const re=async()=>{try{const s=await(await fetch(`${w}/get-draws?companyId=${j}&projectId=${x}`)).json();_(s)}catch(t){console.error("Error fetching workers:",t)}},oe=t=>{const{name:s,value:r,multiple:a,options:c}=t.target;if(a){const l=Array.from(c).filter(p=>p.selected).map(p=>p.value);h({...n,[s]:l})}else h({...n,[s]:r})},le=async()=>{try{const t=`${w}/get-project-managers?companyId=${j}&projectId=${x}`,r=await(await fetch(t)).json();G(r)}catch(t){console.error("Error fetching project managers:",t)}},ie=async()=>{try{const t=`${w}/get-filter-users`,a=await(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:j,projectId:x})})).json();Q(a)}catch(t){console.error("Error fetching users:",t)}},ce=t=>{const s=Array.from(t.target.files),r=s.map(l=>({file:l,description:""})),a=[...m,...r],c=[...f,...s.map(l=>URL.createObjectURL(l))];N(a),D(c)},R=t=>{const s=m.filter((c,l)=>l!==t),r=f.filter((c,l)=>l!==t);N(s),D(r);const a=new DataTransfer;s.forEach(c=>a.items.add(c.file)),k.current&&(k.current.files=a.files)},E=(t,s)=>{const r=[...m];r[t].description=s,N(r)},de=async t=>{t.preventDefault(),I(!0);try{const s=new FormData;Object.keys(n).forEach(a=>{a==="projectManager"||a==="selectedDrawing"||a==="recipients"||s.append(a,n[a])}),s.append("companyId",j),s.append("projectsId",x),s.append("drawing",JSON.stringify(n.selectedDrawing)),s.append("projectManager",JSON.stringify(n.projectManager)),s.append("recipients",JSON.stringify(n.recipients)),M&&s.append("annotatedImage",M),m.length>0&&m.forEach((a,c)=>{s.append("pictures",a.file);const l=a.markNumber?`Mark #${a.markNumber}: ${a.description||""}`:a.description||"";s.append("pictureDescriptions",l)}),Object.entries(te).forEach(([a,c])=>{const me=`${a.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;s.append("annotatedPdfs",c,me)});const r=await fetch(`${w}/store-new`,{method:"POST",body:s});if(r.ok){const a=await r.json();ne(`/dashboard/companies/view/${j}/projects/view/${x}`,{state:{success:"New Aggrement added successfully!"}})}else console.error("Error:",r.statusText)}catch(s){console.error("Fetch error:",s)}I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(xe,{title:"Add New Aggrement"}),e.jsx("form",{onSubmit:de,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(he,{title:"Add New Aggrement",children:e.jsxs(d,{children:[e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Extra info"}),e.jsx(o,{sm:"10",children:e.jsx(S,{value:n.supplementory,onChange:$,name:"supplementory",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Days | Hours"}),e.jsx(o,{sm:"10",children:e.jsx(S,{value:n.time,onChange:$,name:"time",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(o,{sm:"10",children:e.jsxs(je,{value:n.item,name:"item",onChange:oe,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"A new agreement has been concluded with construction management today.",children:"A new agreement has been concluded with construction management today."}),e.jsx("option",{value:"Change work has been notified.",children:"Change work has been notified."}),e.jsx("option",{value:"Forced work must be agreed, due to delays from other contractors",children:"Forced work must be agreed, due to delays from other contractors"}),e.jsx("option",{value:"The construction management has instructed a change in the work that must be carried out in accounting work.",children:"The construction management has instructed a change in the work that must be carried out in accounting work."}),e.jsx("option",{value:"Work that has been necessary for safety or for the sake of construction.",children:"Work that has been necessary for safety or for the sake of construction."}),e.jsx("option",{value:"Someone has destroyed my work after final inspection.",children:"Someone has destroyed my work after final inspection."})]})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(o,{sm:"10",children:e.jsx(P,{multiple:!1,options:K,getOptionLabel:t=>t.name,value:n==null?void 0:n.recipients,onChange:(t,s)=>{h({...n,recipients:s})},renderInput:t=>e.jsx(b,{...t,variant:"outlined",placeholder:"Search and select Project Users..."}),renderTags:(t,s)=>t.map((r,a)=>e.jsx(F,{label:r.name,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(o,{sm:"10",children:e.jsx(P,{multiple:!1,options:q,getOptionLabel:t=>t.name,value:n==null?void 0:n.projectManager,onChange:(t,s)=>{h({...n,projectManager:s})},renderInput:t=>e.jsx(b,{...t,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(t,s)=>t.map((r,a)=>e.jsx(F,{label:r.name,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(P,{multiple:!1,options:B,getOptionLabel:t=>t.name,value:n==null?void 0:n.selectedDrawing,onChange:(t,s)=>{h({...n,selectedDrawing:s})},renderInput:t=>e.jsx(b,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t.map((r,a)=>e.jsx(F,{label:r.name,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(u,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:y>0?`Pictures (${y} marks)`:"Pictures"}),e.jsx(o,{sm:"10",children:y>0?e.jsx("div",{className:"mb-3",children:Array.from({length:y}).map((t,s)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",s+1]}),e.jsx(S,{type:"file",name:`picture-mark-${s+1}`,onChange:r=>{const a=Array.from(r.target.files);if(a.length>0){const c=[...m];a.forEach(p=>{c.push({file:p,description:"",markNumber:s+1})}),N(c);const l=[...f];a.forEach(p=>{l.push(URL.createObjectURL(p))}),D(l)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:m.map((r,a)=>{if(r.markNumber===s+1){const c=f[a];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(L,{src:c,alt:`Preview ${a}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:l=>E(a,l.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(A,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>R(a),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},a)}return null})})]},s))}):e.jsxs(e.Fragment,{children:[e.jsx(S,{type:"file",id:"multiple-file-input",name:"pictures",onChange:ce,accept:"image/*",multiple:!0,ref:k}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:f.map((t,s)=>{var r;return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(L,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:((r=m[s])==null?void 0:r.description)||"",onChange:a=>E(s,a.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(A,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>R(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},s)})})]})})]})}),(n==null?void 0:n.selectedDrawing)&&e.jsxs(o,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(U=(T=n==null?void 0:n.selectedDrawing)==null?void 0:T.mainDrawings)==null?void 0:U.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=t.original;C({show:!0,pdfFile:`${w}/uploads/${t.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`main-${s}`))})]}),(g==null?void 0:g.show)&&e.jsx(fe,{pdfUrl:g.pdfFile,onClose:()=>C({show:!1,pdfFile:null}),onSave:(t,s)=>{ae(s),se(r=>({...r,[g.name]:t})),C({show:!1,pdfFile:null})}}),(n==null?void 0:n.selectedDrawing)&&e.jsxs(o,{lg:"12",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(z=(O=n==null?void 0:n.selectedDrawing)==null?void 0:O.childDrawings)==null?void 0:z.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`child-${s}`))})]}),(v==null?void 0:v.show)&&e.jsx(o,{lg:"6",children:e.jsx(d,{children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(ge,{ref:H,drawDotsOnImage:v,setDrawDotsAnImage:J,onSave:t=>{V(t)},setMarkers:Y,markers:X,dotSize:Z,setDotSize:ee})})})}),e.jsx(d,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(A,{disabled:W,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{He as default};
