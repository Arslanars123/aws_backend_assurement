import{r as i,a as se,b as te,j as e,R as l,C as o}from"./index-BMHGnWcK.js";import{C as ae}from"./ComponentContainerCard-DqzcDgtW.js";import{P as re}from"./PageMetaData-Bgn24qMg.js";import{B as p}from"./urls-CvG9cD6N.js";import{F as u}from"./FormLabel-BBJljh0R.js";import{F as h}from"./FormControl-BhCdWsRE.js";import{F as oe}from"./FormSelect-Dr1VIvZ_.js";import{A as $,C as O,T as W}from"./TextField-CiuEKT8f.js";import{I as ne}from"./Image-BWlBzfxc.js";import{B as N}from"./Button-Dwvyfso6.js";import"./Card-BQIi55Il.js";import"./divWithClassName-BnTSImTn.js";import"./FormContext-_pJuLZf_.js";import"./useFormControl-78CrNPlx.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const le={username:"",role:"Worker",phone:"",startDate:"",name:"",address:"",postalCode:"",city:"",isProjectManager:null},ie=()=>{const[r,y]=i.useState(le),[w,P]=i.useState(!1),j=se(),[S,v]=i.useState(null),[k,g]=i.useState(null),b=i.useRef(null),[f,R]=i.useState([]),[F,T]=i.useState([]),[E,A]=i.useState([]),[D,U]=i.useState([]),[C,V]=i.useState(null),[M,L]=i.useState(!1),I=i.useRef(!1),{companyId:m,projectId:d}=te(),x=a=>{const{name:s,value:t}=a.target;y({...r,[s]:t}),s==="username"&&t&&J(t)},J=async a=>{try{const t=await(await fetch(`${p}/check-user-exists?username=${encodeURIComponent(a)}`)).json();if(t.exists&&t.user){const n={name:t.user.name||"",phone:t.user.phone||"",address:t.user.address||"",city:t.user.city||"",postalCode:t.user.postalCode||"",startDate:t.user.startDate||""};if(V(n),L(!0),y(c=>({...c,name:t.user.name||c.name,phone:t.user.phone||c.phone,address:t.user.address||c.address,city:t.user.city||c.city,postalCode:t.user.postalCode||c.postalCode,startDate:t.user.startDate||c.startDate})),t.user.picture){const c=t.user.picture.startsWith("http")?t.user.picture:`${p.replace("/api","")}/uploads/${t.user.picture}`;g(c)}alert(`User with email ${a} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(s){console.error("Error checking user existence:",s)}},_=()=>{if(!M||!C)return!1;const a={name:r.name,phone:r.phone,address:r.address,city:r.city,postalCode:r.postalCode,startDate:r.startDate};return Object.keys(C).some(s=>C[s]!==a[s])},B=a=>{const s=a.target.files[0];if(v(s),s){const t=URL.createObjectURL(s);g(t)}},Y=async a=>{if(a.preventDefault(),_()){if(!window.confirm("Are you sure you want to edit the basic details of the existing user? This will modify the original user's information across all documents."))return;try{const t={name:r.name,phone:r.phone,address:r.address,city:r.city,postalCode:r.postalCode,startDate:r.startDate},n=await fetch(`${p}/update-existing-user`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r.username,updatedData:t})});if(n.ok){const c=await n.json();alert(`User information updated successfully across ${c.totalDocumentsUpdated} documents!`)}else{alert("Failed to update existing user. Please try again.");return}}catch(t){console.error("Error updating existing user:",t),alert("Error updating existing user. Please try again.");return}}for(const[s,t]of Object.entries(r))if(t===""||t===null){alert(`Please fill out the "${s}" field.`);return}P(!0);try{const s=new FormData;Object.keys(r).forEach(n=>{s.append(n,r[n])}),S&&s.append("picture",S),s.append("companyId",m),s.append("projectsId",d),s.append("userProfession",JSON.stringify(F));const t=await fetch(`${p}/store-user`,{method:"POST",body:s});if(t.ok){const n=await t.json();j(`/dashboard/companies/view/${m}`,{state:{success:"Worker added successfully!"}})}else console.error("Error:",t.statusText)}catch(s){console.error("Fetch error:",s)}P(!1)},G=a=>{r[a.target.name]=a.target.value,y({...r})},H=()=>{v(null),g(null),b.current&&(b.current.value="")},z=async()=>{try{const s=await(await fetch(`${p}/get-company-professions?companyId=${m}&projectId=${d}`)).json();if(!(s!=null&&s.length)&&!I.current){if(I.current=!0,d){alert("You did not have any Profession so need to add Profession in a Project"),j(`/dashboard/companies/view/${m}/projects/view/${d}`);return}alert("You did not have any Profession so need to add Profession in a Company"),j(`/dashboard/companies/view/${m}`);return}R(s)}catch(a){console.error("Error fetching professions:",a)}},q=async a=>{try{const s={companyId:m,professionsIds:a,roles:["Worker"]},n=await(await fetch(`${p}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json(),c={companyId:m,professionsIds:a,projectId:d,roles:["Worker"]},Q=await(await fetch(`${p}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})).json(),X=n.filter(Z=>!Q.some(ee=>ee._id===Z._id));A(X)}catch(s){console.error("Error fetching workers:",s)}};i.useEffect(()=>{m&&z()},[m,d]),i.useEffect(()=>{if(f!=null&&f.length&&m&&d){const a=f.map(s=>s._id);q(a)}},[f]);const K=async()=>{try{if(!d)return;const s={userIds:D.map(n=>n._id),projectId:d},t=await fetch(`${p}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(t.ok){const n=await t.json();j(`/dashboard/companies/view/${m}/projects/view/${d}`,{state:{success:"Worker added successfully!"}})}else console.error("Error:",t.statusText)}catch(a){console.log("Error adding worker to project:",a)}};return e.jsxs(e.Fragment,{children:[e.jsx(re,{title:"Add Worker"}),!d&&e.jsx("form",{onSubmit:Y,children:e.jsx(l,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(ae,{title:"Add Worker",children:e.jsxs(l,{children:[e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.username,onChange:x,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.name,onChange:x,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.phone,onChange:x,name:"phone",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.address,onChange:x,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.city,onChange:x,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.postalCode,onChange:x,name:"postalCode",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(o,{sm:"10",children:e.jsx(h,{value:r.startDate,onChange:x,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Is project Manager"}),e.jsx(o,{sm:"10",children:e.jsxs(oe,{value:r.isProjectManager,name:"isProjectManager",onChange:G,children:[e.jsx("option",{defaultValue:"",children:"Select"}),e.jsx("option",{value:"yes",children:"Yes"}),e.jsx("option",{value:"No",children:"No"})]})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Profession"}),e.jsx(o,{sm:"10",children:e.jsx($,{multiple:!0,options:f,getOptionLabel:a=>a.GroupName,value:F,onChange:(a,s)=>{T(s)},renderInput:a=>e.jsx(W,{...a,variant:"outlined",placeholder:"Search and select professions..."}),renderTags:(a,s)=>a.map((t,n)=>e.jsx(O,{label:t.GroupName,...s({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(o,{sm:"10",children:[e.jsx(h,{type:"file",id:"file-input",name:"picture",onChange:B,accept:"image/*",ref:b}),k&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(ne,{src:k,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(N,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:H,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]})]})]})}),e.jsx(l,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(N,{disabled:w,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),d&&e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Worker for this Projects"}),e.jsxs(o,{sm:"10",children:[e.jsx($,{multiple:!0,options:E,getOptionLabel:a=>a.name,value:D,onChange:(a,s)=>{U(s)},renderInput:a=>e.jsx(W,{...a,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(a,s)=>a.map((t,n)=>e.jsx(O,{label:t.name,...s({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(l,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(N,{disabled:w,type:"submit",variant:"primary",className:"me-1",onClick:K,children:"Submit"})})})]})]})]})},ve=i.memo(ie);export{ve as default};
