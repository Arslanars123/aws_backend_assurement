import{r as c,j as n}from"./index-CF9SjLWQ.js";import{M as N}from"./Modal-CQeUVPXG.js";import{F as w}from"./FormRange-C_Mxfksa.js";import{P as W,r as I}from"./PDFButton-CY5rODRi.js";import{F as G}from"./FormLabel-CaO2MFER.js";import{B as R}from"./Button-UcXSk4np.js";async function T(m,e,B){try{console.log("markers",e);let p;if(m instanceof File)p=await m.arrayBuffer();else if(typeof m=="string"){const g=await fetch(m);if(!g.ok)throw new Error("Failed to fetch PDF from URL");p=await g.arrayBuffer()}else throw new Error("Unsupported input type for PDF file");const l=await W.load(p),h=l.getPages();Object.entries(e).forEach(([g,E])=>{const o=Number(g)-1,d=h[o];if(!d)return;const{width:F,height:u}=d.getSize();E.forEach(({xPercent:U,yPercent:y},j)=>{let b=j;Object.entries(e).forEach(([A,C])=>{Number(A)<Number(g)&&(b+=C.length)});const r=U/100*F,v=y/100*u;d.drawCircle({x:r,y:u-v,size:B||5,color:I(1,0,0),borderColor:I(1,1,1),borderWidth:1});const x=Math.max(8,B/2);d.drawText(`${b+1}`,{x:r-x/4,y:u-v-x/4,size:x,color:I(1,1,1)})})});const f=await l.save();return new Blob([f],{type:"application/pdf"})}catch(p){throw console.error("Error generating annotated PDF:",p),p}}const J=c.forwardRef(({backgroundColor:m="red",drawDotsOnPdf:e,setDrawDotsOnPdf:B,onSave:p,markers:l=[],setMarkers:h,dotSize:f,setDotSize:g,onClose:E,readOnly:o=!1},d)=>{const[F,u]=c.useState(null),[U,y]=c.useState(!1),[j,b]=c.useState(null),[r,v]=c.useState(1),[x,A]=c.useState(1),C=c.useRef(),k=c.useRef(),M=Object.values(l).flat().length;c.useEffect(()=>{let t=null;return(async()=>{try{if(y(!0),b(null),e!=null&&e.pdfFile){if(e.pdfFile instanceof File)t=URL.createObjectURL(e.pdfFile),u(t);else if(typeof e.pdfFile=="string")u(e.pdfFile);else if(e.pdfFile instanceof ArrayBuffer||e.pdfFile instanceof Uint8Array){const i=new Blob([e.pdfFile],{type:"application/pdf"});t=URL.createObjectURL(i),u(t)}try{let i;if(e.pdfFile instanceof File?i=await e.pdfFile.arrayBuffer():typeof e.pdfFile=="string"&&(i=await(await fetch(e.pdfFile)).arrayBuffer()),i){const s=await W.load(i);A(s.getPageCount())}}catch(i){console.error("Error getting page count:",i),A(1)}}else u(null)}catch(i){console.error("Error setting up PDF URL:",i),b(`Failed to process PDF file: ${i.message}`)}finally{y(!1)}})(),()=>{t&&URL.revokeObjectURL(t)}},[e==null?void 0:e.pdfFile]);const S=t=>{if(!C.current||o)return;const a=C.current.getBoundingClientRect(),i=t.clientX-a.left,s=t.clientY-a.top,$=i/a.width*100,V=s/a.height*100,Y={xPercent:$,yPercent:V,id:Date.now()+Math.random()};h(H=>{const q=H[r]||[];return{...H,[r]:[...q,Y]}})},X=t=>{o||h(a=>{const i=a[r]||[];return{...a,[r]:i.filter(s=>s.id!==t)}})};c.useImperativeHandle(d,()=>({getAnnotatedPDF:async()=>{try{if(!(e!=null&&e.pdfFile))return{originalPDF:null,annotations:{}};const t=await T(e.pdfFile,l,f);return{originalPDF:e.pdfFile,annotations:l,annotatedPDF:t}}catch(t){return console.error("Error in getAnnotatedPDF:",t),{originalPDF:e==null?void 0:e.pdfFile,annotations:l}}},clearAnnotations:()=>{h({})},exportAnnotations:()=>l,importAnnotations:t=>{h(t)}}));const L=()=>{E&&E(),B({show:!1,pdfFile:null}),u(null),b(null),y(!1)},z=F?`${F}#page=${r}&view=FitV&toolbar=0&navpanes=0&scrollbar=0`:null;return n.jsxs(N,{size:"xl",show:e==null?void 0:e.show,onHide:L,dialogClassName:"modal-90w",backdrop:"static",children:[n.jsx(N.Header,{closeButton:!0,children:n.jsx(N.Title,{children:o?"PDF Viewer":`PDF Viewer with Annotations - ${M} markers`})}),n.jsxs(N.Body,{children:[!o&&n.jsxs("div",{className:"controls mb-3 d-flex align-items-center gap-4 flex-wrap",children:[n.jsxs("div",{className:"d-flex align-items-center gap-2",children:[n.jsx(G,{className:"mb-0",children:"Dot Size:"}),n.jsx(w,{min:3,max:20,value:f,onChange:t=>g(Number(t.target.value)),style:{width:"100px"}}),n.jsxs("span",{className:"text-muted",children:[f,"px"]})]}),n.jsx(R,{variant:"outline-danger",size:"sm",onClick:()=>h(t=>{const a={...t};return a[r]=[],a}),disabled:!l[r]||l[r].length===0,children:"Clear All Markers"}),n.jsx(R,{variant:"outline-primary",size:"sm",onClick:()=>v(t=>Math.max(t-1,1)),disabled:r<=1,children:"⬅️ Previous Page"}),n.jsxs("span",{className:"fw-bold",children:["Page ",r," of ",x]}),n.jsx(R,{variant:"outline-primary",size:"sm",onClick:()=>v(t=>Math.min(t+1,x)),disabled:r>=x,children:"Next Page ➡️"})]}),U&&n.jsx("div",{className:"text-center p-4",children:n.jsx("div",{className:"spinner-border",role:"status",children:n.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),j&&n.jsxs("div",{className:"alert alert-danger",children:[n.jsx("h6",{children:"Error:"}),n.jsx("p",{children:j})]}),F&&n.jsxs("div",{ref:C,className:"pdf-container position-relative",style:{height:"calc(80vh)",width:"100%",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center"},onClick:o?void 0:S,children:[n.jsx("iframe",{ref:k,src:z,style:{width:"100%",height:"100%",border:"1px solid #ddd",borderRadius:"4px",pointerEvents:o?null:"none"},title:"PDF Viewer"},z),(l[r]||[]).map((t,a)=>{let i=a;return Object.entries(l).forEach(([s,$])=>{Number(s)<r&&(i+=$.length)}),n.jsx("div",{onClick:s=>{o||(s.stopPropagation(),X(t.id))},style:{position:"absolute",top:`${t.yPercent}%`,left:`${t.xPercent}%`,width:`${f}px`,height:`${f}px`,backgroundColor:m,borderRadius:"50%",transform:"translate(-50%, -50%)",cursor:o?"default":"pointer",border:"2px solid #fff",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},title:o?`Marker ${i+1}`:"Click to remove marker",children:n.jsx("span",{style:{color:"#fff",fontSize:`${Math.max(8,f/2)}px`,fontWeight:"bold"},children:i+1})},t.id)})]})]}),n.jsxs(N.Footer,{children:[n.jsx(R,{variant:"secondary",onClick:L,children:o?"Close":"Cancel"}),!o&&n.jsxs(R,{variant:"primary",disabled:!F||U||j||M===0,onClick:async()=>{try{if(e!=null&&e.pdfFile){const t=await T(e.pdfFile,l,f);p&&(p(t),console.log("Annotated PDF saved successfully"))}L()}catch(t){console.error("Error saving annotated PDF:",t),alert("Failed to save annotated PDF. Please try again.")}},children:["Save Annotations ",M]})]})]})});J.displayName="PDFAnnotator";export{J as P};
