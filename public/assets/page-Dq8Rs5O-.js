import{r as l,a as he,b as ge,j as e,R as p,C as i}from"./index-BaEXYFjf.js";import{C as fe}from"./ComponentContainerCard-r7D-7GT6.js";import{P as xe}from"./PageMetaData-PSLyQQbJ.js";import{B as f}from"./urls-D3INM0xz.js";import{P as je}from"./page-CcsRXqEW.js";import{F as m}from"./FormLabel-BbxHmEpm.js";import{F as be}from"./FormSelect-Bf0Zl-q8.js";import{A as v,C as N,T as u}from"./TextField-UgdUJxiT.js";import{B as k}from"./Button-CHKoWH3g.js";import{I as L}from"./Image-CFc3DKY_.js";import{F as we}from"./FormControl-ZQh5JFHF.js";import"./Card-Dy9P-MVM.js";import"./divWithClassName-C80pLmVh.js";import"./Modal-BD-tspKu.js";import"./useWindow-CC4Mdgns.js";import"./useEventCallback-BlKFiCyd.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-BzGmN_3P.js";import"./FormRange-CU4CgP6g.js";import"./FormContext-kuoxlIs5.js";import"./PDFButton-DhybE3n4.js";import"./Alert-vRwrpzVa.js";import"./hook-D-pj7GmZ.js";import"./Anchor-BXsaooFn.js";import"./useFormControl-ct2n4dLn.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const ve={item:null,selectedDrawing:null,projectUsers:null,projectManager:null,comment:null,profession:null,buildingPart:null,selectedWorkers:null},Ze=()=>{var R,U;const[a,h]=l.useState(ve),[T,A]=l.useState(!1),[z,B]=l.useState([]),[_,J]=l.useState([]),G=he(),{companyId:x,projectId:j}=ge(),[b,S]=l.useState([]),[P,$]=l.useState([]),[w,C]=l.useState([]),[D,F]=l.useState([]),[q,V]=l.useState([]),E=l.useRef(null),[g,M]=l.useState({show:!1,pdfFile:null,name:null}),[W,H]=l.useState({}),[K,Q]=l.useState({}),[I,X]=l.useState(0),[Ne,ye]=l.useState({}),[Pe,ke]=l.useState(10),[Y,Z]=l.useState([]),[ee,se]=l.useState([]),[te,ne]=l.useState([]),ae=async()=>{try{const t=await(await fetch(`${f}/get-company-professions?companyId=${x}&projectId=${j}`)).json();Z(t)}catch(s){console.error("Error fetching professions:",s)}},re=async()=>{var s;try{const t=`${f}/get-parts?SubjectMatterId=${(s=a==null?void 0:a.profession)==null?void 0:s.SubjectMatterId}`,n=await(await fetch(t)).json();se(n)}catch(t){console.log(t)}},oe=async()=>{try{const s={companyId:x,projectId:j,professionsIds:a!=null&&a.profession?[a.profession._id]:[],roles:["Worker"]},r=await(await fetch(`${f}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();ne(r)}catch(s){console.error("Error fetching workers:",s)}};l.useEffect(()=>{const s=async()=>{try{const o=await(await fetch(`${f}/get-draws?companyId=${x}&projectId=${j}`)).json();B(o)}catch(n){console.error("Error fetching workers:",n)}},t=async()=>{try{const n=`${f}/get-filter-users`,d=await(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:x,projectId:j})})).json();J(d)}catch(n){console.error("Error fetching users:",n)}};(async()=>{try{const n=`${f}/get-project-managers?companyId=${x}&projectId=${j}`,c=await(await fetch(n)).json();V(c)}catch(n){console.error("Error fetching project managers:",n)}})(),t(),s(),ae()},[]),l.useEffect(()=>{a.profession&&(re(),oe())},[a.profession]);const ie=ee,le=te,ce=s=>{const t=Array.from(s.target.files),r=t.map(c=>({file:c,description:""})),n=[...b,...r],o=[...P,...t.map(c=>URL.createObjectURL(c))];S(n),$(o)},de=s=>{const t=b.filter((n,o)=>o!==s),r=P.filter((n,o)=>o!==s);S(t),$(r)},pe=s=>{const{name:t,value:r}=s.target;h({...a,[t]:r})},me=(s,t)=>{const r=[...b];r[s].description=t,S(r)},ue=async s=>{s.preventDefault(),A(!0);try{const t=new FormData;t.append("companyId",x),t.append("projectsId",j),t.append("comment",a.comment),t.append("item",a.item),t.append("projectUsers",JSON.stringify(a.projectUsers)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("drawing",JSON.stringify(a.selectedDrawing)),t.append("profession",JSON.stringify(a.profession)),t.append("buildingPart",JSON.stringify(a.buildingPart)),t.append("selectedWorkers",JSON.stringify(a.selectedWorkers)),b.length>0&&b.forEach((n,o)=>{n.file&&(t.append("pictures",n.file),t.append("pictureDescriptions",n.description||""),t.append("pictureCreatedDates",new Date().toISOString()))}),w.length>0&&w.forEach((n,o)=>{var c;n.file&&(t.append("markPictures",n.file),t.append("markPictureDescriptions",n.description||""),t.append("markPictureCreatedDates",new Date().toISOString()),t.append("markNumbers",((c=n.markNumber)==null?void 0:c.toString())||""))}),Object.entries(W).forEach(([n,o])=>{const y=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",o,y)}),Object.entries(K).forEach(([n,o])=>{if(o){const y=`${n.replace(/[^-\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}_annotated.png`;t.append("annotatedPdfImages",o,y)}});const r=await fetch(`${f}/store-note`,{method:"POST",body:t});r.ok?G(`/dashboard/companies/view/${x}/projects/view/${j}`):console.error("Error:",r.statusText)}catch(t){console.error("Fetch error:",t)}A(!1)};return console.log("annotatedImages",W),e.jsxs(e.Fragment,{children:[e.jsx(xe,{title:"Add Address Note"}),e.jsx("form",{onSubmit:ue,children:e.jsx(p,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(fe,{title:"Add Address Note",children:e.jsxs(p,{children:[e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(i,{sm:"10",children:e.jsxs(be,{value:a.item,name:"item",onChange:pe,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"The work does not follow the schedule.",children:"The work does not follow the schedule."}),e.jsx("option",{value:"The work is not completed.",children:"The work is not completed."}),e.jsx("option",{value:"The relationship causes delays",children:"The relationship causes delays"}),e.jsx("option",{value:"The interfaces cannot receive in that state.",children:"The interfaces cannot receive in that state."}),e.jsx("option",{value:"Manpower must be provided here if the schedule is to be adhered to.",children:"Manpower must be provided here if the schedule is to be adhered to."}),e.jsx("option",{value:"Someone has destroyed my work after final inspection.",children:"Someone has destroyed my work after final inspection."}),e.jsx("option",{value:"Conditions that are taken up at the next building meeting",children:"Conditions that are taken up at the next building meeting"}),e.jsx("option",{value:"The work is notified to be stopped in 3 days, due to non-payment. cf. AB18",children:"The work is notified to be stopped in 3 days, due to non-payment. cf. AB18"})]})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Profession"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:Y,getOptionLabel:s=>s.GroupName,value:a==null?void 0:a.profession,onChange:(s,t)=>{h({...a,profession:t,buildingPart:null,selectedWorkers:null})},renderInput:s=>e.jsx(u,{...s,variant:"outlined",placeholder:"Select Profession..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(N,{label:r.GroupName,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Building Part"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:ie,getOptionLabel:s=>String(s.name),value:a==null?void 0:a.buildingPart,onChange:(s,t)=>{h({...a,buildingPart:t,selectedWorkers:null})},renderInput:s=>e.jsx(u,{...s,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(N,{label:String(r.name),...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Select Workers"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!0,options:le,getOptionLabel:s=>s.name,value:(a==null?void 0:a.selectedWorkers)||[],onChange:(s,t)=>{h({...a,selectedWorkers:t})},renderInput:s=>e.jsx(u,{...s,variant:"outlined",placeholder:"Select Workers..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(N,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:q,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{h({...a,projectManager:t})},renderInput:s=>e.jsx(u,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(N,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:_,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectUsers,onChange:(s,t)=>{h({...a,projectUsers:t})},renderInput:s=>e.jsx(u,{...s,variant:"outlined",placeholder:"search and select the receiver ..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(N,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(u,{variant:"outlined",placeholder:"Add some comments...",value:a==null?void 0:a.comment,onChange:s=>{var t;h({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:z,getOptionLabel:s=>s.name?s.name:s.mainDrawings&&s.mainDrawings.length>0&&s.mainDrawings[0].original||"No name available",value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{h({...a,selectedDrawing:t})},renderInput:s=>e.jsx(u,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((r,n)=>{const o=r.name||(r.mainDrawings&&r.mainDrawings.length>0?r.mainDrawings[0].original:"No name available");return e.jsx(N,{label:o,...t({index:n})})}),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(U=(R=a==null?void 0:a.selectedDrawing)==null?void 0:R.mainDrawings)==null?void 0:U.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=s.original;M({show:!0,pdfFile:`${f}/uploads/${s.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),e.jsx(i,{lg:"12",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsx(i,{sm:"10",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-muted mb-3",children:"Upload general pictures for this submission. Each picture can have its own description."}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:ce,ref:E,style:{display:"none"}}),e.jsx(k,{type:"button",variant:"outline-primary",onClick:()=>E.current.click(),className:"mb-3",children:"Upload Pictures"}),P.length>0&&e.jsx("div",{className:"d-flex flex-wrap",children:P.map((s,t)=>{var r;return e.jsxs("div",{className:"me-3 mb-3 position-relative",children:[e.jsx(L,{src:s,alt:`Preview ${t+1}`,style:{width:"100px",height:"100px",objectFit:"cover"}}),e.jsx(k,{type:"button",variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>de(t),children:"×"}),e.jsx(u,{variant:"outlined",placeholder:"Description...",value:((r=b[t])==null?void 0:r.description)||"",onChange:n=>me(t,n.target.value),size:"small",className:"mt-1",fullWidth:!0})]},t)})})]})})]})}),I>0&&e.jsx(i,{lg:"12",children:e.jsxs(p,{className:"mb-3",children:[e.jsxs(m,{className:"col-sm-2 col-form-label text-end",children:["PDF Marked Pictures (",I,")"]}),e.jsx(i,{sm:"10",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-muted mb-3",children:"Upload pictures for each mark you placed on the PDF. Each picture can have its own description."}),Array.from({length:I}).map((s,t)=>e.jsxs("div",{className:"mb-4 p-3 border rounded",children:[e.jsxs("h6",{className:"mb-2",children:["📌 Mark #",t+1," Pictures"]}),e.jsx(we,{type:"file",name:`mark-pictures-${t+1}`,onChange:r=>{const n=Array.from(r.target.files);if(n.length>0){const o=[...w];n.forEach(d=>{o.push({file:d,description:"",markNumber:t+1})}),C(o);const c=[...D];n.forEach(d=>{c.push(URL.createObjectURL(d))}),F(c)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:w.map((r,n)=>{if(r.markNumber===t+1){const o=D[n];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(L,{src:o,alt:`Mark Picture ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(u,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:c=>{const d=[...w];d[n]={...d[n],description:c.target.value},C(d)},fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(k,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>{const c=w.filter((y,O)=>O!==n);C(c);const d=D.filter((y,O)=>O!==n);F(d)},style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},n)}return null})})]},t))]})})]})}),e.jsx(i,{lg:"12",className:"d-flex justify-content-end",children:e.jsx(k,{type:"submit",variant:"primary",disabled:T,children:T?"Submitting...":"Submit"})})]})})})})}),g.show&&e.jsx(je,{pdfUrl:g.pdfFile,onClose:()=>M({show:!1,pdfFile:null,name:null}),onSave:async(s,t,r)=>{if(X(t),H(n=>({...n,[g.name.endsWith(".png")?g.name:`${g.name}.png`]:s})),typeof r=="function"){const n=await r();Q(o=>({...o,[g.name.endsWith(".png")?g.name:`${g.name}.png`]:n}))}M({show:!1,pdfFile:null,name:null})}})]})};export{Ze as default};
