import{r as o,G as Me,a as $e,b as Fe,j as t,R as p,C as c}from"./index-BMHGnWcK.js";import{C as Oe}from"./ComponentContainerCard-DqzcDgtW.js";import{B as h}from"./urls-CvG9cD6N.js";import{P as Ee}from"./page-XNENPzep.js";import{F as D}from"./FormLabel-BBJljh0R.js";import{F}from"./FormControl-BhCdWsRE.js";import{A as N,C as k,T as b}from"./TextField-CiuEKT8f.js";import{I as ie}from"./Image-BWlBzfxc.js";import{B as O}from"./Button-Dwvyfso6.js";import"./Card-BQIi55Il.js";import"./divWithClassName-BnTSImTn.js";import"./Modal-BvTxh5Lm.js";import"./useWindow-X1vIdSxZ.js";import"./useEventCallback-aoYRPbpt.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-Cvueq9hZ.js";import"./FormRange-BUeztKfe.js";import"./FormContext-_pJuLZf_.js";import"./PDFButton-DD11AT0P.js";import"./Alert-BSTIsewH.js";import"./hook-ShtcephR.js";import"./Anchor-BpTvChcP.js";import"./useFormControl-78CrNPlx.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Re={comment:"",selectBuildingParts:null,selectedDrawing:null,selectUser:null,independentController:null};function it(){var L,_,z,W,J,q,G,H,K,Q,V,X,Y,Z,ee,te,se,ne,ae,re;const[a,P]=o.useState(Re),{clickTask:i}=o.useContext(Me),[oe,ce]=o.useState([]),[de,me]=o.useState([]),y=o.useRef(null),[I,M]=o.useState([]),[f,S]=o.useState([]),E=$e(),{companyId:w,projectId:x,taskId:R}=Fe(),[j,v]=o.useState({show:!1,pdfFile:null,name:null}),[pe,A]=o.useState({}),[ue,ge]=o.useState([]),[he,fe]=o.useState([]),[U,xe]=o.useState(0),[u,$]=o.useState({}),[C,T]=o.useState({}),we=e=>{const{name:s,value:n}=e.target;P({...a,[s]:n})},je=async()=>{try{const s=await(await fetch(`${h}/get-draws?companyId=${w}&projectId=${x}`)).json();ce(s)}catch(e){console.error("Error fetching workers:",e)}},B=async()=>{try{const e=`${h}/get-parts?SubjectMatterId=${i==null?void 0:i.SubjectMatterId}`,n=await(await fetch(e)).json();me(n)}catch(e){console.log(e)}},De=async()=>{try{const e=`${h}/get-filter-users`,n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:w,projectId:x,taskId:R,roles:["Sub Contractor","Worker"]})});if(!n.ok)throw new Error("Failed to fetch users");const r=await n.json();ge(r)}catch(e){console.error("Error fetching users:",e)}},Pe=async()=>{try{const s=await(await fetch(`${h}/get-independent-controller?companyId=${w}&projectId=${x}`)).json();fe(s)}catch(e){console.error("Error fetching independent controllers:",e)}};o.useEffect(()=>{if(i){if(P({comment:i.comment||"",selectBuildingParts:i.buildingParts||null,selectedDrawing:i.drawing||null,selectUser:i.user||null,independentController:i.independentController||null}),i.pictures&&i.pictures.length>0){const e=i.pictures.map(n=>`${h}/uploads/${n}`);M(e);const s=i.pictures.map(n=>({file:null,existingFilename:n,description:""}));S(s)}if(i.annotatedPdfs&&i.annotatedPdfs.length>0){const e={};i.annotatedPdfs.forEach(s=>{e[s.originalName]=null}),A(e)}}},[i]),o.useEffect(()=>{w&&x&&(je(),B(),De(),Pe())},[w,x]),o.useEffect(()=>{i&&B()},[i]);const be=e=>{const s=Array.from(e.target.files);if(s.length>0){const n=[...f],r=[...I];s.forEach(l=>{n.push({file:l,description:"",createdDate:new Date().toISOString()}),r.push(URL.createObjectURL(l))}),S(n),M(r)}},ve=e=>{const s=f.filter((l,d)=>d!==e),n=I.filter((l,d)=>d!==e);S(s),M(n);const r=new DataTransfer;s.forEach(l=>{l.file&&r.items.add(l.file)}),y.current&&(y.current.files=r.files)},Ce=(e,s)=>{const n=[...f];n[e].description=s,S(n)},Se=(e,s)=>{const n=Array.from(s.target.files);if(n.length>0){const r=u[e]||[],l=C[e]||[],d=[...r],m=[...l];n.forEach(g=>{d.push({file:g,description:"",createdDate:new Date().toISOString(),markNumber:e}),m.push(URL.createObjectURL(g))}),$({...u,[e]:d}),T({...C,[e]:m})}},Ne=(e,s)=>{const n=u[e]||[],r=C[e]||[],l=n.filter((m,g)=>g!==s),d=r.filter((m,g)=>g!==s);$({...u,[e]:l}),T({...C,[e]:d})},ke=(e,s,n)=>{const l=[...u[e]||[]];l[s].description=n,$({...u,[e]:l})},ye=async()=>{if(!w||!x){E("/dashboard/companies");return}if(!a.selectedDrawing||!a.selectBuildingParts){alert("Please select both a drawing and building part.");return}try{const e=new FormData;e.append("comment",a.comment),e.append("projectId",x),e.append("taskId",R),e.append("buildingParts",JSON.stringify(a.selectBuildingParts)),e.append("drawing",JSON.stringify(a.selectedDrawing)),e.append("user",JSON.stringify(a.selectUser)),e.append("independentController",JSON.stringify(a.independentController)),e.append("submissionCreatedDate",new Date().toISOString()),f.length>0&&f.forEach((n,r)=>{n.file&&(e.append("mainPictures",n.file),e.append("mainPictureDescriptions",n.description||""),e.append("mainPictureCreatedDates",n.createdDate||new Date().toISOString()))}),Object.keys(u).forEach(n=>{u[n].forEach((l,d)=>{l.file&&(e.append("markPictures",l.file),e.append("markPictureDescriptions",l.description||""),e.append("markPictureCreatedDates",l.createdDate||new Date().toISOString()),e.append("markNumbers",n))})}),Object.entries(pe).forEach(([n,r])=>{if(r){const m=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;e.append("annotatedPdfs",r,m)}});const s=await fetch(`${h}/submit-task`,{method:"POST",body:e});if(s.ok)E(`/dashboard/companies/view/${w}/projects/view/${x}`);else{const n=await s.json();alert(`Error: ${n.message||"Failed to update task."}`)}}catch(e){console.error("Submit error:",e),alert("Something went wrong while submitting the task.")}};return t.jsx(p,{className:"justify-content-center",children:t.jsx(c,{children:t.jsx(Oe,{title:"Submit Task",children:t.jsxs(p,{children:[t.jsx(c,{lg:"6",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),t.jsx(c,{sm:"10",children:t.jsx(F,{value:a==null?void 0:a.comment,onChange:we,name:"comment",type:"text",id:"example-text-input"})})]})}),t.jsx(c,{lg:"6",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),t.jsx(c,{sm:"10",children:t.jsx(N,{multiple:!1,options:de,getOptionLabel:e=>e.name,value:a.selectBuildingParts,onChange:(e,s)=>{P({...a,selectBuildingParts:s})},renderInput:e=>t.jsx(b,{...e,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(e,s)=>e.map((n,r)=>t.jsx(k,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(c,{lg:"6",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"select User"}),t.jsx(c,{sm:"10",children:t.jsx(N,{multiple:!1,options:ue,getOptionLabel:e=>e.name,value:a.selectUser,onChange:(e,s)=>{P({...a,selectUser:s})},renderOption:(e,s)=>o.createElement("li",{...e,key:s._id},s.name),renderInput:e=>t.jsx(b,{...e,variant:"outlined",placeholder:"Search and select user for this task..."}),renderTags:(e,s)=>e.map((n,r)=>t.jsx(k,{label:n.name,...s({index:r})},n._id)),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(c,{lg:"6",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Independent Controller"}),t.jsx(c,{sm:"10",children:t.jsx(N,{multiple:!1,options:he,getOptionLabel:e=>e.name,value:a.independentController,onChange:(e,s)=>{P({...a,independentController:s})},renderOption:(e,s)=>o.createElement("li",{...e,key:s._id},s.name),renderInput:e=>t.jsx(b,{...e,variant:"outlined",placeholder:"Search and select independent controller..."}),renderTags:(e,s)=>e?[t.jsx(k,{label:e.name,...s({index:0})},e._id)]:null,sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(c,{lg:"6",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{htmlFor:"main-pictures-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),t.jsxs(c,{sm:"10",children:[t.jsx(F,{type:"file",id:"main-pictures-input",name:"mainPictures",onChange:be,accept:"image/*",multiple:!0,ref:y}),t.jsx("div",{className:"mt-3 d-flex flex-wrap",children:I.map((e,s)=>{var n,r;return t.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[t.jsx(ie,{src:e,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),t.jsx(b,{variant:"outlined",placeholder:"Add description...",value:((n=f[s])==null?void 0:n.description)||"",onChange:l=>Ce(s,l.target.value),fullWidth:!0,size:"small",className:"mt-1"}),t.jsxs("small",{className:"text-muted",children:["Created: ",(r=f[s])!=null&&r.createdDate?new Date(f[s].createdDate).toLocaleString():"Now"]}),t.jsx(O,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ve(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s)})})]})]})}),U>0&&t.jsx(c,{lg:"12",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{className:"col-sm-2 col-form-label text-end",children:"Mark Pictures"}),t.jsx(c,{sm:"10",children:t.jsx("div",{className:"mb-3",children:Array.from({length:U}).map((e,s)=>{const n=s+1,r=u[n]||[],l=C[n]||[];return t.jsxs("div",{className:"mb-4 p-3 border rounded",children:[t.jsxs("h6",{className:"mb-2",children:["Upload pictures for mark #",n]}),t.jsx(F,{type:"file",name:`picture-mark-${n}`,onChange:d=>Se(n,d),accept:"image/*",multiple:!0}),t.jsx("div",{className:"mt-3 d-flex flex-wrap",children:l.map((d,m)=>{var g,le;return t.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[t.jsx(ie,{src:d,alt:`Mark ${n} Preview ${m}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),t.jsx(b,{variant:"outlined",placeholder:"Add description...",value:((g=r[m])==null?void 0:g.description)||"",onChange:Ie=>ke(n,m,Ie.target.value),fullWidth:!0,size:"small",className:"mt-1"}),t.jsxs("small",{className:"text-muted",children:["Created: ",(le=r[m])!=null&&le.createdDate?new Date(r[m].createdDate).toLocaleString():"Now"]}),t.jsx(O,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>Ne(n,m),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},m)})})]},s)})})})]})}),t.jsx(c,{lg:"6",children:t.jsxs(p,{className:"mb-3",children:[t.jsx(D,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),t.jsx(c,{sm:"10",children:t.jsx(N,{multiple:!1,options:oe,getOptionLabel:e=>e.name,value:a==null?void 0:a.selectedDrawing,onChange:(e,s)=>{console.log("Selected drawing:",s),P({...a,selectedDrawing:s})},renderInput:e=>t.jsx(b,{...e,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(e,s)=>e.map((n,r)=>t.jsx(k,{label:n.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&t.jsxs(c,{lg:"12",className:"mb-4",children:[t.jsx("h5",{children:"Main Drawings"}),t.jsxs("div",{className:"d-flex flex-wrap",children:[((_=(L=a==null?void 0:a.selectedDrawing)==null?void 0:L.childDrawings)==null?void 0:_.length)>0&&((W=(z=a==null?void 0:a.selectedDrawing)==null?void 0:z.childDrawings)==null?void 0:W.map((e,s)=>t.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=e.original;v({show:!0,pdfFile:`${h}/uploads/${e.stored}`,name:n})},style:{cursor:"pointer"},children:[t.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),t.jsx("div",{className:"small text-muted",children:e==null?void 0:e.original})]},`child-${s}`))),((q=(J=a==null?void 0:a.selectedDrawing)==null?void 0:J.mainDrawings)==null?void 0:q.length)>0&&((H=(G=a==null?void 0:a.selectedDrawing)==null?void 0:G.mainDrawings)==null?void 0:H.map((e,s)=>t.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=e.original||e.filename;v({show:!0,pdfFile:`${h}/uploads/${e.stored||e.filename}`,name:n})},style:{cursor:"pointer"},children:[t.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),t.jsx("div",{className:"small text-muted",children:(e==null?void 0:e.original)||(e==null?void 0:e.filename)})]},`main-${s}`))),((K=a==null?void 0:a.selectedDrawing)==null?void 0:K.stored)&&!((V=(Q=a==null?void 0:a.selectedDrawing)==null?void 0:Q.childDrawings)!=null&&V.length)&&!((Y=(X=a==null?void 0:a.selectedDrawing)==null?void 0:X.mainDrawings)!=null&&Y.length)&&t.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const e=a.selectedDrawing.original||a.selectedDrawing.name;v({show:!0,pdfFile:`${h}/uploads/${a.selectedDrawing.stored}`,name:e})},style:{cursor:"pointer"},children:[t.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),t.jsx("div",{className:"small text-muted",children:((Z=a.selectedDrawing)==null?void 0:Z.original)||((ee=a.selectedDrawing)==null?void 0:ee.name)})]}),!((se=(te=a==null?void 0:a.selectedDrawing)==null?void 0:te.childDrawings)!=null&&se.length)&&!((ae=(ne=a==null?void 0:a.selectedDrawing)==null?void 0:ne.mainDrawings)!=null&&ae.length)&&!((re=a==null?void 0:a.selectedDrawing)!=null&&re.stored)&&t.jsx("div",{className:"text-muted",children:t.jsxs("small",{children:["Debug: Drawing structure - ",JSON.stringify(a.selectedDrawing,null,2)]})})]})]}),(j==null?void 0:j.show)&&t.jsx(Ee,{pdfUrl:j.pdfFile,onClose:()=>v({show:!1,pdfFile:null}),onSave:(e,s)=>{xe(s),A(n=>({...n,[j.name.endsWith(".png")?j.name:`${j.name}.png`]:e})),v({show:!1,pdfFile:null})}}),t.jsx(p,{className:"mb-3 d-flex justify-content-center",children:t.jsx(c,{sm:"12",className:"d-flex justify-content-end",children:t.jsx(O,{type:"submit",variant:"primary",className:"me-1",onClick:ye,children:"Submit"})})})]})})})})}export{it as default};
