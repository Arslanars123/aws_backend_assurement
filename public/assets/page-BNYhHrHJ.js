import{r as c,a as re,b as ne,j as e,R as p,C as o}from"./index-DXGzwTDX.js";import{C as ie}from"./ComponentContainerCard-BdqSoKWJ.js";import{P as le}from"./PageMetaData-DqMiWj9r.js";import{B as h}from"./urls-BhGeBsON.js";import{P as oe}from"./page-DEewqJvp.js";import{F as w}from"./FormLabel-MRPFOBK0.js";import{F as ce}from"./FormSelect-BwnGZFNn.js";import{A as D,C as P,T as b}from"./TextField-DD5ZZLTe.js";import{F as O}from"./FormControl-gHzxXlg1.js";import{I as q}from"./Image-DXZMDITT.js";import{B as F}from"./Button-Q8P5klcO.js";import"./Card-BF03U0a9.js";import"./divWithClassName-WthjuUgX.js";import"./page-DRHJaXUb.js";import"./Modal-pNXPnpNb.js";import"./useWindow-D1WaCGvc.js";import"./DataKey-DeFhA7Nw.js";import"./NoopTransition-CDGbDsLX.js";import"./FormRange-B5lnwdc-.js";import"./PDFButton-CA3UgHlN.js";import"./Alert-BIE78wlt.js";import"./Anchor-OB-3XvKs.js";import"./useFormControl-BMCg-VWj.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const de={item:null,selectedDrawing:null,projectUsers:null,projectManager:null},Ue=()=>{var k,I,R,T,U,E;const[n,g]=c.useState(de),[L,$]=c.useState(!1),z=re(),{companyId:x,projectId:j}=ne(),[W,B]=c.useState([]),[_,J]=c.useState([]),[V,H]=c.useState([]),[d,v]=c.useState([]),[f,S]=c.useState([]),C=c.useRef(null),[u,N]=c.useState({show:!1,pdfFile:null,name:null}),[G,K]=c.useState({}),[y,Q]=c.useState(0),X=s=>{const t=Array.from(s.target.files),a=t.map(i=>({file:i,description:""})),r=[...d,...a],l=[...f,...t.map(i=>URL.createObjectURL(i))];v(r),S(l)},A=s=>{const t=d.filter((l,i)=>i!==s),a=f.filter((l,i)=>i!==s);v(t),S(a);const r=new DataTransfer;t.forEach(l=>r.items.add(l.file)),C.current&&(C.current.files=r.files)},M=(s,t)=>{const a=[...d];a[s].description=t,v(a)},Y=s=>{const{name:t,value:a,multiple:r,options:l}=s.target;if(r){const i=Array.from(l).filter(m=>m.selected).map(m=>m.value);g({...n,[t]:i})}else g({...n,[t]:a})},Z=async()=>{try{const s=`${h}/get-project-managers?companyId=${x}&projectId=${j}`,a=await(await fetch(s)).json();B(a)}catch(s){console.error("Error fetching project managers:",s)}},ee=async()=>{try{const t=await(await fetch(`${h}/get-draws?companyId=${x}&projectId=${j}`)).json();H(t)}catch(s){console.error("Error fetching workers:",s)}},se=async()=>{try{const s=`${h}/get-filter-users`,r=await(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:x,projectId:j})})).json();J(r)}catch(s){console.error("Error fetching users:",s)}};c.useEffect(()=>{Z(),se(),ee()},[]);const te=async s=>{s.preventDefault(),$(!0);try{const t=new FormData;t.append("companyId",x),t.append("projectsId",j),t.append("item",n.item),t.append("projectUsers",JSON.stringify(n.projectUsers)),t.append("projectManager",JSON.stringify(n.projectManager)),t.append("drawing",JSON.stringify(n.selectedDrawing)),d.length>0&&d.forEach((r,l)=>{t.append("pictures",r.file);const i=r.markNumber?`Mark #${r.markNumber}: ${r.description||""}`:r.description||"";t.append("pictureDescriptions",i)}),Object.entries(G).forEach(([r,l])=>{const ae=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",l,ae)});const a=await fetch(`${h}/store-request`,{method:"POST",body:t});if(a.ok){const r=await a.json();z(`/dashboard/companies/view/${x}/projects/view/${j}`)}else console.error("Error:",a.statusText)}catch(t){console.error("Fetch error:",t)}$(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(le,{title:"Add Technical Request"}),e.jsx("form",{onSubmit:te,children:e.jsx(p,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(ie,{title:"Add Technical Request",children:e.jsxs(p,{children:[e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(w,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(o,{sm:"10",children:e.jsxs(ce,{value:n.item,name:"item",onChange:Y,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Does not include project material.",children:"Does not include project material."}),e.jsx("option",{value:"Meeting at the construction site is required.",children:"Meeting at the construction site is required."}),e.jsx("option",{value:"There is no preparation as told.",children:"There is no preparation as told."}),e.jsx("option",{value:"A new instruction is requested here, as it is not possible",children:"A new instruction is requested here, as it is not possible"})]})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(w,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(o,{sm:"10",children:e.jsx(D,{multiple:!1,options:W,getOptionLabel:s=>s.name,value:n==null?void 0:n.projectManager,onChange:(s,t)=>{g({...n,projectManager:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(w,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(o,{sm:"10",children:e.jsx(D,{multiple:!1,options:_,getOptionLabel:s=>s.name,value:n==null?void 0:n.projectUsers,onChange:(s,t)=>{g({...n,projectUsers:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and project Users drawing..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(w,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(D,{multiple:!1,options:V,getOptionLabel:s=>s.name,value:n==null?void 0:n.selectedDrawing,onChange:(s,t)=>{g({...n,selectedDrawing:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(n==null?void 0:n.selectedDrawing)&&e.jsxs(o,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(I=(k=n==null?void 0:n.selectedDrawing)==null?void 0:k.mainDrawings)==null?void 0:I.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=s.original;N({show:!0,pdfFile:`${h}/uploads/${s.stored}`,name:a})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(u==null?void 0:u.show)&&e.jsx(oe,{pdfUrl:u.pdfFile,onClose:()=>N({show:!1,pdfFile:null}),onSave:(s,t)=>{Q(t),K(a=>({...a,[u.name.endsWith(".png")?u.name:`${u.name}.png`]:s})),N({show:!1,pdfFile:null})}}),(n==null?void 0:n.selectedDrawing)&&((T=(R=n==null?void 0:n.selectedDrawing)==null?void 0:R.childDrawings)==null?void 0:T.length)>0&&e.jsxs(o,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(E=(U=n==null?void 0:n.selectedDrawing)==null?void 0:U.childDrawings)==null?void 0:E.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=s.original;N({show:!0,pdfFile:`${h}/uploads/${s.stored}`,name:a})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(w,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:y>0?`Pictures (${y} marks)`:"Pictures"}),e.jsx(o,{sm:"10",children:y>0?e.jsx("div",{className:"mb-3",children:Array.from({length:y}).map((s,t)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),e.jsx(O,{type:"file",name:`picture-mark-${t+1}`,onChange:a=>{const r=Array.from(a.target.files);if(r.length>0){const l=[...d];r.forEach(m=>{l.push({file:m,description:"",markNumber:t+1})}),v(l);const i=[...f];r.forEach(m=>{i.push(URL.createObjectURL(m))}),S(i)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:d.map((a,r)=>{if(a.markNumber===t+1){const l=f[r];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(q,{src:l,alt:`Preview ${r}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:a.description,onChange:i=>M(r,i.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(F,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>A(r),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},r)}return null})})]},t))}):e.jsxs(e.Fragment,{children:[e.jsx(O,{type:"file",id:"multiple-file-input",name:"pictures",onChange:X,accept:"image/*",multiple:!0,ref:C}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:f.map((s,t)=>{var a;return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(q,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:((a=d[t])==null?void 0:a.description)||"",onChange:r=>M(t,r.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(F,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>A(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)})})]})})]})}),e.jsx(p,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(F,{disabled:L,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Ue as default};
