import{r as l,G as Z,a as ee,b as te,j as t,R as c,C as o}from"./index-CFC_skDo.js";import{C as se}from"./ComponentContainerCard-BgtLXH2x.js";import{B as d}from"./urls-BhGeBsON.js";import{D as ae}from"./page-D5pKxfhO.js";import{F as g}from"./FormLabel-S5bDb0w7.js";import{F as R}from"./FormControl-CiIjeg_-.js";import{A as y,T as S,C}from"./TextField-IDun-2ph.js";import{I as B}from"./Image-xOOuaExf.js";import{B as O}from"./Button-2F6J7aEx.js";import"./Card-DSVzyJ_p.js";import"./divWithClassName-Dn3DrZ5P.js";import"./Modal-DU8OHNhS.js";import"./useWindow-BqbRBza5.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-DRW2_py_.js";import"./FormRange-CNLHcOIM.js";import"./useSlot-CMJ6u0xq.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-BcofISFZ.js";const re={comment:"",selectBuildingParts:null,selectedDrawing:null,selectUser:null},ne={Process:"yellow",Receive:"purple",Final:"green"};function Pe(){var F,k;const[a,h]=l.useState(re),{clickTask:n}=l.useContext(Z),[E,U]=l.useState([]),[A,T]=l.useState([]),f=l.useRef(null),[j,b]=l.useState([]),[x,w]=l.useState({show:!1,imgUrl:null}),[v,P]=l.useState([]),I=ee(),{companyId:p,projectId:m,taskId:N}=te(),M=l.useRef(),[$,L]=l.useState(null),[_,J]=l.useState([]),[W,z]=l.useState([]),[q,G]=l.useState(10),H=e=>{const{name:s,value:r}=e.target;h({...a,[s]:r})},V=async()=>{try{const s=await(await fetch(`${d}/get-draws?companyId=${p}&projectId=${m}`)).json();U(s)}catch(e){console.error("Error fetching workers:",e)}},D=async()=>{try{const e=`${d}/get-parts?SubjectMatterId=${n==null?void 0:n.SubjectMatterId}`,r=await(await fetch(e)).json();T(r)}catch(e){console.log(e)}},K=async()=>{try{const e=`${d}/get-filter-users`,r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:p,projectId:m,taskId:N,roles:["Sub Contractor","Worker"]})});if(!r.ok)throw new Error("Failed to fetch users");const i=await r.json();J(i)}catch(e){console.error("Error fetching users:",e)}};l.useEffect(()=>{if(n&&(h({comment:n.comment||"",selectBuildingParts:n.buildingParts||null,selectedDrawing:n.drawing||null,selectUser:n.user||null}),n.annotatedImage&&w({show:!0,imgUrl:`${d}/uploads/${n.annotatedImage}`}),n.pictures&&n.pictures.length>0)){const e=n.pictures.map(s=>`${d}/uploads/${s}`);b(e)}},[n]),l.useEffect(()=>{p&&m&&(V(),D(),K())},[p,m]),l.useEffect(()=>{n&&D()},[n]);const Q=e=>{const s=Array.from(e.target.files),r=[...v,...s],i=[...j,...s.map(u=>URL.createObjectURL(u))];P(r),b(i)},X=e=>{const s=v.filter((i,u)=>u!==e),r=j.filter((i,u)=>u!==e);if(P(s),b(r),f.current){const i=new DataTransfer;s.forEach(u=>i.items.add(u)),f.current.files=i.files}},Y=async()=>{if(!p||!m){I("/dashboard/companies");return}if(!a.selectedDrawing||!a.selectBuildingParts){alert("Please select both a drawing and building part.");return}try{const e=new FormData;e.append("comment",a.comment),e.append("projectId",m),e.append("taskId",N),e.append("buildingParts",JSON.stringify(a.selectBuildingParts)),e.append("drawing",JSON.stringify(a.selectedDrawing)),e.append("user",JSON.stringify(a.selectUser)),$&&e.append("annotatedImage",$),v.forEach(r=>{e.append("pictures",r)});const s=await fetch(`${d}/submit-task`,{method:"POST",body:e});if(s.ok)I(`/dashboard/companies/view/${p}/projects/view/${m}`);else{const r=await s.json();alert(`Error: ${r.message||"Failed to update task."}`)}}catch(e){console.error("Submit error:",e),alert("Something went wrong while submitting the task.")}};return t.jsx(c,{className:"justify-content-center",children:t.jsx(o,{children:t.jsx(se,{title:"Submit Task",children:t.jsxs(c,{children:[t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),t.jsx(o,{sm:"10",children:t.jsx(R,{value:a==null?void 0:a.comment,onChange:H,name:"comment",type:"text",id:"example-text-input"})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),t.jsx(o,{sm:"10",children:t.jsx(y,{multiple:!1,options:A,getOptionLabel:e=>e.name,value:a.selectBuildingParts,onChange:(e,s)=>{h({...a,selectBuildingParts:s})},renderInput:e=>t.jsx(S,{...e,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(e,s)=>e.map((r,i)=>t.jsx(C,{label:r.name,...s({index:i})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"select User"}),t.jsx(o,{sm:"10",children:t.jsx(y,{multiple:!1,options:_,getOptionLabel:e=>e.name,value:a.selectUser,onChange:(e,s)=>{h({...a,selectUser:s})},renderOption:(e,s)=>l.createElement("li",{...e,key:s._id},s.name),renderInput:e=>t.jsx(S,{...e,variant:"outlined",placeholder:"Search and select user for this task..."}),renderTags:(e,s)=>e.map((r,i)=>t.jsx(C,{label:r.name,...s({index:i})},r._id)),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),t.jsxs(o,{sm:"10",children:[t.jsx(R,{type:"file",id:"multiple-file-input",name:"pictures",onChange:Q,accept:"image/*",multiple:!0,ref:f}),t.jsx("div",{className:"mt-3 d-flex flex-wrap",children:j.map((e,s)=>t.jsxs("div",{className:"position-relative me-2 mb-2",children:[t.jsx(B,{src:e,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),t.jsx(O,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>X(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s))})]})]})}),t.jsx(o,{lg:"6",children:t.jsxs(c,{className:"mb-3",children:[t.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),t.jsx(o,{sm:"10",children:t.jsx(y,{multiple:!1,options:E,getOptionLabel:e=>e.name,value:a==null?void 0:a.selectedDrawing,onChange:(e,s)=>{h({...a,selectedDrawing:s})},renderInput:e=>t.jsx(S,{...e,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(e,s)=>e.map((r,i)=>t.jsx(C,{label:r.name,...s({index:i})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsx(c,{className:"",children:(k=(F=a==null?void 0:a.selectedDrawing)==null?void 0:F.pictures)==null?void 0:k.map((e,s)=>t.jsx("div",{className:"position-relative me-2 mb-2",children:t.jsx(B,{src:`${d}/uploads/${e}`,onClick:()=>{w({show:!0,imgUrl:`${d}/uploads/${e}`})},alt:`Existing Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}})},`existing-${s}`))})}),(x==null?void 0:x.show)&&t.jsx(o,{lg:"6",children:t.jsx(c,{children:t.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:t.jsx(ae,{ref:M,backgroundColor:ne[n==null?void 0:n.Type],drawDotsOnImage:x,setDrawDotsAnImage:w,onSave:e=>{L(e)},setMarkers:z,markers:W,dotSize:q,setDotSize:G})})})}),t.jsx(c,{className:"mb-3 d-flex justify-content-center",children:t.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:t.jsx(O,{type:"submit",variant:"primary",className:"me-1",onClick:Y,children:"Submit"})})})]})})})})}export{Pe as default};
