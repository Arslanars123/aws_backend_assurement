import{r as o,a as oe,b as ie,j as e,R as l,C as i}from"./index-y2AWh0VN.js";import{C as le}from"./ComponentContainerCard-WVgzLRCL.js";import{P as ce}from"./PageMetaData-C9BjEYqK.js";import{B as d}from"./urls-BhGeBsON.js";import{D as de}from"./page-GkYNIA8m.js";import{P as pe}from"./page-BwoUE6aX.js";import{F as u}from"./FormLabel-B8nDnblu.js";import{F as T}from"./FormControl-BCsmvP-o.js";import{A as v,C as S,T as y}from"./TextField-CHOGXvH3.js";import{I as L}from"./Image-CSkiN27t.js";import{B as U}from"./Button-CUrgqYc1.js";import"./Card-pTEwvOBz.js";import"./divWithClassName-BLHGuKp8.js";import"./Modal-DUmHr7nc.js";import"./useWindow-BUTI6O21.js";import"./DataKey-BZN51oXa.js";import"./NoopTransition-1KXwFEeZ.js";import"./FormRange-CO87Iy6V.js";import"./useFormControl-C5hsiBKt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const me={comment:"",profession:null,selectBuildingParts:null,selectedDrawing:null},Be=({type:W})=>{var O,M;const[a,f]=o.useState(me),[z,P]=o.useState(!1),I=oe(),[N,D]=o.useState([]),[x,J]=o.useState({show:!1,pdfFile:null}),[g,C]=o.useState([]),[j,$]=o.useState([]),[_,G]=o.useState([]),[H,Q]=o.useState([]),[V,Y]=o.useState([]),[h,A]=o.useState({show:!1,imgUrl:null}),[F,R]=o.useState(10),[k,q]=o.useState(null),b=o.useRef(null),{companyId:p,projectId:m}=ie(),K=o.useRef(),X=o.useRef(),[E,ue]=o.useState(null),[B,Z]=o.useState(null),ee=s=>{const{name:t,value:n}=s.target;f({...a,[t]:n})},te=async()=>{var s;try{const t=`${d}/get-parts?SubjectMatterId=${(s=a==null?void 0:a.profession)==null?void 0:s.SubjectMatterId}`,r=await(await fetch(t)).json();Q(r)}catch(t){console.log(t)}};o.useEffect(()=>{a.profession&&te()},[a.profession]),o.useEffect(()=>{const s=async()=>{try{const r=await(await fetch(`${d}/get-company-professions?companyId=${p}&projectId=${m}`)).json();G(r)}catch(n){console.error("Error fetching professions:",n)}},t=async()=>{try{const r=await(await fetch(`${d}/get-draws?companyId=${p}&projectId=${m}`)).json();Y(r)}catch(n){console.error("Error fetching workers:",n)}};s(),t()},[]);const se=s=>{const t=Array.from(s.target.files),n=[...g,...t],r=[...j];t.forEach(c=>{c.type.startsWith("image/")&&r.push(URL.createObjectURL(c))}),C(n),$(r)},ae=s=>{const t=g.filter((c,w)=>w!==s),n=j.filter((c,w)=>w!==s);C(t),$(n);const r=new DataTransfer;t.forEach(c=>r.items.add(c)),b.current&&(b.current.files=r.files)},ne=async s=>{if(s.preventDefault(),!(a!=null&&a.profession)){alert("You must select company, project and profession"),I(`/dashboard/companies/view/${p}/projects/view/${m}`);return}P(!0);try{const t=new FormData;t.append("type",W),t.append("companyId",p),t.append("projectId",m),t.append("comment",a.comment),t.append("profession",JSON.stringify(a.profession)),t.append("buildingParts",JSON.stringify(a.selectBuildingParts)),t.append("drawing",JSON.stringify(a.selectedDrawing)),k&&t.append("annotatedImage",k),E&&t.append("originalPdf",E),B&&t.append("annotatedPdf",B,"marked.pdf"),g.forEach(r=>{t.append("pictures",r)});const n=await fetch(`${d}/store-deviation`,{method:"POST",body:t});if(n.ok)I(`/dashboard/companies/view/${p}/projects/view/${m}`);else{const r=await n.json();alert(`Error: ${r.message||"Failed to update task."}`)}}catch(t){console.error("Fetch error:",t)}P(!1)},re=s=>{Z(s)};return e.jsxs(e.Fragment,{children:[e.jsx(ce,{title:"Add Deviation In Quality Assurance"}),e.jsx("form",{onSubmit:ne,children:e.jsx(l,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(le,{title:"Add Deviation In Quality Assurance",children:e.jsxs(l,{children:[e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(T,{value:a.comment,onChange:ee,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:_,getOptionLabel:s=>s.GroupName,value:a.profession??null,onChange:(s,t)=>{f({...a,profession:t})},renderInput:s=>e.jsx(y,{...s,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(S,{label:n.GroupName,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:H,getOptionLabel:s=>s.name,value:a.selectBuildingParts,onChange:(s,t)=>{f({...a,selectBuildingParts:t})},renderInput:s=>e.jsx(y,{...s,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(S,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(v,{multiple:!1,options:V,getOptionLabel:s=>s.name,value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{f({...a,selectedDrawing:t})},renderInput:s=>e.jsx(y,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(S,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsx(l,{className:"",children:(M=(O=a==null?void 0:a.selectedDrawing)==null?void 0:O.pictures)==null?void 0:M.map((s,t)=>e.jsx("div",{className:"position-relative me-2 mb-2",children:e.jsx(L,{src:`${d}/uploads/${s}`,onClick:()=>{A({show:!0,imgUrl:`${d}/uploads/${s}`})},alt:`Existing Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}})},`existing-${t}`))})}),(h==null?void 0:h.show)&&e.jsx(i,{lg:"6",children:e.jsx(l,{children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(de,{ref:K,drawDotsOnImage:h,setDrawDotsAnImage:A,onSave:s=>{q(s)},setMarkers:D,markers:N,dotSize:F,setDotSize:R})})})}),e.jsx(i,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(u,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(i,{sm:"10",children:[e.jsx(T,{type:"file",id:"multiple-file-input",name:"pictures",onChange:se,accept:"image/*",multiple:!0,ref:b}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:j.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(L,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(U,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ae(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},t))})]})]})}),(x==null?void 0:x.show)&&e.jsx(pe,{ref:X,backgroundColor:"red",drawDotsOnPdf:x,setDrawDotsOnPdf:J,onSave:re,markers:N,setMarkers:D,dotSize:F,setDotSize:R}),e.jsx(l,{className:"mb-3 d-flex justify-content-center",children:e.jsx(i,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(U,{disabled:z,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Be as default};
