import{r as c,a as re,b as ne,j as e,R as d,C as i}from"./index-DXGzwTDX.js";import{C as ie}from"./ComponentContainerCard-BdqSoKWJ.js";import{P as le}from"./PageMetaData-DqMiWj9r.js";import{B as g}from"./urls-BhGeBsON.js";import{P as oe}from"./page-DEewqJvp.js";import{F as x}from"./FormLabel-MRPFOBK0.js";import{F as ce}from"./FormSelect-BwnGZFNn.js";import{A as D,C as P,T as f}from"./TextField-DD5ZZLTe.js";import{F as U}from"./FormControl-gHzxXlg1.js";import{I as L}from"./Image-DXZMDITT.js";import{B as F}from"./Button-Q8P5klcO.js";import"./Card-BF03U0a9.js";import"./divWithClassName-WthjuUgX.js";import"./page-DRHJaXUb.js";import"./Modal-pNXPnpNb.js";import"./useWindow-D1WaCGvc.js";import"./DataKey-DeFhA7Nw.js";import"./NoopTransition-CDGbDsLX.js";import"./FormRange-B5lnwdc-.js";import"./PDFButton-CA3UgHlN.js";import"./Alert-BIE78wlt.js";import"./Anchor-OB-3XvKs.js";import"./useFormControl-BMCg-VWj.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const de={item:null,users:null,selectedDrawing:null,projectManager:null,recipients:null,comment:null},Oe=()=>{var k,I,R,E,O,T;const[a,u]=c.useState(de),[z,M]=c.useState(!1),W=re(),{companyId:j,projectId:h}=ne(),[B,_]=c.useState([]),[m,v]=c.useState([]),[w,S]=c.useState([]),C=c.useRef(null),[J,V]=c.useState([]),[q,H]=c.useState([]),[b,y]=c.useState({show:!1,pdfFile:null,name:null}),[G,K]=c.useState({}),[N,Q]=c.useState(0),X=async()=>{try{const t=await(await fetch(`${g}/get-draws?companyId=${j}&projectId=${h}`)).json();_(t)}catch(s){console.error("Error fetching workers:",s)}},Y=async()=>{try{const s=`${g}/get-project-managers?companyId=${j}&projectId=${h}`,n=await(await fetch(s)).json();V(n)}catch(s){console.error("Error fetching project managers:",s)}},Z=async()=>{try{const s=`${g}/get-filter-users`,r=await(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:j,projectId:h})})).json();H(r)}catch(s){console.error("Error fetching users:",s)}};c.useEffect(()=>{X(),Y(),Z()},[h]);const ee=s=>{const t=Array.from(s.target.files),n=t.map(o=>({file:o,description:""})),r=[...m,...n],l=[...w,...t.map(o=>URL.createObjectURL(o))];v(r),S(l)},A=s=>{const t=m.filter((l,o)=>o!==s),n=w.filter((l,o)=>o!==s);v(t),S(n);const r=new DataTransfer;t.forEach(l=>r.items.add(l.file)),C.current&&(C.current.files=r.files)},$=(s,t)=>{const n=[...m];n[s].description=t,v(n)},se=s=>{const{name:t,value:n,multiple:r,options:l}=s.target;if(r){const o=Array.from(l).filter(p=>p.selected).map(p=>p.value);u({...a,[t]:o})}else u({...a,[t]:n})},te=async s=>{s.preventDefault(),M(!0);try{const t=new FormData;Object.keys(a).forEach(r=>{r==="projectManager"||r==="selectedDrawing"||r==="recipients"||t.append(r,a[r])}),t.append("companyId",j),t.append("projectsId",h),t.append("comment",a.comment),t.append("drawing",JSON.stringify(a.selectedDrawing)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("recipients",JSON.stringify(a.recipients)),m.length>0&&m.forEach((r,l)=>{t.append("pictures",r.file),t.append("pictureDescriptions",r.description||"")}),Object.entries(G).forEach(([r,l])=>{const ae=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",l,ae)});const n=await fetch(`${g}/store-mention`,{method:"POST",body:t});if(n.ok){const r=await n.json();W(`/dashboard/companies/view/${j}/projects/view/${h}`,{state:{success:"Safety Mention added successfully!"}})}else console.error("Error:",n.statusText)}catch(t){console.error("Fetch error:",t)}M(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(le,{title:"Add Safety Mention"}),e.jsx("form",{onSubmit:te,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(ie,{title:"Add Safety Mention",children:e.jsxs(d,{children:[e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(i,{sm:"10",children:e.jsxs(ce,{value:a.item,name:"item",onChange:se,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Work has stopped",children:"Work has stopped"}),e.jsx("option",{value:"Shielding is missing here",children:"Shielding is missing here"}),e.jsx("option",{value:"A safety hazard",children:"A safety hazard"}),e.jsx("option",{value:"Lacks cleanup",children:"Lacks cleanup"}),e.jsx("option",{value:"Security shielding inhibits my work",children:"Security shielding inhibits my work"}),e.jsx("option",{value:"Scaffolding is not done appropriately",children:"Scaffolding is not done appropriately"})]})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(i,{sm:"10",children:e.jsx(D,{multiple:!1,options:q,getOptionLabel:s=>s.name,value:a==null?void 0:a.recipients,onChange:(s,t)=>{u({...a,recipients:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select Project Users..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(P,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(f,{style:{width:"100%"},variant:"outlined",placeholder:"Add some comments...",value:a==null?void 0:a.comment,onChange:s=>{var t;u({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(D,{multiple:!1,options:J,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{u({...a,projectManager:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(P,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(D,{multiple:!1,options:B,getOptionLabel:s=>s.name,value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{u({...a,selectedDrawing:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(P,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:N>0?`Pictures (${N} marks)`:"Pictures"}),e.jsx(i,{sm:"10",children:N>0?e.jsx("div",{className:"mb-3",children:Array.from({length:N}).map((s,t)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),e.jsx(U,{type:"file",name:`picture-mark-${t+1}`,onChange:n=>{const r=Array.from(n.target.files);if(r.length>0){const l=[...m];r.forEach(p=>{l.push({file:p,description:"",markNumber:t+1})}),v(l);const o=[...w];r.forEach(p=>{o.push(URL.createObjectURL(p))}),S(o)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:m.map((n,r)=>{if(n.markNumber===t+1){const l=w[r];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(L,{src:l,alt:`Preview ${r}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(f,{variant:"outlined",placeholder:"Add description...",value:n.description,onChange:o=>$(r,o.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(F,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>A(r),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},r)}return null})})]},t))}):e.jsxs(e.Fragment,{children:[e.jsx(U,{type:"file",id:"multiple-file-input",name:"pictures",onChange:ee,accept:"image/*",multiple:!0,ref:C}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:w.map((s,t)=>{var n;return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(L,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(f,{variant:"outlined",placeholder:"Add description...",value:((n=m[t])==null?void 0:n.description)||"",onChange:r=>$(t,r.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(F,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>A(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)})})]})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(I=(k=a==null?void 0:a.selectedDrawing)==null?void 0:k.mainDrawings)==null?void 0:I.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;y({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(a==null?void 0:a.selectedDrawing)&&((E=(R=a==null?void 0:a.selectedDrawing)==null?void 0:R.childDrawings)==null?void 0:E.length)>0&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(T=(O=a==null?void 0:a.selectedDrawing)==null?void 0:O.childDrawings)==null?void 0:T.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;y({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),(b==null?void 0:b.show)&&e.jsx(oe,{pdfUrl:b.pdfFile,onClose:()=>y({show:!1,pdfFile:null}),onSave:(s,t)=>{Q(t),K(n=>({...n,[b.name]:s})),y({show:!1,pdfFile:null})}}),e.jsx(d,{className:"mb-3 d-flex justify-content-center",children:e.jsx(i,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(F,{disabled:z,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Oe as default};
