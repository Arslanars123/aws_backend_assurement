import{r as l,a as ve,b as ye,j as e,R as d,C as i}from"./index-CAFh8Qe-.js";import{C as Ne}from"./ComponentContainerCard-BHLb5dlU.js";import{P as Pe}from"./PageMetaData-BdrMy3rA.js";import{B as g}from"./urls-D84fNQqS.js";import{P as Se}from"./page-CREzSUSi.js";import{F as p}from"./FormLabel-DJooOqJq.js";import{F as ke}from"./FormSelect-DckZIl1p.js";import{A as w,C as v,T as f}from"./TextField-DXeN24BL.js";import{F as O}from"./FormControl-D6Fi2fvk.js";import{B as P}from"./Button-DUm19Z6r.js";import{I as z}from"./Image-CbaU3Ogc.js";import"./Card-B6ongrnB.js";import"./divWithClassName-Ds10gy6J.js";import"./Modal-CXhHI7_p.js";import"./useWindow-9TrldcIQ.js";import"./useEventCallback-CZjKJ66g.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-Cm1DoMSP.js";import"./FormRange-BHW8Q9KG.js";import"./FormContext-CVQotS7s.js";import"./PDFButton-DgNvtDdV.js";import"./Alert-DEk8m-Z5.js";import"./hook-f2Z_u6VT.js";import"./Anchor-Dqz5KG5G.js";import"./useFormControl-BV-vA5Rt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Ce={supplementory:"",time:"",item:null,selectedDrawing:null,projectManager:null,recipients:null,profession:null,buildingPart:null,selectedWorkers:null},cs=()=>{var U,L;const[n,m]=l.useState(Ce),[A,$]=l.useState(!1),[B,_]=l.useState([]),[Ie,De]=l.useState({show:!1,imgUrl:null});l.useRef();const[Me,Oe]=l.useState(null),[J,G]=l.useState([]),[V,q]=l.useState([]),[Ae,$e]=l.useState([]),[Fe,Ee]=l.useState(10),[u,S]=l.useState({show:!1,pdfFile:null,name:null}),[F,H]=l.useState({}),[K,Q]=l.useState({}),[k,X]=l.useState(0),[j,C]=l.useState([]),[N,E]=l.useState([]),[b,I]=l.useState([]),[D,W]=l.useState([]),R=l.useRef(null),[Y,Z]=l.useState([]),[ee,se]=l.useState([]),[te,ne]=l.useState([]),ae=ve(),{companyId:x,projectId:h}=ye(),T=s=>{const{name:t,value:a}=s.target;m({...n,[t]:a})},re=async()=>{try{const t=await(await fetch(`${g}/get-company-professions?companyId=${x}&projectId=${h}`)).json();Z(t)}catch(s){console.error("Error fetching professions:",s)}},oe=async()=>{var s;try{const t=`${g}/get-parts?SubjectMatterId=${(s=n==null?void 0:n.profession)==null?void 0:s.SubjectMatterId}`,r=await(await fetch(t)).json();se(r)}catch(t){console.log(t)}},ie=async()=>{try{const s={companyId:x,projectId:h,professionsIds:n!=null&&n.profession?[n.profession._id]:[],roles:["Worker"]},a=await(await fetch(`${g}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();ne(a)}catch(s){console.error("Error fetching workers:",s)}};l.useEffect(()=>{de(),me(),ue(),re()},[h]),l.useEffect(()=>{n.profession&&(oe(),ie())},[n.profession]);const le=ee,ce=te,de=async()=>{try{const t=await(await fetch(`${g}/get-draws?companyId=${x}&projectId=${h}`)).json();_(t)}catch(s){console.error("Error fetching workers:",s)}},pe=s=>{const{name:t,value:a,multiple:r,options:o}=s.target;if(r){const c=Array.from(o).filter(y=>y.selected).map(y=>y.value);m({...n,[t]:c})}else m({...n,[t]:a})},me=async()=>{try{const s=`${g}/get-project-managers?companyId=${x}&projectId=${h}`,a=await(await fetch(s)).json();G(a)}catch(s){console.error("Error fetching project managers:",s)}},ue=async()=>{try{const s=`${g}/get-filter-users`,r=await(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:x,projectId:h})})).json();q(r)}catch(s){console.error("Error fetching users:",s)}},he=s=>{const t=Array.from(s.target.files),a=t.map(c=>({file:c,description:""})),r=[...j,...a],o=[...N,...t.map(c=>URL.createObjectURL(c))];C(r),E(o)},ge=s=>{const t=j.filter((r,o)=>o!==s),a=N.filter((r,o)=>o!==s);C(t),E(a)},fe=(s,t)=>{const a=[...j];a[s].description=t,C(a)},xe=(s,t)=>{const a=Array.from(s.target.files);if(a.length>0){const r=[...b];a.forEach(c=>{r.push({file:c,description:"",markNumber:t})}),I(r);const o=[...D];a.forEach(c=>{o.push(URL.createObjectURL(c))}),W(o)}},je=s=>{const t=b.filter((r,o)=>o!==s);I(t);const a=D.filter((r,o)=>o!==s);W(a)},be=(s,t)=>{const a=[...b];a[s].description=t,I(a)},we=async s=>{s.preventDefault(),$(!0);try{const t=new FormData;t.append("companyId",x),t.append("projectsId",h),t.append("supplementory",n.supplementory),t.append("time",n.time),t.append("item",n.item),t.append("projectManager",JSON.stringify(n.projectManager)),t.append("recipients",JSON.stringify(n.recipients)),t.append("drawing",JSON.stringify(n.selectedDrawing)),t.append("profession",JSON.stringify(n.profession)),t.append("buildingPart",JSON.stringify(n.buildingPart)),t.append("selectedWorkers",JSON.stringify(n.selectedWorkers)),j.length>0&&j.forEach((r,o)=>{r.file&&(t.append("pictures",r.file),t.append("pictureDescriptions",r.description||""),t.append("pictureCreatedDates",new Date().toISOString()))}),b.length>0&&b.forEach((r,o)=>{var c;r.file&&(t.append("markPictures",r.file),t.append("markPictureDescriptions",r.description||""),t.append("markPictureCreatedDates",new Date().toISOString()),t.append("markNumbers",((c=r.markNumber)==null?void 0:c.toString())||""))}),Object.entries(F).forEach(([r,o])=>{const M=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",o,M)}),Object.entries(K).forEach(([r,o])=>{if(o){const M=`${r.replace(/[^-\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}_annotated.png`;t.append("annotatedPdfImages",o,M)}});const a=await fetch(`${g}/store-new`,{method:"POST",body:t});a.ok?ae(`/dashboard/companies/view/${x}/projects/view/${h}`):console.error("Error:",a.statusText)}catch(t){console.error("Fetch error:",t)}$(!1)};return console.log("annotatedImages",F),e.jsxs(e.Fragment,{children:[e.jsx(Pe,{title:"Add New Agreement"}),e.jsx("form",{onSubmit:we,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(Ne,{title:"Add New Agreement",children:e.jsxs(d,{children:[e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Item"}),e.jsx(i,{sm:"10",children:e.jsxs(ke,{value:n.item,name:"item",onChange:pe,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Change work has been notified.",children:"Change work has been notified."}),e.jsx("option",{value:"Interface issue",children:"Interface issue"}),e.jsx("option",{value:"Design change",children:"Design change"}),e.jsx("option",{value:"A new agreement has been concluded with construction management today.",children:"A new agreement has been concluded with construction management today."})]})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Profession"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:Y,getOptionLabel:s=>s.GroupName,value:n==null?void 0:n.profession,onChange:(s,t)=>{m({...n,profession:t,buildingPart:null,selectedWorkers:null})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Select Profession..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(v,{label:a.GroupName,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Building Part"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:le,getOptionLabel:s=>String(s.name),value:n==null?void 0:n.buildingPart,onChange:(s,t)=>{m({...n,buildingPart:t,selectedWorkers:null})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(v,{label:String(a.name),...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Select Workers"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!0,options:ce,getOptionLabel:s=>s.name,value:(n==null?void 0:n.selectedWorkers)||[],onChange:(s,t)=>{m({...n,selectedWorkers:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Select Workers..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(v,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Extra Info"}),e.jsx(i,{sm:"10",children:e.jsx(O,{value:n.supplementory,name:"supplementory",onChange:T,type:"text",id:"example-text-input"})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Time"}),e.jsx(i,{sm:"10",children:e.jsx(O,{value:n.time,name:"time",onChange:T,type:"text",id:"example-text-input"})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:J,getOptionLabel:s=>s.name,value:n==null?void 0:n.projectManager,onChange:(s,t)=>{m({...n,projectManager:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(v,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:V,getOptionLabel:s=>s.name,value:n==null?void 0:n.recipients,onChange:(s,t)=>{m({...n,recipients:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"search and select the receiver ..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(v,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:B,getOptionLabel:s=>s.name,value:n==null?void 0:n.selectedDrawing,onChange:(s,t)=>{m({...n,selectedDrawing:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(v,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(n==null?void 0:n.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(L=(U=n==null?void 0:n.selectedDrawing)==null?void 0:U.mainDrawings)==null?void 0:L.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=s.original;S({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:a})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),e.jsx(i,{lg:"12",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(i,{sm:"10",children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:he,ref:R,style:{display:"none"}}),e.jsx(P,{type:"button",variant:"outline-primary",onClick:()=>R.current.click(),className:"mb-3",children:"Upload Pictures"}),N.length>0&&e.jsx("div",{className:"d-flex flex-wrap",children:N.map((s,t)=>{var a;return e.jsxs("div",{className:"me-3 mb-3 position-relative",children:[e.jsx(z,{src:s,alt:`Preview ${t+1}`,style:{width:"100px",height:"100px",objectFit:"cover"}}),e.jsx(P,{type:"button",variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ge(t),children:"Ã—"}),e.jsx(f,{variant:"outlined",placeholder:"Description...",value:((a=j[t])==null?void 0:a.description)||"",onChange:r=>fe(t,r.target.value),size:"small",className:"mt-1",fullWidth:!0})]},t)})})]})]})}),k>0&&e.jsx(i,{lg:"12",children:e.jsxs(d,{className:"mb-3",children:[e.jsxs(p,{className:"col-sm-2 col-form-label text-end",children:["PDF Marked Pictures (",k,")"]}),e.jsx(i,{sm:"10",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-muted mb-3",children:"Upload pictures for each mark you placed on the PDF. Each picture can have its own description."}),Array.from({length:k}).map((s,t)=>e.jsxs("div",{className:"mb-4 p-3 border rounded",children:[e.jsxs("h6",{className:"mb-2",children:["ðŸ“Œ Mark #",t+1," Pictures"]}),e.jsx(O,{type:"file",name:`mark-pictures-${t+1}`,onChange:a=>xe(a,t+1),accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:b.map((a,r)=>{if(a.markNumber===t+1){const o=D[r];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(z,{src:o,alt:`Mark Picture ${r}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(f,{variant:"outlined",placeholder:"Add description...",value:a.description,onChange:c=>be(r,c.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>je(r),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},r)}return null})})]},t))]})})]})}),e.jsx(i,{lg:"12",className:"d-flex justify-content-end",children:e.jsx(P,{type:"submit",variant:"primary",disabled:A,children:A?"Submitting...":"Submit"})})]})})})})}),u.show&&e.jsx(Se,{pdfUrl:u.pdfFile,onClose:()=>S({show:!1,pdfFile:null,name:null}),onSave:async(s,t,a)=>{if(X(t),H(r=>({...r,[u.name.endsWith(".png")?u.name:`${u.name}.png`]:s})),typeof a=="function"){const r=await a();Q(o=>({...o,[u.name.endsWith(".png")?u.name:`${u.name}.png`]:r}))}S({show:!1,pdfFile:null,name:null})}})]})};export{cs as default};
