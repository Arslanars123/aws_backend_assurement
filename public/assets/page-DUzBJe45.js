import{r as c,a as L,b as U,j as e,R as l,C as s}from"./index-DPgj8bsv.js";import{C as _}from"./ComponentContainerCard-DoOo3fSv.js";import{P as B}from"./PageMetaData-BOIE4fT1.js";import{B as f}from"./urls-B0CXljtC.js";import{F as i}from"./FormLabel-DrWgYkuA.js";import{F as u}from"./FormControl-B_1Cr1px.js";import{F as z}from"./FormSelect-BPDON-Nl.js";import{I as H}from"./Image-VbqUsSSH.js";import{B as b}from"./Button-4B-OZ0gB.js";import{A as J,C as q,T as G}from"./TextField-DE-7kN0j.js";import"./Card-uWXaDKgm.js";import"./divWithClassName-CSK1W61z.js";import"./FormContext-D3odgfWO.js";import"./useFormControl-C1C_dqrR.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const K={username:"",role:"Construction Manager",phone:"",case:"",startDate:"",name:"",address:"",postalCode:"",city:"",mainId:null},ue=()=>{const[o,g]=c.useState(K),[C,v]=c.useState(!1),N=L(),[S,F]=c.useState(null),[w,I]=c.useState(null),y=c.useRef(null),[M,k]=c.useState([]),[P,$]=c.useState([]),{companyId:d,projectId:m}=U(),p=t=>{const{name:a,value:n}=t.target;g({...o,[a]:n})},R=t=>{const a=t.target.files[0];if(F(a),a){const n=URL.createObjectURL(a);I(n)}},E=async t=>{t.preventDefault();const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,n=/^[0-9]{8,15}$/;if(!a.test(o.username)){alert("Please enter a valid email address.");return}if(!n.test(o.phone)){alert("Please enter a valid phone number (only digits, 8 to 15 characters).");return}v(!0);try{const r=new FormData;Object.keys(o).forEach(h=>{r.append(h,o[h])}),S&&r.append("picture",S),r.append("companyId",d),r.append("projectsId",m);const x=await fetch(`${f}/store-user`,{method:"POST",body:r});if(x.ok){const h=await x.json();N(`/dashboard/companies/view/${d}`,{state:{success:"Construction Manager added successfully!"}})}else console.error("Error:",x.statusText)}catch(r){console.error("Fetch error:",r)}v(!1)},A=t=>{const{name:a,value:n,multiple:r,options:x}=t.target;if(r){const h=Array.from(x).filter(j=>j.selected).map(j=>j.value);g({...o,[a]:h})}else g({...o,[a]:n})},V=()=>{F(null),I(null),y.current&&(y.current.value="")};c.useEffect(()=>{(async()=>{try{const n=await(await fetch(`${f}/get-mains?companyId=${d}`)).json();D(n)}catch(a){console.error("Error fetching mains:",a)}})()},[]);const[T,D]=c.useState([]);c.useEffect(()=>{d&&m&&O()},[d,m]);const O=async()=>{try{const a=await(await fetch(`${f}/get-cons?companyId=${d}`)).json(),r=await(await fetch(`${f}/get-cons?companyId=${d}&projectId=${m}`)).json(),x=a.filter(h=>!r.some(j=>j._id===h._id));k(x)}catch(t){console.error("Error fetching workers:",t)}},W=async()=>{try{if(!m)return;const a={userIds:P.map(r=>r._id),projectId:m},n=await fetch(`${f}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(n.ok){const r=await n.json();N(`/dashboard/companies/view/${d}/projects/view/${m}`,{state:{success:"Construction Manager added successfully!"}})}else console.error("Error:",n.statusText)}catch(t){console.log("Error adding Construction Manager to project:",t)}};return e.jsxs(e.Fragment,{children:[e.jsx(B,{title:"Add Construction Manager"}),!m&&e.jsx("form",{onSubmit:E,children:e.jsx(l,{className:"justify-content-center",children:e.jsx(s,{children:e.jsx(_,{title:"Add Construction Manager",children:e.jsxs(l,{children:[e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.username,onChange:p,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.name,onChange:p,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.phone,onChange:p,name:"phone",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.address,onChange:p,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.city,onChange:p,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.postalCode,onChange:p,name:"postalCode",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(s,{sm:"10",children:e.jsx(u,{value:o.startDate,onChange:p,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{className:"col-sm-2 col-form-label text-end",children:"Select Main Constructor"}),e.jsx(s,{sm:"10",children:e.jsxs(z,{value:o.mainId,name:"mainId",onChange:A,children:[e.jsx("option",{defaultValue:"",children:"Select Main Constructor"}),T.map(t=>e.jsxs("option",{value:t._id,children:[t.username," "]},t.id))]})})]})}),e.jsx(s,{lg:"6",children:e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(s,{sm:"10",children:[e.jsx(u,{type:"file",id:"file-input",name:"picture",onChange:R,accept:"image/*",ref:y}),w&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(H,{src:w,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(b,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:V,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]})]})]})}),e.jsx(l,{className:"mb-3 d-flex justify-content-center",children:e.jsx(s,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(b,{disabled:C,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),m&&e.jsxs(l,{className:"mb-3",children:[e.jsx(i,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Construction Manager for this Project"}),e.jsxs(s,{sm:"10",children:[e.jsx(J,{multiple:!0,options:M,getOptionLabel:t=>t.name,value:P,onChange:(t,a)=>{$(a)},renderInput:t=>e.jsx(G,{...t,variant:"outlined",placeholder:"Search and select Construction Manager..."}),renderTags:(t,a)=>t.map((n,r)=>e.jsx(q,{label:n.name,...a({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(l,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(s,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(b,{disabled:C,type:"submit",variant:"primary",className:"me-1",onClick:W,children:"Submit"})})})]})]})]})};export{ue as default};
