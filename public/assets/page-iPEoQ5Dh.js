import{r as l,a as ie,b as de,j as e,R as o,C as r}from"./index-CAFh8Qe-.js";import{C as ue}from"./ComponentContainerCard-BHLb5dlU.js";import{P as me}from"./PageMetaData-BdrMy3rA.js";import{B as x}from"./urls-D84fNQqS.js";import{F as d}from"./FormLabel-DJooOqJq.js";import{F as u}from"./FormControl-D6Fi2fvk.js";import{A as U,C as V,T as W}from"./TextField-DXeN24BL.js";import{F as pe}from"./FormSelect-DckZIl1p.js";import{I as L}from"./Image-CbaU3Ogc.js";import{B as g}from"./Button-DUm19Z6r.js";import"./Card-B6ongrnB.js";import"./divWithClassName-Ds10gy6J.js";import"./FormContext-CVQotS7s.js";import"./useFormControl-BV-vA5Rt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const he={username:"",role:"Sub Contractor",phone:"",startDate:"",name:"",address:"",postalCode:"",city:"",isProjectManager:null,cvr:"",contactPerson:"",contactPhone:""},Oe=()=>{const[n,y]=l.useState(he),[N,S]=l.useState(!1),j=ie(),[w,I]=l.useState(null),[R,b]=l.useState(null),P=l.useRef(null),[f,M]=l.useState([]),[D,F]=l.useState([]),[J,_]=l.useState([]),[k,B]=l.useState([]),[O,$]=l.useState(null),[T,E]=l.useState(null),C=l.useRef(null),[v,Y]=l.useState(null),[H,z]=l.useState(!1),A=l.useRef(!1),{companyId:m,projectId:p}=de(),h=a=>{const{name:s,value:t}=a.target;y({...n,[s]:t}),s==="username"&&t&&G(t)},G=async a=>{try{const t=await(await fetch(`${x}/check-user-exists?username=${encodeURIComponent(a)}`)).json();if(t.exists&&t.user){const c={name:t.user.name||"",phone:t.user.phone||"",address:t.user.address||"",city:t.user.city||"",postalCode:t.user.postalCode||"",startDate:t.user.startDate||"",cvr:t.user.cvr||"",contactPerson:t.user.contactPerson||"",contactPhone:t.user.contactPhone||""};if(Y(c),z(!0),y(i=>({...i,name:t.user.name||i.name,phone:t.user.phone||i.phone,address:t.user.address||i.address,city:t.user.city||i.city,postalCode:t.user.postalCode||i.postalCode,startDate:t.user.startDate||i.startDate,cvr:t.user.cvr||i.cvr,contactPerson:t.user.contactPerson||i.contactPerson,contactPhone:t.user.contactPhone||i.contactPhone})),t.user.userProfession&&t.user.userProfession.length>0&&F(t.user.userProfession),t.user.picture){const i=t.user.picture.startsWith("http")?t.user.picture:`${x.replace("/api","")}/uploads/${t.user.picture}`;b(i)}alert(`User with email ${a} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(s){console.error("Error checking user existence:",s)}},q=()=>{if(!H||!v)return!1;const a={name:n.name,phone:n.phone,address:n.address,city:n.city,postalCode:n.postalCode,startDate:n.startDate,cvr:n.cvr,contactPerson:n.contactPerson,contactPhone:n.contactPhone};return Object.keys(v).some(s=>v[s]!==a[s])},K=a=>{const s=a.target.files[0];if(I(s),s){const t=URL.createObjectURL(s);b(t)}},Q=async a=>{if(a.preventDefault(),!m){alert("You must select company"),j("/dashboard/companies");return}if(q()){if(!window.confirm("Are you sure you want to edit the basic details of the existing user? This will modify the original user's information across all documents."))return;try{const t={name:n.name,phone:n.phone,address:n.address,city:n.city,postalCode:n.postalCode,startDate:n.startDate,cvr:n.cvr,contactPerson:n.contactPerson,contactPhone:n.contactPhone},c=await fetch(`${x}/update-existing-user`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:n.username,updatedData:t})});if(c.ok){const i=await c.json();alert(`User information updated successfully across ${i.totalDocumentsUpdated} documents!`)}else{alert("Failed to update existing user. Please try again.");return}}catch(t){console.error("Error updating existing user:",t),alert("Error updating existing user. Please try again.");return}}for(const[s,t]of Object.entries(n))if(t===""||t===null){alert(`Please fill out the "${s}" field.`);return}S(!0);try{const s=new FormData;Object.keys(n).forEach(c=>{s.append(c,n[c])}),w&&s.append("picture",w),O&&s.append("contactPicture",O),s.append("companyId",m),s.append("projectsId",p),s.append("userProfession",JSON.stringify(D));const t=await fetch(`${x}/store-user`,{method:"POST",body:s});if(t.ok){const c=await t.json();j(`/dashboard/companies/view/${m}`,{state:{success:"Sub Contractor added successfully!"}})}else console.error("Error:",t.statusText)}catch(s){console.error("Fetch error:",s)}S(!1)},X=a=>{n[a.target.name]=a.target.value,y({...n})},Z=()=>{I(null),b(null),P.current&&(P.current.value="")},ee=a=>{const s=a.target.files[0];if($(s),s){const t=URL.createObjectURL(s);E(t)}},te=()=>{$(null),E(null),C.current&&(C.current.value="")},se=async()=>{try{const s=await(await fetch(`${x}/get-company-professions?companyId=${m}&projectId=${p}`)).json();if(!(s!=null&&s.length)&&!A.current){A.current=!0,alert("You did not have any Profession so need to add Profession in a Company"),j(`/dashboard/companies/view/${m}`);return}M(s)}catch(a){console.error("Error fetching professions:",a)}};l.useEffect(()=>{se()},[m,p]),l.useEffect(()=>{if(f!=null&&f.length&&m&&p){const a=f.map(s=>s._id);ae(a)}},[f]);const ae=async a=>{try{const s={companyId:m,professionsIds:a,roles:["Sub Contractor"]},c=await(await fetch(`${x}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json(),i={companyId:m,professionsIds:a,projectId:p,roles:["Sub Contractor"]},re=await(await fetch(`${x}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json(),oe=c.filter(ce=>!re.some(le=>le._id===ce._id));_(oe)}catch(s){console.error("Error fetching workers:",s)}},ne=async()=>{try{if(!p)return;const s={userIds:k.map(c=>c._id),projectId:p},t=await fetch(`${x}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(t.ok){const c=await t.json();j(`/dashboard/companies/view/${m}/projects/view/${p}`,{state:{success:"Sub Contractor added successfully!"}})}else console.error("Error:",t.statusText)}catch(a){console.log("Error adding Sub Contractor to project:",a)}};return e.jsxs(e.Fragment,{children:[e.jsx(me,{title:"Add Sub Contractor"}),!p&&e.jsx("form",{onSubmit:Q,children:e.jsx(o,{className:"justify-content-center",children:e.jsx(r,{children:e.jsx(ue,{title:"Add Sub Contractor",children:e.jsxs(o,{children:[e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.username,onChange:h,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.name,onChange:h,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.phone,onChange:h,name:"phone",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.address,onChange:h,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.city,onChange:h,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.postalCode,onChange:h,name:"postalCode",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Profession"}),e.jsx(r,{sm:"10",children:e.jsx(U,{multiple:!0,options:f,getOptionLabel:a=>a.GroupName,value:D,onChange:(a,s)=>{F(s)},renderInput:a=>e.jsx(W,{...a,variant:"outlined",placeholder:"Search and select professions..."}),renderTags:(a,s)=>a.map((t,c)=>e.jsx(V,{label:t.GroupName,...s({index:c})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.startDate,onChange:h,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Is project Manager"}),e.jsx(r,{sm:"10",children:e.jsxs(pe,{value:n.isProjectManager,name:"isProjectManager",onChange:X,children:[e.jsx("option",{defaultValue:"",children:"Select"}),e.jsx("option",{value:"yes",children:"Yes"}),e.jsx("option",{value:"No",children:"No"})]})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"CVR. NR."}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.cvr,onChange:h,name:"cvr",type:"text",id:"cvr-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Contact Person"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.contactPerson,onChange:h,name:"contactPerson",type:"text",id:"contact-person-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Phone (Contact)"}),e.jsx(r,{sm:"10",children:e.jsx(u,{value:n.contactPhone,onChange:h,name:"contactPhone",type:"text",id:"contact-phone-input"})})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(r,{sm:"10",children:[e.jsx(u,{type:"file",id:"file-input",name:"picture",onChange:K,accept:"image/*",ref:P}),R&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(L,{src:R,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(g,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:Z,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]})]})]})}),e.jsx(r,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{className:"col-sm-2 col-form-label text-end",children:"Picture (Contact)"}),e.jsxs(r,{sm:"10",children:[e.jsx(u,{type:"file",id:"contact-picture-input",name:"contactPicture",onChange:ee,accept:"image/*",ref:C}),T&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(L,{src:T,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(g,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:te,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]})]})]})}),e.jsx(o,{className:"mb-3 d-flex justify-content-center",children:e.jsx(r,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(g,{disabled:N,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),p&&e.jsxs(o,{className:"mb-3",children:[e.jsx(d,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Sub Contractor for this Project"}),e.jsxs(r,{sm:"10",children:[e.jsx(U,{multiple:!0,options:J,getOptionLabel:a=>a.name,value:k,onChange:(a,s)=>{B(s)},renderInput:a=>e.jsx(W,{...a,variant:"outlined",placeholder:"Search and select Sub Contractor..."}),renderTags:(a,s)=>a.map((t,c)=>e.jsx(V,{label:t.name,...s({index:c})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(o,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(r,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(g,{disabled:N,type:"submit",variant:"primary",className:"me-1",onClick:ne,children:"Submit"})})})]})]})]})};export{Oe as default};
