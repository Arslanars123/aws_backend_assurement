import{b as J,ab as q,r,j as e,m as $,R as y,C}from"./index-CAFh8Qe-.js";import{B as h}from"./urls-D84fNQqS.js";import{P as K}from"./PageMetaData-BdrMy3rA.js";import{S as Q}from"./index-DLCEbvVs.js";import{C as L,a as B}from"./Card-B6ongrnB.js";import{B as T}from"./Badge-V0dRfUVq.js";import{F as x}from"./FormGroup-C4HhIO73.js";import{F as j}from"./FormLabel-DJooOqJq.js";import{F as N}from"./FormControl-D6Fi2fvk.js";import{B as M}from"./Button-DUm19Z6r.js";import{S as O}from"./Spinner-DyAiQOaj.js";import{A as V}from"./Alert-DEk8m-Z5.js";import"./createSuper-DnhfVoso.js";import"./assertThisInitialized-B9jnkVVz.js";import"./divWithClassName-Ds10gy6J.js";import"./FormContext-CVQotS7s.js";import"./hook-f2Z_u6VT.js";import"./Anchor-Dqz5KG5G.js";import"./useEventCallback-CZjKJ66g.js";const hs=()=>{const{companyId:c,projectId:d}=J(),[z]=q(),m=z.get("subjectMatterId")||"",[f,A]=r.useState({1:null,2:null,3:null}),[o,E]=r.useState({1:{name:"",description:"",profession:"",signature:null},2:{name:"",description:"",profession:"",signature:null},3:{name:"",description:"",profession:"",signature:null}}),[l,U]=r.useState({1:null,2:null,3:null}),[w,_]=r.useState([]),[G,P]=r.useState(!0),[S,D]=r.useState({1:!1,2:!1,3:!1}),[b,g]=r.useState({type:"",text:""}),k=r.useCallback(async()=>{try{const a=await(await fetch(`${h}/get-gammas-professions?companyId=${c}&projectId=${d}`)).json();_(a)}catch(s){console.error("Error loading professions:",s),g({type:"danger",text:"Error loading professions"})}},[c,d]),v=r.useCallback(async()=>{try{const a=await(await fetch(`${h}/get-static-report-signatures`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:c,projectId:d,subjectMatterId:m})})).json(),n={1:null,2:null,3:null};a.forEach(t=>{n[t.signatureType]=t}),A(n);const i={1:{name:"",description:"",profession:"",signature:null},2:{name:"",description:"",profession:"",signature:null},3:{name:"",description:"",profession:"",signature:null}};Object.keys(n).forEach(t=>{const p=n[t];p&&(i[t]={name:p.name||"",description:p.description||"",profession:p.profession||"",signature:p.signature||null})}),E(i)}catch(s){console.error("Error loading signatures:",s),g({type:"danger",text:"Error loading signatures"})}},[c,d,m]);r.useEffect(()=>{c&&d&&(async()=>{P(!0),await Promise.all([k(),v()]),P(!1)})()},[c,d,m,v,k]);const u=r.useCallback((s,a,n)=>{E(i=>({...i,[s]:{...i[s],[a]:n}}))},[]),F=r.useCallback((s,a)=>{U(n=>({...n,[s]:a}))},[]),I=r.useCallback(s=>{l[s]&&(l[s].clear(),u(s,"signature",null))},[l,u]),R=r.useCallback(async s=>{if(!o[s].name||!o[s].profession){g({type:"warning",text:"Please fill in name and profession"});return}D(a=>({...a,[s]:!0}));try{let a=null;l[s]&&!l[s].isEmpty()?a=l[s].toDataURL():o[s].signature&&(a=o[s].signature);const n={companyId:c,projectId:d,subjectMatterId:m,signatureType:parseInt(s),name:o[s].name,description:o[s].description,profession:o[s].profession,signature:a,signatureDate:new Date().toISOString()},i=f[s],t=i?`${h}/update-static-report-signature/${i._id}`:`${h}/create-static-report-signature`;if((await fetch(t,{method:i?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok)g({type:"success",text:`Signature ${s} ${i?"updated":"saved"} successfully`}),await v();else throw new Error("Failed to save signature")}catch(a){console.error("Error saving signature:",a),g({type:"danger",text:"Error saving signature"})}finally{D(a=>({...a,[s]:!1}))}},[o,l,f,c,d,m]),H=r.useCallback(s=>{const a=f[s],n=!!a,i=o[s];return e.jsxs(L,{className:"mb-4",children:[e.jsxs(B,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:["Signature ",s,n&&e.jsx(T,{bg:"success",className:"ms-2",children:"Existing"}),!n&&e.jsx(T,{bg:"primary",className:"ms-2",children:"New"})]}),a&&e.jsxs("small",{className:"text-muted",children:["Last updated: ",new Date(a.updatedAt).toLocaleDateString()]})]}),e.jsxs($,{children:[e.jsxs(y,{children:[e.jsx(C,{md:6,children:e.jsxs(x,{className:"mb-3",children:[e.jsx(j,{children:"Name *"}),e.jsx(N,{type:"text",value:i.name,onChange:t=>u(s,"name",t.target.value),placeholder:"Enter signer name"})]})}),e.jsx(C,{md:6,children:e.jsxs(x,{className:"mb-3",children:[e.jsx(j,{children:"Profession *"}),e.jsxs(N,{as:"select",value:i.profession,onChange:t=>u(s,"profession",t.target.value),children:[e.jsx("option",{value:"",children:"Select Profession"}),w.map(t=>e.jsx("option",{value:t._id,children:t.GroupName},t._id))]})]})})]}),e.jsxs(x,{className:"mb-3",children:[e.jsx(j,{children:"Description"}),e.jsx(N,{as:"textarea",rows:3,value:i.description,onChange:t=>u(s,"description",t.target.value),placeholder:"Enter signature description"})]}),e.jsxs(x,{className:"mb-3",children:[e.jsx(j,{children:"Digital Signature"}),e.jsxs("div",{className:"border rounded p-3",style:{backgroundColor:"#f8f9fa"},children:[e.jsx(Q,{ref:t=>F(s,t),canvasProps:{width:500,height:200,className:"signature-canvas"},onEnd:()=>{l[s]&&!l[s].isEmpty()&&u(s,"signature",l[s].toDataURL())}}),e.jsx("div",{className:"mt-2",children:e.jsx(M,{variant:"outline-secondary",size:"sm",onClick:()=>I(s),children:"Clear Signature"})})]})]}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsxs(M,{variant:n?"warning":"success",onClick:()=>R(s),disabled:S[s],children:[S[s]&&e.jsx(O,{size:"sm",className:"me-2"}),n?"Update Signature":"Save Signature"]})})]})]},s)},[f,o,w,S,u,F,I,R]);return G?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx(O,{animation:"border"})}):e.jsxs(e.Fragment,{children:[e.jsx(K,{title:"Static Report Signatures"}),e.jsx("div",{className:"page-content",children:e.jsx("div",{className:"container-fluid",children:e.jsx(y,{children:e.jsx(C,{children:e.jsxs(L,{children:[e.jsxs(B,{children:[e.jsx("h4",{className:"card-title mb-0",children:"Static Report Signatures"}),e.jsxs("p",{className:"text-muted mb-0",children:["Company: ",c," | Project: ",d," | Subject Matter: ",m||"All"]})]}),e.jsxs($,{children:[b.text&&e.jsx(V,{variant:b.type,dismissible:!0,onClose:()=>g({type:"",text:""}),children:b.text}),[1,2,3].map(s=>H(s))]})]})})})})})]})};export{hs as default};
