import{r as i,a as Y,b as q,j as e,R as c,C as o}from"./index-Ccc50bvq.js";import{C as K}from"./ComponentContainerCard-jOvJBIs5.js";import{P as X}from"./PageMetaData-CwfTEKnL.js";import{B as d}from"./urls-BhGeBsON.js";import{D as Z}from"./page-h5XIzvWu.js";import{F as x}from"./FormLabel-MCMdPdRI.js";import{F as A}from"./FormControl-CO_Uebzp.js";import{A as w,T as v,C as y}from"./TextField-DlT7K7k6.js";import{I as R}from"./Image-JoqgvPfO.js";import{B as k}from"./Button-Czdzc6_d.js";import"./Card-Bd-5a1Ef.js";import"./divWithClassName-B0s-A9qq.js";import"./Modal-p4tRgnEt.js";import"./useWindow-yc1yIKZN.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-ClZX65CP.js";import"./FormRange-DAlMXWTQ.js";import"./useSlot-CggVarzL.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-BcofISFZ.js";const ee={comment:"",profession:null,selectBuildingParts:null,selectedDrawing:null},ve=({type:B})=>{var $,F;const[n,f]=i.useState(ee),[E,S]=i.useState(!1),N=Y(),[O,T]=i.useState([]),[g,I]=i.useState([]),[j,P]=i.useState([]),[L,M]=i.useState([]),[U,J]=i.useState([]),[W,_]=i.useState([]),[h,C]=i.useState({show:!1,imgUrl:null}),[D,G]=i.useState(null),b=i.useRef(null),{companyId:m,projectId:p}=q(),H=t=>{const{name:s,value:r}=t.target;f({...n,[s]:r})};i.useEffect(()=>{const t=async()=>{try{const l=await(await fetch(`${d}/get-company-professions?companyId=${m}&projectId=${p}`)).json();M(l)}catch(a){console.error("Error fetching professions:",a)}},s=async()=>{try{const a=`${d}/get-parts`,u=await(await fetch(a)).json();J(u)}catch(a){console.log(a)}},r=async()=>{try{const l=await(await fetch(`${d}/get-draws?companyId=${m}&projectId=${p}`)).json();_(l)}catch(a){console.error("Error fetching workers:",a)}};s(),t(),r()},[]);const Q=t=>{const s=Array.from(t.target.files),r=[...g,...s],a=[...j,...s.map(l=>URL.createObjectURL(l))];I(r),P(a)},z=t=>{const s=g.filter((l,u)=>u!==t),r=j.filter((l,u)=>u!==t);I(s),P(r);const a=new DataTransfer;s.forEach(l=>a.items.add(l)),b.current&&(b.current.files=a.files)},V=async t=>{if(t.preventDefault(),!(n!=null&&n.profession)){alert("You must select company, project and profession"),N(`/dashboard/companies/view/${m}/projects/view/${p}`);return}S(!0);try{const s=new FormData;s.append("type",B),s.append("companyId",m),s.append("projectId",p),s.append("comment",n.comment),s.append("profession",JSON.stringify(n.profession)),s.append("buildingParts",JSON.stringify(n.selectBuildingParts)),s.append("drawing",JSON.stringify(n.selectedDrawing)),D&&s.append("annotatedImage",D),g.forEach(a=>{s.append("pictures",a)});const r=await fetch(`${d}/store-deviation`,{method:"POST",body:s});if(r.ok)N(`/dashboard/companies/view/${m}/projects/view/${p}`);else{const a=await r.json();alert(`Error: ${a.message||"Failed to update task."}`)}}catch(s){console.error("Fetch error:",s)}S(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(X,{title:"Add Deviation In Quality Assurance"}),e.jsx("form",{onSubmit:V,children:e.jsx(c,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(K,{title:"Add Deviation In Quality Assurance",children:e.jsxs(c,{children:[e.jsx(o,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(o,{sm:"10",children:e.jsx(A,{value:n.comment,onChange:H,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(o,{sm:"10",children:e.jsx(w,{multiple:!1,options:L,getOptionLabel:t=>t.GroupName,value:n.profession??null,onChange:(t,s)=>{f({...n,profession:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(t,s)=>t.map((r,a)=>e.jsx(y,{label:r.GroupName,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),e.jsx(o,{sm:"10",children:e.jsx(w,{multiple:!1,options:U,getOptionLabel:t=>t.name,value:n.selectBuildingParts,onChange:(t,s)=>{f({...n,selectBuildingParts:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(t,s)=>t.map((r,a)=>e.jsx(y,{label:r.name,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(w,{multiple:!1,options:W,getOptionLabel:t=>t.name,value:n==null?void 0:n.selectedDrawing,onChange:(t,s)=>{f({...n,selectedDrawing:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t.map((r,a)=>e.jsx(y,{label:r.name,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsx(c,{className:"",children:(F=($=n==null?void 0:n.selectedDrawing)==null?void 0:$.pictures)==null?void 0:F.map((t,s)=>e.jsx("div",{className:"position-relative me-2 mb-2",children:e.jsx(R,{src:`${d}/uploads/${t}`,onClick:()=>{C({show:!0,imgUrl:`${d}/uploads/${t}`})},alt:`Existing Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}})},`existing-${s}`))})}),(h==null?void 0:h.show)&&e.jsx(o,{lg:"6",children:e.jsx(c,{children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(Z,{drawDotsOnImage:h,setDrawDotsAnImage:C,onSave:t=>{G(t)},setMarkers:T,markers:O})})})}),e.jsx(o,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(x,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(o,{sm:"10",children:[e.jsx(A,{type:"file",id:"multiple-file-input",name:"pictures",onChange:Q,accept:"image/*",multiple:!0,ref:b}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:j.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(R,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(k,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>z(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s))})]})]})}),e.jsx(c,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(k,{disabled:E,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{ve as default};
