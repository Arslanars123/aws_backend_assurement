import{r as d,a as Y,b as J,j as e,R as c,C as a}from"./index-BMHGnWcK.js";import{C as q}from"./ComponentContainerCard-DqzcDgtW.js";import{P as G}from"./PageMetaData-Bgn24qMg.js";import{B as x}from"./urls-CvG9cD6N.js";import{F as l}from"./FormLabel-BBJljh0R.js";import{F as i}from"./FormControl-BhCdWsRE.js";import{I as F}from"./Image-BWlBzfxc.js";import{B as h}from"./Button-Dwvyfso6.js";import{A as K,C as Q,T as X}from"./TextField-CiuEKT8f.js";import"./Card-BQIi55Il.js";import"./divWithClassName-BnTSImTn.js";import"./FormContext-_pJuLZf_.js";import"./useFormControl-78CrNPlx.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Z={username:"",role:"Main Constructor",phone:"",case:"",startDate:"",name:"",address:"",postalCode:"",city:"",cvr:"",contactPerson:"",contactPhone:""},he=()=>{const[o,g]=d.useState(Z),[C,P]=d.useState(!1),j=Y(),[N,v]=d.useState(null),[w,f]=d.useState(null),b=d.useRef(null),[E,U]=d.useState([]),[S,D]=d.useState([]),[I,R]=d.useState(null),[k,$]=d.useState(null),y=d.useRef(null),{companyId:p,projectId:u}=J(),M=n=>{const s=n.target.files[0];if(R(s),s){const t=URL.createObjectURL(s);$(t)}},A=()=>{R(null),$(null),y.current&&(y.current.value="")},m=n=>{const{name:s,value:t}=n.target;g({...o,[s]:t}),s==="username"&&t&&O(t)},O=async n=>{try{const t=await(await fetch(`${x}/check-user-exists?username=${encodeURIComponent(n)}`)).json();if(t.exists&&t.user){if(g(r=>({...r,name:t.user.name||r.name,phone:t.user.phone||r.phone,address:t.user.address||r.address,city:t.user.city||r.city,postalCode:t.user.postalCode||r.postalCode,startDate:t.user.startDate||r.startDate,cvr:t.user.cvr||r.cvr,contactPerson:t.user.contactPerson||r.contactPerson,contactPhone:t.user.contactPhone||r.contactPhone})),t.user.picture){const r=t.user.picture.startsWith("http")?t.user.picture:`${x.replace("/api","")}/uploads/${t.user.picture}`;f(r)}alert(`User with email ${n} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(s){console.error("Error checking user existence:",s)}},T=n=>{const s=n.target.files[0];if(v(s),s){const t=URL.createObjectURL(s);f(t)}},V=async n=>{if(n.preventDefault(),!p){alert("You must select company"),j("/dashboard/companies");return}P(!0);try{const s=new FormData;Object.keys(o).forEach(r=>{s.append(r,o[r])}),N&&s.append("picture",N),I&&s.append("contactPicture",I),s.append("companyId",p),s.append("projectsId",u);const t=await fetch(`${x}/store-user`,{method:"POST",body:s});if(t.ok){const r=await t.json();j(`/dashboard/companies/view/${p}`,{state:{success:"Main Constructor added successfully!"}})}else console.error("Error:",t.statusText)}catch(s){console.error("Fetch error:",s)}P(!1)},W=()=>{v(null),f(null),b.current&&(b.current.value="")};d.useEffect(()=>{p&&u&&L()},[p,u]);const L=async()=>{try{const s=await(await fetch(`${x}/get-mains?companyId=${p}`)).json(),r=await(await fetch(`${x}/get-mains?companyId=${p}&projectId=${u}`)).json(),_=s.filter(z=>!r.some(H=>H._id===z._id));U(_)}catch(n){console.error("Error fetching workers:",n)}},B=async()=>{try{if(!u)return;const s={userIds:S.map(r=>r._id),projectId:u},t=await fetch(`${x}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(t.ok){const r=await t.json();j(`/dashboard/companies/view/${p}/projects/view/${u}`,{state:{success:"Main Constructor added successfully!"}})}else console.error("Error:",t.statusText)}catch(n){console.log("Error adding Main Constructor to project:",n)}};return e.jsxs(e.Fragment,{children:[e.jsx(G,{title:"Add Main Constructor"}),!u&&e.jsx("form",{onSubmit:V,children:e.jsx(c,{className:"justify-content-center",children:e.jsx(a,{children:e.jsx(q,{title:"Add Main Constructor",children:e.jsxs(c,{children:[e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.username,onChange:m,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.name,onChange:m,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.phone,onChange:m,name:"phone",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.address,onChange:m,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.city,onChange:m,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.postalCode,onChange:m,name:"postalCode",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.startDate,onChange:m,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"CVR. NR."}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.cvr,onChange:m,name:"cvr",type:"text",id:"cvr-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"Contact Person"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.contactPerson,onChange:m,name:"contactPerson",type:"text",id:"contact-person-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"Phone (Contact)"}),e.jsx(a,{sm:"10",children:e.jsx(i,{value:o.contactPhone,onChange:m,name:"contactPhone",type:"text",id:"contact-phone-input"})})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(a,{sm:"10",children:[e.jsx(i,{type:"file",id:"file-input",name:"picture",onChange:T,accept:"image/*",ref:b}),w&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(F,{src:w,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(h,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:W,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]})]})]})}),e.jsx(a,{lg:"6",children:e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{className:"col-sm-2 col-form-label text-end",children:"Picture (Contact)"}),e.jsxs(a,{sm:"10",children:[e.jsx(i,{type:"file",id:"contact-picture-input",name:"contactPicture",onChange:M,accept:"image/*",ref:y}),k&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(F,{src:k,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(h,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:A,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]})]})]})}),e.jsx(c,{className:"mb-3 d-flex justify-content-center",children:e.jsx(a,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(h,{disabled:C,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),u&&e.jsxs(c,{className:"mb-3",children:[e.jsx(l,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Main Constructor for this Project"}),e.jsxs(a,{sm:"10",children:[e.jsx(K,{multiple:!0,options:E,getOptionLabel:n=>n.name,value:S,onChange:(n,s)=>{D(s)},renderInput:n=>e.jsx(X,{...n,variant:"outlined",placeholder:"Search and select Main Constructor..."}),renderTags:(n,s)=>n.map((t,r)=>e.jsx(Q,{label:t.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(c,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(a,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(h,{disabled:C,type:"submit",variant:"primary",className:"me-1",onClick:B,children:"Submit"})})})]})]})]})};export{he as default};
