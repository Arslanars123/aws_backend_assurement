import{r as h,a as F,b as M,j as e,R as j,C as u}from"./index-S4cPkaXI.js";import{C as O}from"./ComponentContainerCard-CPsL5TPV.js";import{P as T}from"./PageMetaData-u0IuTTri.js";import{B as f}from"./urls-DHmWp6-I.js";import{F as P}from"./FormLabel-xT7fLwVI.js";import{A as D,C as R,T as A}from"./TextField-BSYfgtkt.js";import{B}from"./Button-BdLFNPe1.js";import"./Card-DerqaWgt.js";import"./divWithClassName-23-JlBVG.js";import"./FormContext-3vyf8OR-.js";import"./useFormControl-CQ-iehwM.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const V=()=>{const[d,S]=h.useState([]),[I,g]=h.useState([]),[C,y]=h.useState(!1),[N,E]=h.useState({}),[x,b]=h.useState({}),$=F(),{companyId:m,projectId:c}=M(),v=async()=>{try{const t=await(await fetch(`${f}/get-company-professions?companyId=${m}`)).json(),r=`${f}/get-global-professions`,i=(await(await fetch(r)).json()).filter(a=>!t.some(l=>{var p;return l.professionID===((p=a==null?void 0:a._id)==null?void 0:p.toString())}));g(i)}catch(s){console.error("Error fetching professions:",s)}},w=async()=>{try{const t=await(await fetch(`${f}/get-company-professions?companyId=${m}&projectId=${c}`)).json(),o=(await(await fetch(`${f}/get-company-professions?companyId=${m}`)).json()).filter(i=>!t.some(a=>a.professionID===(i==null?void 0:i.professionID)));g(o)}catch(s){console.error("Error fetching professions:",s)}},k=async s=>{try{const t=await fetch(`${f}/get-eurocodes/${s}`);if(t.ok){const r=await t.json();r.success&&r.eurocodes&&(E(n=>({...n,[s]:r.eurocodes})),b(n=>({...n,[s]:[]})))}}catch(t){console.error("Error fetching EuroCodes:",t)}};h.useEffect(()=>{c&&m?w():m&&v()},[]);const _=async s=>{s.preventDefault(),y(!0);try{let t;if(c?t=d.map(o=>{var a;const i=((a=o==null?void 0:o.projectsId)==null?void 0:a.filter(l=>l!==null))||[];return{...o,projectsId:[...i,c]}}):t=d.map(o=>({...o,companyId:m,professionID:o._id})),!(await fetch(`${f}/add/professions_in_a_company`,{method:"POST",body:JSON.stringify({professions:t,projectsId:c}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to add professions");if(c&&Object.keys(x).length>0){const o=Object.entries(x).map(([i,a])=>{if(a.length===0)return null;const l=d.find(p=>p.SubjectMatterId===i);return l?fetch(`${f}/save-project-profession-eurocodes`,{method:"POST",body:JSON.stringify({companyId:m,projectId:c,professionId:l._id||l.professionID,subjectMatterId:l.SubjectMatterId,eurocodes:a}),headers:{"Content-Type":"application/json"}}):null}).filter(Boolean);o.length>0&&await Promise.all(o)}const n=c?`/dashboard/companies/view/${m}/projects/view/${c}`:`/dashboard/companies/view/${m}`;$(n,{state:{success:"Professions and EuroCodes added successfully!"}})}catch(t){console.error("Fetch error:",t),alert("Error: "+t.message)}finally{y(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(T,{title:"Add Profession"}),e.jsx(j,{className:"justify-content-center",children:e.jsx(u,{children:e.jsx(O,{title:"Add Profession",children:e.jsxs(j,{children:[e.jsx(u,{lg:"12",children:e.jsxs(j,{className:"mb-3",children:[e.jsx(P,{className:"col-sm-2 col-form-label text-end",children:"Professions"}),e.jsxs(u,{sm:"10",children:[e.jsx(D,{multiple:!0,options:I,getOptionLabel:s=>s.GroupName,value:d,onChange:(s,t)=>{S(t),t&&t.length>0&&c&&t.forEach(r=>{r.SubjectMatterId&&k(r.SubjectMatterId)})},renderInput:s=>e.jsx(A,{...s,variant:"outlined",placeholder:"Search and select professions..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(R,{label:r.GroupName,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsxs("div",{style:{fontSize:"0.875rem",color:"#495057",marginTop:"6px"},children:["Selected: ",e.jsx("strong",{children:d.length})," ",d.length===1?"profession":"professions"]})]})]})}),d.length>0&&c&&e.jsx(u,{lg:"12",children:e.jsxs(j,{className:"mb-3",children:[e.jsx(P,{className:"col-sm-2 col-form-label text-end",children:"Select EuroCodes"}),e.jsx(u,{sm:"10",children:d.map((s,t)=>{const r=N[s.SubjectMatterId]||[],n=x[s.SubjectMatterId]||[];return e.jsxs("div",{className:"mb-3 p-3 border rounded",style:{backgroundColor:"#f8f9fa"},children:[e.jsx("h6",{className:"mb-2 text-primary",children:s.GroupName||"Profession"}),r.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"d-flex flex-wrap gap-2",children:r.map(o=>e.jsxs("div",{className:"form-check form-check-inline",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:`${s._id||t}-${o}`,value:o,checked:n.includes(o),onChange:i=>{const a=i.target.checked;b(l=>({...l,[s.SubjectMatterId]:a?[...n,o]:n.filter(p=>p!==o)}))}}),e.jsx("label",{className:"form-check-label",htmlFor:`${s._id||t}-${o}`,children:o})]},o))}),e.jsxs("small",{className:"text-muted",children:["Selected: ",n.length," of ",r.length," EuroCodes"]})]}):e.jsx("small",{className:"text-muted",children:"Loading EuroCodes..."})]},s._id||t)})})]})}),e.jsx(j,{className:"mb-3 d-flex justify-content-center",children:e.jsx(u,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(B,{disabled:C||d.length===0,onClick:_,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})]})};export{V as default};
