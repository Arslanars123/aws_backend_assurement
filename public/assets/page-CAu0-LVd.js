import{r as l,b as oe,ab as ce,a as de,G as me,j as e,R as d,C as o}from"./index-CAFh8Qe-.js";import{C as pe}from"./ComponentContainerCard-BHLb5dlU.js";import{P as ue}from"./PageMetaData-BdrMy3rA.js";import{B as x}from"./urls-D84fNQqS.js";import{P as he}from"./page-CREzSUSi.js";import{F as j}from"./FormLabel-DJooOqJq.js";import{F as ge}from"./FormSelect-DckZIl1p.js";import{A as I,C as E,T as b}from"./TextField-DXeN24BL.js";import{F as B}from"./FormControl-D6Fi2fvk.js";import{I as k}from"./Image-CbaU3Ogc.js";import{B as P}from"./Button-DUm19Z6r.js";import"./Card-B6ongrnB.js";import"./divWithClassName-Ds10gy6J.js";import"./Modal-CXhHI7_p.js";import"./useWindow-9TrldcIQ.js";import"./useEventCallback-CZjKJ66g.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-Cm1DoMSP.js";import"./FormRange-BHW8Q9KG.js";import"./FormContext-CVQotS7s.js";import"./PDFButton-DgNvtDdV.js";import"./Alert-DEk8m-Z5.js";import"./hook-f2Z_u6VT.js";import"./Anchor-Dqz5KG5G.js";import"./useFormControl-BV-vA5Rt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Ke=()=>{var U,z,_,W;const[a,m]=l.useState(null),[J,R]=l.useState(!1),[H,q]=l.useState(!0),[A,fe]=l.useState(null),[xe,G]=l.useState(null),[u,v]=l.useState([]),[w,M]=l.useState([]),{mentionId:y,companyId:p,projectId:h}=oe(),[Q]=ce(),K=de();l.useRef(null);const $=l.useRef(null),[V,O]=l.useState([]),{selectedCompany:je,selectedProjects:we,selectedProfession:be,companies:ve}=l.useContext(me),[N,X]=l.useState([]),[S,Y]=l.useState([]),[D,Z]=l.useState([]),[g,F]=l.useState({show:!1,pdfFile:null,name:null}),[ee,te]=l.useState({}),[C,se]=l.useState(0),L=Q.get("report");l.useEffect(()=>{y&&fetch(`${x}/get-mention-detail/${y}`).then(async s=>{const t=await s.json(),n={item:t.item||"",selectedDrawing:t.drawing||t.selectedDrawing||null,recipients:t.recipients||t.users||null,projectManager:t.projectManager||null,comment:t.comment||""};m(n),t.picture&&t.picture!=="null"&&G(`https://147.93.94.31/uploads/${t.picture}`),t.pictures&&t.pictures.length>0&&O(t.pictures.map(r=>`https://147.93.94.31/uploads/${r}`))}).catch(s=>console.error(s)).finally(()=>q(!1))},[y]),l.useEffect(()=>{const s=async()=>{try{const i=await(await fetch(`${x}/get-draws?companyId=${p}&projectId=${h}`)).json();X(i)}catch(r){console.error("Error fetching drawings:",r)}},t=async()=>{try{const r=`${x}/get-filter-users`,f=await(await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:p,projectId:h})})).json();Y(f)}catch(r){console.error("Error fetching users:",r)}};(async()=>{try{const r=`${x}/get-project-managers?companyId=${p}&projectId=${h}`,c=await(await fetch(r)).json();Z(c)}catch(r){console.error("Error fetching project managers:",r)}})(),t(),s()},[p,h]),l.useEffect(()=>{if(a&&N.length>0&&S.length>0&&D.length>0){let s={...a},t=!1;if(a.selectedDrawing&&typeof a.selectedDrawing=="string"&&a.selectedDrawing.trim()!==""){const n=N.find(r=>r._id===a.selectedDrawing||r.id===a.selectedDrawing);n&&(s.selectedDrawing=n,t=!0)}if(a.recipients&&typeof a.recipients=="string"&&a.recipients.trim()!==""){const n=S.find(r=>r._id===a.recipients||r.id===a.recipients);n&&(s.recipients=n,t=!0)}if(a.projectManager&&typeof a.projectManager=="string"&&a.projectManager.trim()!==""){const n=D.find(r=>r._id===a.projectManager||r.id===a.projectManager);n&&(s.projectManager=n,t=!0)}t&&m(s)}},[N,S,D]);const ae=s=>{const{name:t,value:n}=s.target;m({...a,[t]:n})},ne=s=>{const t=Array.from(s.target.files),n=[...u,...t],r=[...w,...t.map(i=>URL.createObjectURL(i))];v(n),M(r)},T=s=>{const t=u.filter((i,c)=>c!==s),n=w.filter((i,c)=>c!==s);v(t),M(n);const r=new DataTransfer;t.forEach(i=>r.items.add(i)),$.current&&($.current.files=r.files)},re=(s,t)=>{const n=[...u];n[s].description=t,v(n)},ie=async s=>{s.preventDefault(),R(!0);const t=new FormData;t.append("companyId",p),t.append("projectsId",h),t.append("comment",a.comment),t.append("item",a.item),t.append("recipients",JSON.stringify(a.recipients)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("drawing",JSON.stringify(a.selectedDrawing)),A&&t.append("picture",A),u.length>0&&u.forEach((n,r)=>{t.append("pictures",n.file),t.append("pictureDescriptions",n.description||"")}),Object.entries(ee).forEach(([n,r])=>{const f=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",r,f)});try{const n=await fetch(`${x}/update-mention/${y}`,{method:"POST",body:t});if(n.ok){const r=await n.json(),i=h?`/dashboard/companies/view/${p}/projects/view/${h}`:p?`/dashboard/companies/view/${p}/mentions`:"/dashboard/mentions",c=L?`?report=${encodeURIComponent(L)}`:"";K(`${i}${c}`,{state:{success:"Safety Mention updated successfully!"}})}else console.error("Error:",n.statusText)}catch(n){console.error("Fetch error:",n)}R(!1)},le=s=>{O(t=>t.filter((n,r)=>r!==s)),m(t=>{if(!t)return null;const n=t.pictures2.filter((r,i)=>i!==s);return{...t,pictures2:n.length>0?n:[]}})};return e.jsxs(e.Fragment,{children:[e.jsx(ue,{title:"Edit Safety Mention"}),H||!a?e.jsxs("div",{className:"text-center p-4",children:[e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2",children:"Loading mention data..."})]}):e.jsx("form",{onSubmit:ie,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(pe,{title:"Edit Safety Mention",children:e.jsxs(d,{children:[e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(j,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(o,{sm:"10",children:e.jsxs(ge,{value:a.item||"",name:"item",onChange:ae,children:[e.jsx("option",{value:"",children:"Select Item"}),e.jsx("option",{value:"Work has stopped",children:"Work has stopped"}),e.jsx("option",{value:"Shielding is missing here",children:"Shielding is missing here"}),e.jsx("option",{value:"A safety hazard",children:"A safety hazard"}),e.jsx("option",{value:"Lacks cleanup",children:"Lacks cleanup"}),e.jsx("option",{value:"Security shielding inhibits my work",children:"Security shielding inhibits my work"}),e.jsx("option",{value:"Scaffolding is not done appropriately",children:"Scaffolding is not done appropriately"})]})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(o,{sm:"10",children:e.jsx(I,{multiple:!1,options:S,getOptionLabel:s=>s.name,value:a==null?void 0:a.recipients,onChange:(s,t)=>{m({...a,recipients:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select Project Users..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(E,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(j,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(o,{sm:"10",children:e.jsx(b,{style:{width:"100%"},variant:"outlined",placeholder:"Add some comments...",value:(a==null?void 0:a.comment)||"",onChange:s=>{var t;m({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(o,{sm:"10",children:e.jsx(I,{multiple:!1,options:D,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{m({...a,projectManager:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(E,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(I,{multiple:!1,options:N,getOptionLabel:s=>s.name?s.name:s.mainDrawings&&s.mainDrawings.length>0&&s.mainDrawings[0].original||"No name available",value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{m({...a,selectedDrawing:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((n,r)=>{const i=n.name||(n.mainDrawings&&n.mainDrawings.length>0?n.mainDrawings[0].original:"No name available");return e.jsx(E,{label:i,...t({index:r})})}),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(o,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(z=(U=a==null?void 0:a.selectedDrawing)==null?void 0:U.mainDrawings)==null?void 0:z.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;F({show:!0,pdfFile:`${x}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(g==null?void 0:g.show)&&e.jsx(he,{pdfUrl:g.pdfFile,onClose:()=>F({show:!1,pdfFile:null}),onSave:(s,t)=>{se(t),te(n=>({...n,[g.name.endsWith(".png")?g.name:`${g.name}.png`]:s})),F({show:!1,pdfFile:null})}}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(o,{lg:"12",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(W=(_=a==null?void 0:a.selectedDrawing)==null?void 0:_.childDrawings)==null?void 0:W.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),e.jsx(o,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(j,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:C>0?`Pictures (${C} marks)`:"Pictures"}),e.jsx(o,{sm:"10",children:C>0?e.jsx("div",{className:"mb-3",children:Array.from({length:C}).map((s,t)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),e.jsx(B,{type:"file",name:`picture-mark-${t+1}`,onChange:n=>{const r=Array.from(n.target.files);if(r.length>0){const i=[...u];r.forEach(f=>{i.push({file:f,description:"",markNumber:t+1})}),v(i);const c=[...w];r.forEach(f=>{c.push(URL.createObjectURL(f))}),M(c)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:u.map((n,r)=>{if(n.markNumber===t+1){const i=w[r];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(k,{src:i,alt:`Preview ${r}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:n.description,onChange:c=>re(r,c.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>T(r),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},r)}return null})})]},t))}):e.jsxs(e.Fragment,{children:[e.jsx(B,{type:"file",id:"multiple-file-input",name:"pictures",onChange:ne,accept:"image/*",multiple:!0,ref:$}),e.jsxs("div",{className:"mt-3 d-flex flex-wrap",children:[w.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(k,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>T(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)),V.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(k,{src:s,alt:`Existing Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>le(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},`existing-${t}`))]})]})})]})}),e.jsx(d,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(P,{disabled:J,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Ke as default};
