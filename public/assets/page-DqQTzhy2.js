import{r as c,j as i}from"./index-B342vN8a.js";import{M as U}from"./Modal-DqlySIHa.js";import{F as X}from"./FormRange-C54s6zi2.js";import{P as S,r as $}from"./PDFButton-DL5ySIrG.js";import{F as Y}from"./FormLabel-f-qql_Cp.js";import{B as F}from"./Button-BnzdNfRx.js";async function H(x,e,E){try{console.log("markers",e);let h;if(x instanceof File)h=await x.arrayBuffer();else if(typeof x=="string"){const d=await fetch(x);if(!d.ok)throw new Error("Failed to fetch PDF from URL");h=await d.arrayBuffer()}else throw new Error("Unsupported input type for PDF file");const o=await S.load(h),g=o.getPages();Object.entries(e).forEach(([d,L])=>{const a=Number(d)-1,b=g[a];if(!b)return;const{width:y,height:f}=b.getSize();L.forEach(({xPercent:P,yPercent:j},v)=>{let u=v;Object.entries(e).forEach(([A,R])=>{Number(A)<Number(d)&&(u+=R.length)});const n=P/100*y,C=j/100*f;b.drawCircle({x:n,y:f-C,size:E||5,color:$(1,0,0),borderColor:$(1,1,1),borderWidth:1});const m=Math.max(8,E/2);b.drawText(`${u+1}`,{x:n-m/4,y:f-C-m/4,size:m,color:$(1,1,1)})})});const p=await o.save();return new Blob([p],{type:"application/pdf"})}catch(h){throw console.error("Error generating annotated PDF:",h),h}}const _=c.forwardRef(({backgroundColor:x="red",drawDotsOnPdf:e,setDrawDotsOnPdf:E,onSave:h,markers:o=[],setMarkers:g,dotSize:p,setDotSize:d,onClose:L,readOnly:a=!1},b)=>{const[y,f]=c.useState(null),[P,j]=c.useState(!1),[v,u]=c.useState(null),[n,C]=c.useState(1),[m,A]=c.useState(1),R=c.useRef(),k=c.useRef(),B=Object.values(o).flat().length,V=r=>{try{const l=new Uint8Array(r);return String.fromCharCode.apply(null,l.subarray(0,5)).startsWith("%PDF")}catch(l){return console.error("Error validating PDF header:",l),!1}};c.useEffect(()=>{let r=null;return(async()=>{try{if(j(!0),u(null),e!=null&&e.pdfFile){if(console.log("Setting up PDF URL for:",e.pdfFile),e.pdfFile instanceof File)r=URL.createObjectURL(e.pdfFile),f(r);else if(typeof e.pdfFile=="string"){try{const t=await fetch(e.pdfFile,{method:"HEAD"});if(console.log("URL accessibility check:",{status:t.status,contentType:t.headers.get("content-type"),contentLength:t.headers.get("content-length")}),!t.ok)throw new Error(`URL not accessible: ${t.status} ${t.statusText}`)}catch(t){console.warn("HEAD request failed, proceeding with GET:",t)}f(e.pdfFile)}else if(e.pdfFile instanceof ArrayBuffer||e.pdfFile instanceof Uint8Array){const t=new Blob([e.pdfFile],{type:"application/pdf"});r=URL.createObjectURL(t),f(r)}try{let t;if(e.pdfFile instanceof File)t=await e.pdfFile.arrayBuffer();else if(typeof e.pdfFile=="string"){const s=await fetch(e.pdfFile);if(!s.ok)throw new Error(`Failed to fetch PDF: ${s.status} ${s.statusText}`);t=await s.arrayBuffer()}if(t){if(console.log("PDF bytes loaded:",{size:t.byteLength,firstBytes:Array.from(new Uint8Array(t.slice(0,10))).map(N=>N.toString(16).padStart(2,"0")).join(" ")}),!V(t))throw console.error("Invalid PDF header detected"),new Error("Invalid PDF file: File does not appear to be a valid PDF document");const s=await S.load(t);A(s.getPageCount()),console.log("PDF loaded successfully, page count:",s.getPageCount())}}catch(t){console.error("Error getting page count:",t);let s="Failed to process PDF file";t.message.includes("Invalid PDF file")?s="The selected file is not a valid PDF document. Please check the file and try again.":t.message.includes("Failed to fetch PDF")?s="Unable to load the PDF file from the server. The file may be missing or corrupted.":t.message.includes("URL not accessible")?s="The PDF file URL is not accessible. The file may have been moved or deleted.":s=`PDF processing error: ${t.message}`,u(s),A(1)}}else f(null)}catch(t){console.error("Error setting up PDF URL:",t);let s="Failed to process PDF file";t.message.includes("Invalid PDF file")?s="The selected file is not a valid PDF document. Please check the file and try again.":t.message.includes("Failed to fetch PDF")?s="Unable to load the PDF file from the server. The file may be missing or corrupted.":t.message.includes("URL not accessible")?s="The PDF file URL is not accessible. The file may have been moved or deleted.":s=`PDF processing error: ${t.message}`,u(s)}finally{j(!1)}})(),()=>{r&&URL.revokeObjectURL(r)}},[e==null?void 0:e.pdfFile]);const W=r=>{if(!R.current||a)return;const l=R.current.getBoundingClientRect(),t=r.clientX-l.left,s=r.clientY-l.top,N=t/l.width*100,I=s/l.height*100,w={xPercent:N,yPercent:I,id:Date.now()+Math.random()};g(z=>{const G=z[n]||[];return{...z,[n]:[...G,w]}})},q=r=>{a||g(l=>{const t=l[n]||[];return{...l,[n]:t.filter(s=>s.id!==r)}})};c.useImperativeHandle(b,()=>({getAnnotatedPDF:async()=>{try{if(!(e!=null&&e.pdfFile))return{originalPDF:null,annotations:{}};const r=await H(e.pdfFile,o,p);return{originalPDF:e.pdfFile,annotations:o,annotatedPDF:r}}catch(r){return console.error("Error in getAnnotatedPDF:",r),{originalPDF:e==null?void 0:e.pdfFile,annotations:o}}},clearAnnotations:()=>{g({})},exportAnnotations:()=>o,importAnnotations:r=>{g(r)}}));const T=()=>{L&&L(),E({show:!1,pdfFile:null}),f(null),u(null),j(!1)},M=y?`${y}#page=${n}&view=FitV&toolbar=0&navpanes=0&scrollbar=0`:null;return i.jsxs(U,{size:"xl",show:e==null?void 0:e.show,onHide:T,dialogClassName:"modal-90w",backdrop:"static",children:[i.jsx(U.Header,{closeButton:!0,children:i.jsx(U.Title,{children:a?"PDF Viewer":`PDF Viewer with Annotations - ${B} markers`})}),i.jsxs(U.Body,{children:[!a&&i.jsxs("div",{className:"controls mb-3 d-flex align-items-center gap-4 flex-wrap",children:[i.jsxs("div",{className:"d-flex align-items-center gap-2",children:[i.jsx(Y,{className:"mb-0",children:"Dot Size:"}),i.jsx(X,{min:3,max:20,value:p,onChange:r=>d(Number(r.target.value)),style:{width:"100px"}}),i.jsxs("span",{className:"text-muted",children:[p,"px"]})]}),i.jsx(F,{variant:"outline-danger",size:"sm",onClick:()=>g(r=>{const l={...r};return l[n]=[],l}),disabled:!o[n]||o[n].length===0,children:"Clear All Markers"}),i.jsx(F,{variant:"outline-primary",size:"sm",onClick:()=>C(r=>Math.max(r-1,1)),disabled:n<=1,children:"⬅️ Previous Page"}),i.jsxs("span",{className:"fw-bold",children:["Page ",n," of ",m]}),i.jsx(F,{variant:"outline-primary",size:"sm",onClick:()=>C(r=>Math.min(r+1,m)),disabled:n>=m,children:"Next Page ➡️"})]}),P&&i.jsxs("div",{className:"text-center p-4",children:[i.jsx("div",{className:"spinner-border",role:"status",children:i.jsx("span",{className:"visually-hidden",children:"Loading..."})}),i.jsx("p",{className:"mt-2",children:"Processing PDF..."})]}),v&&i.jsxs("div",{className:"alert alert-danger",children:[i.jsx("h6",{children:"PDF Processing Error:"}),i.jsx("p",{children:v}),i.jsx("hr",{}),i.jsx("p",{className:"mb-0",children:i.jsx("strong",{children:"Troubleshooting tips:"})}),i.jsxs("ul",{className:"mb-0",children:[i.jsx("li",{children:"Make sure the file is a valid PDF document"}),i.jsx("li",{children:"Check if the file is corrupted or incomplete"}),i.jsx("li",{children:"Try refreshing the page and selecting the file again"}),i.jsx("li",{children:"Contact support if the issue persists"})]}),i.jsx("hr",{}),i.jsxs("div",{className:"d-flex gap-2",children:[i.jsx(F,{variant:"outline-primary",size:"sm",onClick:()=>{typeof(e==null?void 0:e.pdfFile)=="string"&&window.open(e.pdfFile,"_blank")},disabled:typeof(e==null?void 0:e.pdfFile)!="string",children:"Open PDF in New Tab"}),i.jsx(F,{variant:"outline-secondary",size:"sm",onClick:()=>{u(null),j(!0)},children:"Retry Processing"})]})]}),y&&i.jsxs("div",{ref:R,className:"pdf-container position-relative",style:{height:"calc(80vh)",width:"100%",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center"},onClick:a?void 0:W,children:[i.jsx("iframe",{ref:k,src:M,style:{width:"100%",height:"100%",border:"1px solid #ddd",borderRadius:"4px",pointerEvents:a?null:"none"},title:"PDF Viewer"},M),(o[n]||[]).map((r,l)=>{let t=l;return Object.entries(o).forEach(([s,N])=>{Number(s)<n&&(t+=N.length)}),i.jsx("div",{onClick:s=>{a||(s.stopPropagation(),q(r.id))},style:{position:"absolute",top:`${r.yPercent}%`,left:`${r.xPercent}%`,width:`${p}px`,height:`${p}px`,backgroundColor:x,borderRadius:"50%",transform:"translate(-50%, -50%)",cursor:a?"default":"pointer",border:"2px solid #fff",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},title:a?`Marker ${t+1}`:"Click to remove marker",children:i.jsx("span",{style:{color:"#fff",fontSize:`${Math.max(8,p/2)}px`,fontWeight:"bold"},children:t+1})},r.id)})]})]}),i.jsxs(U.Footer,{children:[i.jsx(F,{variant:"secondary",onClick:T,children:a?"Close":"Cancel"}),!a&&i.jsxs(F,{variant:"primary",disabled:!y||P||v||B===0,onClick:async()=>{try{if(e!=null&&e.pdfFile){const r=await H(e.pdfFile,o,p);h&&(h(r),console.log("Annotated PDF saved successfully"))}T()}catch(r){console.error("Error saving annotated PDF:",r),alert("Failed to save annotated PDF. Please try again.")}},children:["Save Annotations ",B]})]})]})});_.displayName="PDFAnnotator";export{_ as P};
