import{r as l,a as ee,b as se,j as e,R as d,C as i}from"./index-CcXmhF8I.js";import{C as te}from"./ComponentContainerCard-DfOGF2MZ.js";import{P as ae}from"./PageMetaData-_VBvv3yh.js";import{B as h}from"./urls-BhGeBsON.js";import{P as ne}from"./page-BssMbynW.js";import{F as x}from"./FormLabel-ur_7HqrZ.js";import{F as re}from"./FormSelect-Cej4LfTs.js";import{A as N,C as D,T as f}from"./TextField-DX6iEtHg.js";import{F as ie}from"./FormControl-IaSihKBy.js";import{I as le}from"./Image-BA0SNZ1J.js";import{B as E}from"./Button-Bb5NLKr0.js";import"./Card-BbEwloSO.js";import"./divWithClassName-stAqo3H6.js";import"./page-BhJyEnzt.js";import"./Modal-DS3RX9z9.js";import"./useWindow-Dt3mh2_H.js";import"./DataKey-SibGzzBh.js";import"./NoopTransition-C0OklqXl.js";import"./FormRange-CQhrKEDN.js";import"./PDFButton-ck9OA1nG.js";import"./Alert-BzuID01t.js";import"./Anchor-CgtXfp9s.js";import"./useFormControl-DAPC7iVt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const oe={item:null,users:null,selectedDrawing:null,projectManager:null,recipients:null,comment:null},Ee=()=>{var F,I,M,A,$,O;const[a,p]=l.useState(oe),[R,C]=l.useState(!1),T=ee(),{companyId:g,projectId:m}=se(),[k,L]=l.useState([]),[u,v]=l.useState([]),[y,P]=l.useState([]),S=l.useRef(null),[z,U]=l.useState([]),[B,W]=l.useState([]),[j,w]=l.useState({show:!1,pdfFile:null,name:null}),[J,_]=l.useState({}),V=async()=>{try{const t=await(await fetch(`${h}/get-draws?companyId=${g}&projectId=${m}`)).json();L(t)}catch(s){console.error("Error fetching workers:",s)}},q=async()=>{try{const s=`${h}/get-project-managers?companyId=${g}&projectId=${m}`,n=await(await fetch(s)).json();U(n)}catch(s){console.error("Error fetching project managers:",s)}},H=async()=>{try{const s=`${h}/get-filter-users`,r=await(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:g,projectId:m})})).json();W(r)}catch(s){console.error("Error fetching users:",s)}};l.useEffect(()=>{V(),q(),H()},[m]);const G=s=>{const t=Array.from(s.target.files),n=t.map(c=>({file:c,description:""})),r=[...u,...n],o=[...y,...t.map(c=>URL.createObjectURL(c))];v(r),P(o)},K=s=>{const t=u.filter((o,c)=>c!==s),n=y.filter((o,c)=>c!==s);v(t),P(n);const r=new DataTransfer;t.forEach(o=>r.items.add(o.file)),S.current&&(S.current.files=r.files)},Q=(s,t)=>{const n=[...u];n[s].description=t,v(n)},X=s=>{const{name:t,value:n,multiple:r,options:o}=s.target;if(r){const c=Array.from(o).filter(b=>b.selected).map(b=>b.value);p({...a,[t]:c})}else p({...a,[t]:n})},Y=async s=>{s.preventDefault(),C(!0);try{const t=new FormData;Object.keys(a).forEach(r=>{r==="projectManager"||r==="selectedDrawing"||r==="recipients"||t.append(r,a[r])}),t.append("companyId",g),t.append("projectsId",m),t.append("comment",a.comment),t.append("drawing",JSON.stringify(a.selectedDrawing)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("recipients",JSON.stringify(a.recipients)),u.length>0&&u.forEach((r,o)=>{t.append("pictures",r.file),t.append("pictureDescriptions",r.description||"")}),Object.entries(J).forEach(([r,o])=>{const Z=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",o,Z)});const n=await fetch(`${h}/store-mention`,{method:"POST",body:t});if(n.ok){const r=await n.json();T(`/dashboard/companies/view/${g}/projects/view/${m}`,{state:{success:"Safety Mention added successfully!"}})}else console.error("Error:",n.statusText)}catch(t){console.error("Fetch error:",t)}C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(ae,{title:"Add Safety Mention"}),e.jsx("form",{onSubmit:Y,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(te,{title:"Add Safety Mention",children:e.jsxs(d,{children:[e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(i,{sm:"10",children:e.jsxs(re,{value:a.item,name:"item",onChange:X,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Work has stopped",children:"Work has stopped"}),e.jsx("option",{value:"Shielding is missing here",children:"Shielding is missing here"}),e.jsx("option",{value:"A safety hazard",children:"A safety hazard"}),e.jsx("option",{value:"Lacks cleanup",children:"Lacks cleanup"}),e.jsx("option",{value:"Security shielding inhibits my work",children:"Security shielding inhibits my work"}),e.jsx("option",{value:"Scaffolding is not done appropriately",children:"Scaffolding is not done appropriately"})]})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(i,{sm:"10",children:e.jsx(N,{multiple:!1,options:B,getOptionLabel:s=>s.name,value:a==null?void 0:a.recipients,onChange:(s,t)=>{p({...a,recipients:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select Project Users..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(D,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(f,{style:{width:"100%"},variant:"outlined",placeholder:"Add some comments...",value:a==null?void 0:a.comment,onChange:s=>{var t;p({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(N,{multiple:!1,options:z,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{p({...a,projectManager:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(D,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(N,{multiple:!1,options:k,getOptionLabel:s=>s.name,value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{p({...a,selectedDrawing:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(D,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(x,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(i,{sm:"10",children:[e.jsx(ie,{type:"file",id:"multiple-file-input",name:"pictures",onChange:G,accept:"image/*",multiple:!0,ref:S}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:y.map((s,t)=>{var n;return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(le,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(f,{variant:"outlined",placeholder:"Add description...",value:((n=u[t])==null?void 0:n.description)||"",onChange:r=>Q(t,r.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(E,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>K(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},t)})})]})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(I=(F=a==null?void 0:a.selectedDrawing)==null?void 0:F.mainDrawings)==null?void 0:I.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;w({show:!0,pdfFile:`${h}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(a==null?void 0:a.selectedDrawing)&&((A=(M=a==null?void 0:a.selectedDrawing)==null?void 0:M.childDrawings)==null?void 0:A.length)>0&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(O=($=a==null?void 0:a.selectedDrawing)==null?void 0:$.childDrawings)==null?void 0:O.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;w({show:!0,pdfFile:`${h}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),(j==null?void 0:j.show)&&e.jsx(ne,{pdfUrl:j.pdfFile,onClose:()=>w({show:!1,pdfFile:null}),onSave:s=>{_(t=>({...t,[j.name]:s})),w({show:!1,pdfFile:null})}}),e.jsx(d,{className:"mb-3 d-flex justify-content-center",children:e.jsx(i,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(E,{disabled:R,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Ee as default};
