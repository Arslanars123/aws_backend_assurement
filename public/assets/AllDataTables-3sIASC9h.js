import{r as k,j as s,R as D,C as p,u as F}from"./index-CEbbE1Sf.js";import{C as _}from"./ComponentContainerCard-BpYspYtC.js";import{R as B}from"./index-CQzRielJ.js";import{B as N}from"./urls-CvG9cD6N.js";import{M as C}from"./Modal-C5567GrF.js";import{C as E}from"./Card-mt6mV6AB.js";import{B as v}from"./Badge-CuddoZv3.js";import{L as $}from"./ListGroup-WMjKc_zO.js";import{B as T}from"./Button-CWQV4UHt.js";const R=({show:m,onHide:l,taskId:u,projectId:x})=>{const[c,a]=k.useState(null),[n,d]=k.useState(!1);k.useEffect(()=>{m&&u&&x&&b()},[m,u,x]);const b=async()=>{d(!0);try{const h=await(await fetch(`${N}/get-project-task?projectId=${x}&taskId=${u}`)).json();if(h&&h.taskEntries&&Array.isArray(h.taskEntries))a(h.taskEntries);else{const r=await(await fetch(`${N}/get-task-submission-analytics?projectId=${x}`)).json();if(r.success){const o=[...r.byUsers,...r.byIndependentControllers],g=[];o.forEach(t=>{t.tasks.forEach(i=>{if(i.taskId===u){const I={...h,...i,user:t};g.push(I)}})}),a(g)}}}catch(e){console.error("Error fetching task entries:",e)}finally{d(!1)}},f=e=>e?new Date(e).toLocaleString():"N/A",P=()=>{if(!c)return{workers:[],controllers:[]};const e=[...c].sort((r,o)=>r.entryNumber&&o.entryNumber?r.entryNumber-o.entryNumber:r.submittedAt&&o.submittedAt?new Date(r.submittedAt)-new Date(o.submittedAt):0),h=e.filter(r=>r.user&&r.user.role!=="Independent Controller"),j=e.filter(r=>r.user&&r.user.role==="Independent Controller");return{workers:h,controllers:j}},{workers:S,controllers:A}=P();return s.jsxs(C,{show:m,onHide:l,size:"xl",style:{maxWidth:"95vw"},children:[s.jsx(C.Header,{closeButton:!0,className:"bg-dark text-white",children:s.jsxs(C.Title,{children:[s.jsx("i",{className:"fas fa-tasks me-2"}),"Task Entries - ",u]})}),s.jsxs(C.Body,{style:{maxHeight:"80vh",overflowY:"auto",padding:"20px"},children:[s.jsx("style",{children:`
            .modal-xl .modal-body {
              font-size: 14px;
              line-height: 1.6;
            }
            .modal-xl .card {
              border-radius: 8px;
            }
            .modal-xl .list-group-item {
              border-radius: 6px;
              margin-bottom: 10px;
            }
            .modal-xl img {
              border-radius: 6px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .modal-xl .badge {
              font-size: 12px;
            }
          `}),n?s.jsx("div",{className:"text-center",children:s.jsx("div",{className:"spinner-border",role:"status",children:s.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):c&&c.length>0?s.jsxs(D,{children:[s.jsx(p,{lg:6,children:s.jsxs(E,{className:"mb-3 shadow-sm",children:[s.jsx(E.Header,{className:"bg-primary text-white",children:s.jsxs("h6",{className:"mb-0",children:[s.jsx("i",{className:"fas fa-user-tie me-2"}),"Independent Controllers",s.jsx(v,{bg:"light",text:"dark",className:"ms-2",children:A.length})]})}),s.jsx(E.Body,{children:A.length>0?s.jsx($,{variant:"flush",children:A.map((e,h)=>{var j,r,o,g;return s.jsxs($.Item,{className:"border-0 shadow-sm mb-3",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-3",children:[s.jsxs("div",{children:[s.jsxs("h6",{className:"mb-1",children:[s.jsx("i",{className:"fas fa-user me-2 text-primary"}),e.user.name||e.user.username,e.entryNumber&&s.jsxs(v,{bg:"info",className:"ms-2",children:["Entry #",e.entryNumber]})]}),s.jsxs("small",{className:"text-muted",children:[s.jsx("i",{className:"fas fa-clock me-1"}),"Submitted: ",f(e.submittedAt)]})]}),s.jsxs(v,{bg:"success",className:"fs-6",children:[s.jsx("i",{className:"fas fa-check me-1"}),"Submitted"]})]}),s.jsxs("div",{className:"mt-3",children:[s.jsx("h6",{children:"Task Information"}),s.jsxs(D,{children:[s.jsxs(p,{md:6,children:[s.jsx("strong",{children:"Building Parts:"})," ",((j=e.buildingParts)==null?void 0:j.name)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"Drawing:"})," ",((r=e.drawing)==null?void 0:r.name)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"Submitted At:"})," ",f(e.submittedAt)]}),s.jsxs(p,{md:6,children:[s.jsx("strong",{children:"User Role:"})," ",((o=e.user)==null?void 0:o.role)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"User ID:"})," ",((g=e.user)==null?void 0:g._id)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"Entry ID:"})," ",e._id||"N/A"]})]})]}),e.comment&&s.jsxs("div",{className:"mt-3",children:[s.jsx("strong",{children:"Comment:"}),s.jsx("p",{className:"mb-0 text-muted",children:e.comment})]}),e.pictures&&e.pictures.length>0&&s.jsxs("div",{className:"mt-3",children:[s.jsxs("strong",{children:["Images (",e.pictures.length,"):"]}),s.jsx("div",{className:"row mt-2",children:e.pictures.map((t,i)=>s.jsx("div",{className:"col-md-4 mb-2",children:s.jsx("img",{src:`${N}/uploads/${t}`,alt:`Image ${i+1}`,className:"img-fluid rounded",style:{maxHeight:"150px",objectFit:"cover"}})},i))})]}),e.pictureObjects&&e.pictureObjects.length>0&&s.jsxs("div",{className:"mt-3",children:[s.jsx("strong",{children:"Images with Descriptions:"}),s.jsx("div",{className:"row mt-2",children:e.pictureObjects.map((t,i)=>s.jsxs("div",{className:"col-md-4 mb-2",children:[s.jsx("img",{src:`${N}/uploads/${t.filename}`,alt:t.description||`Image ${i+1}`,className:"img-fluid rounded",style:{maxHeight:"150px",objectFit:"cover"}}),t.description&&s.jsx("small",{className:"text-muted d-block mt-1",children:t.description})]},i))})]}),e.annotatedPdfs&&e.annotatedPdfs.length>0&&s.jsxs("div",{className:"mt-3",children:[s.jsxs("strong",{children:["Annotated PDFs (",e.annotatedPdfs.length,"):"]}),s.jsx("div",{className:"row mt-2",children:e.annotatedPdfs.map((t,i)=>s.jsx("div",{className:"col-md-4 mb-2",children:s.jsxs("div",{className:"border rounded p-2 text-center",children:[s.jsx("i",{className:"fas fa-file-pdf text-danger mb-2",style:{fontSize:"2rem"}}),s.jsx("br",{}),s.jsx("small",{children:t.originalName||t.filename}),s.jsx("br",{}),s.jsx("a",{href:`${N}/uploads/${t.filename}`,target:"_blank",rel:"noopener noreferrer",className:"btn btn-sm btn-outline-primary mt-1",children:"View PDF"})]})},i))})]})]},h)})}):s.jsx("p",{className:"text-muted mb-0",children:"No entries from Independent Controllers"})})]})}),s.jsx(p,{lg:6,children:s.jsxs(E,{className:"mb-3 shadow-sm",children:[s.jsx(E.Header,{className:"bg-success text-white",children:s.jsxs("h6",{className:"mb-0",children:[s.jsx("i",{className:"fas fa-hard-hat me-2"}),"Workers",s.jsx(v,{bg:"light",text:"dark",className:"ms-2",children:S.length})]})}),s.jsx(E.Body,{children:S.length>0?s.jsx($,{variant:"flush",children:S.map((e,h)=>{var j,r,o,g;return s.jsxs($.Item,{className:"border-0 shadow-sm mb-3",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-3",children:[s.jsxs("div",{children:[s.jsxs("h6",{className:"mb-1",children:[s.jsx("i",{className:"fas fa-hard-hat me-2 text-success"}),e.user.name||e.user.username,e.entryNumber&&s.jsxs(v,{bg:"info",className:"ms-2",children:["Entry #",e.entryNumber]})]}),s.jsxs("small",{className:"text-muted",children:[s.jsx("i",{className:"fas fa-clock me-1"}),"Submitted: ",f(e.submittedAt)]})]}),s.jsxs(v,{bg:"success",className:"fs-6",children:[s.jsx("i",{className:"fas fa-check me-1"}),"Submitted"]})]}),s.jsxs("div",{className:"mt-3",children:[s.jsx("h6",{children:"Task Information"}),s.jsxs(D,{children:[s.jsxs(p,{md:6,children:[s.jsx("strong",{children:"Building Parts:"})," ",((j=e.buildingParts)==null?void 0:j.name)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"Drawing:"})," ",((r=e.drawing)==null?void 0:r.name)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"Submitted At:"})," ",f(e.submittedAt)]}),s.jsxs(p,{md:6,children:[s.jsx("strong",{children:"User Role:"})," ",((o=e.user)==null?void 0:o.role)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"User ID:"})," ",((g=e.user)==null?void 0:g._id)||"N/A",s.jsx("br",{}),s.jsx("strong",{children:"Entry ID:"})," ",e._id||"N/A"]})]})]}),e.comment&&s.jsxs("div",{className:"mt-3",children:[s.jsx("strong",{children:"Comment:"}),s.jsx("p",{className:"mb-0 text-muted",children:e.comment})]}),e.pictures&&e.pictures.length>0&&s.jsxs("div",{className:"mt-3",children:[s.jsxs("strong",{children:["Images (",e.pictures.length,"):"]}),s.jsx("div",{className:"row mt-2",children:e.pictures.map((t,i)=>s.jsx("div",{className:"col-md-4 mb-2",children:s.jsx("img",{src:`${N}/uploads/${t}`,alt:`Image ${i+1}`,className:"img-fluid rounded",style:{maxHeight:"150px",objectFit:"cover"}})},i))})]}),e.pictureObjects&&e.pictureObjects.length>0&&s.jsxs("div",{className:"mt-3",children:[s.jsx("strong",{children:"Images with Descriptions:"}),s.jsx("div",{className:"row mt-2",children:e.pictureObjects.map((t,i)=>s.jsxs("div",{className:"col-md-4 mb-2",children:[s.jsx("img",{src:`${N}/uploads/${t.filename}`,alt:t.description||`Image ${i+1}`,className:"img-fluid rounded",style:{maxHeight:"150px",objectFit:"cover"}}),t.description&&s.jsx("small",{className:"text-muted d-block mt-1",children:t.description})]},i))})]}),e.annotatedPdfs&&e.annotatedPdfs.length>0&&s.jsxs("div",{className:"mt-3",children:[s.jsxs("strong",{children:["Annotated PDFs (",e.annotatedPdfs.length,"):"]}),s.jsx("div",{className:"row mt-2",children:e.annotatedPdfs.map((t,i)=>s.jsx("div",{className:"col-md-4 mb-2",children:s.jsxs("div",{className:"border rounded p-2 text-center",children:[s.jsx("i",{className:"fas fa-file-pdf text-danger mb-2",style:{fontSize:"2rem"}}),s.jsx("br",{}),s.jsx("small",{children:t.originalName||t.filename}),s.jsx("br",{}),s.jsx("a",{href:`${N}/uploads/${t.filename}`,target:"_blank",rel:"noopener noreferrer",className:"btn btn-sm btn-outline-primary mt-1",children:"View PDF"})]})},i))})]})]},h)})}):s.jsx("p",{className:"text-muted mb-0",children:"No entries from Workers"})})]})})]}):s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-muted",children:"No entries found for this task"})})]}),s.jsx(C.Footer,{children:s.jsx(T,{variant:"secondary",onClick:l,children:"Close"})})]})},w=(m,l)=>{const x=F().pathname==="/dashboard/tasks",c=[{header:"Profession Index",accessorKey:"Index"},{header:"Subject Matter Id",accessorKey:"SubjectMatterId"},{header:"Type",accessorKey:"Type"}];return x||c.push({header:"Entries",cell:({row:a})=>{const n=a==null?void 0:a.original,d=(n==null?void 0:n.entryCount)||0,b=n==null?void 0:n.isSubmitted;return s.jsxs("div",{className:"d-flex align-items-center",children:[s.jsxs(T,{variant:"outline-primary",size:"sm",onClick:()=>l==null?void 0:l.showEntriesModal(n==null?void 0:n._id),disabled:d===0,children:[d," ",d===1?"Entry":"Entries"]}),b&&s.jsx(v,{bg:"success",className:"ms-2",children:"Submitted"})]})}}),l!=null&&l.showSubmitAction&&m&&c.push({header:"Submit Task",cell:({row:a})=>{var n;return s.jsx(T,{variant:"info",className:"me-2",disabled:(n=a==null?void 0:a.original)==null?void 0:n.isActive,onClick:()=>{var d;l==null||l.setClickTask(a==null?void 0:a.original),m(`tasks/submit/${(d=a==null?void 0:a.original)==null?void 0:d._id}`)},children:"Submit Task"})}}),l!=null&&l.showViewDetail&&m&&(c.push({header:"View Details",cell:({row:a})=>{var n;return s.jsx(T,{variant:"info",disabled:(n=a==null?void 0:a.original)==null?void 0:n.isActive,className:"me-2",onClick:()=>{var d;m(`tasks/view/${(d=a==null?void 0:a.original)==null?void 0:d._id}`)},children:"View Details"})}}),x||c.push({header:"Task State",cell:({row:a})=>{var d;const n=(d=a==null?void 0:a.original)==null?void 0:d.isActive;return s.jsx(T,{variant:"info",className:"me-2",onClick:()=>{var b,f;l==null||l.aprovedTask((b=a==null?void 0:a.original)==null?void 0:b._id,!((f=a==null?void 0:a.original)!=null&&f.isActive))},children:n?"Activate Task":"Deactivate Task"})}})),c},y=({tasks:m,refreshData:l,navigate:u,options:x,projectId:c,selectedReport:a})=>{const n=[2,5,10,20,50],[d,b]=k.useState(!1),[f,P]=k.useState(null),[S,A]=k.useState(m);k.useEffect(()=>{c&&m.length>0&&e()},[c,m]);const e=async()=>{try{console.log("Fetching task entries for projectId:",c);const o=await(await fetch(`${N}/get-task-entries-count?projectId=${c}`)).json();if(console.log("Task entries response:",o),o.success){const g=m.map(t=>{const i=o.tasks.find(I=>I._id===t._id);return console.log("Task:",t._id,"Found entries:",i),{...t,entryCount:(i==null?void 0:i.entryCount)||0,isSubmitted:(i==null?void 0:i.isSubmitted)||!1}});A(g)}}catch(r){console.error("Error fetching task entries count:",r),A(m)}},j={...x,showEntriesModal:r=>{P(r),b(!0)}};return s.jsxs(s.Fragment,{children:[s.jsx(_,{title:"CONTROLPLAN",children:s.jsx(B,{url:"get-tasks",refreshData:l,columns:w(u,j),data:S,rowsPerPageList:n,pageSize:10,tableClass:"datatable",theadClass:"table-light",showPagination:!0,selectedReport:a})}),s.jsx(R,{show:d,onHide:()=>b(!1),taskId:f,projectId:c})]})},G=({tasks:m,refreshData:l,navigate:u,options:x,projectId:c,selectedReport:a})=>s.jsx(s.Fragment,{children:s.jsx(D,{className:"justify-content-center",children:s.jsx(p,{xs:12,children:s.jsx(y,{refreshData:l,tasks:m,navigate:u,options:x,projectId:c,selectedReport:a})})})});export{G as A};
