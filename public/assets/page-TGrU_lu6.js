import{r as m,a as V,b as W,j as e,R as o,C as n}from"./index-BMHGnWcK.js";import{C as L}from"./ComponentContainerCard-DqzcDgtW.js";import{P as B}from"./PageMetaData-Bgn24qMg.js";import{B as x}from"./urls-CvG9cD6N.js";import{F as c}from"./FormLabel-BBJljh0R.js";import{F as u}from"./FormControl-BhCdWsRE.js";import{I as _}from"./Image-BWlBzfxc.js";import{B as y}from"./Button-Dwvyfso6.js";import{A as M,C as Y,T as z}from"./TextField-CiuEKT8f.js";import"./Card-BQIi55Il.js";import"./divWithClassName-BnTSImTn.js";import"./FormContext-_pJuLZf_.js";import"./useFormControl-78CrNPlx.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const H={username:"",role:"Safety Coordinator",phone:"",case:"",startDate:"",name:"",address:"",postalCode:"",city:""},ie=()=>{const[l,b]=m.useState(H),[C,g]=m.useState(!1),h=V(),[N,S]=m.useState(null),[w,f]=m.useState(null),j=m.useRef(null),[I,P]=m.useState([]),[v,k]=m.useState([]),{companyId:d,projectId:i}=W(),p=a=>{const{name:s,value:t}=a.target;b({...l,[s]:t}),s==="username"&&t&&F(t)},F=async a=>{try{const t=await(await fetch(`${x}/check-user-exists?username=${encodeURIComponent(a)}`)).json();if(t.exists&&t.user){if(b(r=>({...r,name:t.user.name||r.name,phone:t.user.phone||r.phone,address:t.user.address||r.address,city:t.user.city||r.city,postalCode:t.user.postalCode||r.postalCode,startDate:t.user.startDate||r.startDate,safetyCertification:t.user.safetyCertification||r.safetyCertification})),t.user.picture){const r=t.user.picture.startsWith("http")?t.user.picture:`${x.replace("/api","")}/uploads/${t.user.picture}`;f(r)}alert(`User with email ${a} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(s){console.error("Error checking user existence:",s)}},$=a=>{const s=a.target.files[0];if(S(s),s){const t=URL.createObjectURL(s);f(t)}},E=async a=>{if(a.preventDefault(),!d){alert("You must select company"),h("/dashboard/companies");return}g(!0);try{const s=new FormData;Object.keys(l).forEach(r=>{s.append(r,l[r])}),N&&s.append("picture",N),s.append("companyId",d),s.append("projectsId",i);const t=await fetch(`${x}/store-user`,{method:"POST",body:s});if(t.ok){const r=await t.json();h(`/dashboard/companies/view/${d}`,{state:{success:"Safety Coordinator added successfully!"}})}else console.error("Error:",t.statusText)}catch(s){console.error("Fetch error:",s)}g(!1)},R=()=>{S(null),f(null),j.current&&(j.current.value="")};m.useEffect(()=>{d&&i&&D()},[d,i]);const D=async()=>{try{const s=await(await fetch(`${x}/get-safety?companyId=${d}`)).json(),r=await(await fetch(`${x}/get-safety?companyId=${d}&projectId=${i}`)).json(),T=s.filter(U=>!r.some(O=>O._id===U._id));P(T)}catch(a){console.error("Error fetching workers:",a)}},A=async()=>{try{if(!i)return;const s={userIds:v.map(r=>r._id),projectId:i},t=await fetch(`${x}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(t.ok){const r=await t.json();h(`/dashboard/companies/view/${d}/projects/view/${i}`,{state:{success:"Safety Coordinator added successfully!"}})}else console.error("Error:",t.statusText)}catch(a){console.log("Error adding Safety Coordinator to project:",a)}};return e.jsxs(e.Fragment,{children:[e.jsx(B,{title:"Add Safety Coordinator"}),!i&&e.jsx("form",{onSubmit:E,children:e.jsx(o,{className:"justify-content-center",children:e.jsx(n,{children:e.jsx(L,{title:"Add Safety Coordinator",children:e.jsxs(o,{children:[e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.username,onChange:p,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.name,onChange:p,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.phone,onChange:p,name:"phone",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.address,onChange:p,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.city,onChange:p,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.postalCode,onChange:p,name:"postalCode",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(n,{sm:"10",children:e.jsx(u,{value:l.startDate,onChange:p,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(n,{sm:"10",children:[e.jsx(u,{type:"file",id:"file-input",name:"picture",onChange:$,accept:"image/*",ref:j}),w&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx(_,{src:w,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(y,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:R,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]})]})]})}),e.jsx(o,{className:"mb-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(y,{disabled:C,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),i&&e.jsxs(o,{className:"mb-3",children:[e.jsx(c,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Safety Coordinator for this Project"}),e.jsxs(n,{sm:"10",children:[e.jsx(M,{multiple:!0,options:I,getOptionLabel:a=>a.name,value:v,onChange:(a,s)=>{k(s)},renderInput:a=>e.jsx(z,{...a,variant:"outlined",placeholder:"Search and select Safety Coordinator..."}),renderTags:(a,s)=>a.map((t,r)=>e.jsx(Y,{label:t.name,...s({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(o,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(y,{disabled:C,type:"submit",variant:"primary",className:"me-1",onClick:A,children:"Submit"})})})]})]})]})};export{ie as default};
