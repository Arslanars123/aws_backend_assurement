import{r as d,a as X,b as Z,j as e,R as o,C as n}from"./index-CAFh8Qe-.js";import{C as ee}from"./ComponentContainerCard-BHLb5dlU.js";import{P as te}from"./PageMetaData-BdrMy3rA.js";import{B as x}from"./urls-D84fNQqS.js";import{F as i}from"./FormLabel-DJooOqJq.js";import{F as m}from"./FormControl-D6Fi2fvk.js";import{F as se}from"./FormSelect-DckZIl1p.js";import{I as $}from"./Image-CbaU3Ogc.js";import{B as j}from"./Button-DUm19Z6r.js";import{A as ae,C as ne,T as re}from"./TextField-DXeN24BL.js";import"./Card-B6ongrnB.js";import"./divWithClassName-Ds10gy6J.js";import"./FormContext-CVQotS7s.js";import"./useFormControl-BV-vA5Rt.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const oe={username:"",role:"Advisor",phone:"",case:"",startDate:"",name:"",address:"",postalCode:"",city:"",type:null,cvr:"",contactPerson:"",contactPhone:""},Ce=()=>{const[s,f]=d.useState(oe),[C,N]=d.useState(!1),y=X(),[w,S]=d.useState(null),[A,g]=d.useState(null),b=d.useRef(null),[E,T]=d.useState([]),[F,U]=d.useState([]),[D,R]=d.useState(null),[I,k]=d.useState(null),v=d.useRef(null),[P,O]=d.useState(null),[V,W]=d.useState(!1),{companyId:h,projectId:p}=Z(),L=r=>{const a=r.target.files[0];if(R(a),a){const t=URL.createObjectURL(a);k(t)}},B=()=>{R(null),k(null),v.current&&(v.current.value="")},u=r=>{const{name:a,value:t}=r.target;f({...s,[a]:t}),a==="username"&&t&&_(t)},_=async r=>{try{const t=await(await fetch(`${x}/check-user-exists?username=${encodeURIComponent(r)}`)).json();if(t.exists&&t.user){const l={name:t.user.name||"",phone:t.user.phone||"",address:t.user.address||"",city:t.user.city||"",postalCode:t.user.postalCode||"",startDate:t.user.startDate||"",cvr:t.user.cvr||"",contactPerson:t.user.contactPerson||"",contactPhone:t.user.contactPhone||""};if(O(l),W(!0),f(c=>({...c,name:t.user.name||c.name,phone:t.user.phone||c.phone,address:t.user.address||c.address,city:t.user.city||c.city,postalCode:t.user.postalCode||c.postalCode,startDate:t.user.startDate||c.startDate,cvr:t.user.cvr||c.cvr,contactPerson:t.user.contactPerson||c.contactPerson,contactPhone:t.user.contactPhone||c.contactPhone})),t.user.picture){const c=t.user.picture.startsWith("http")?t.user.picture:`${x.replace("/api","")}/uploads/${t.user.picture}`;g(c)}alert(`User with email ${r} already exists. Form has been auto-filled with existing details. You can modify any fields as needed.`)}}catch(a){console.error("Error checking user existence:",a)}},H=()=>{if(!V||!P)return!1;const r={name:s.name,phone:s.phone,address:s.address,city:s.city,postalCode:s.postalCode,startDate:s.startDate,cvr:s.cvr,contactPerson:s.contactPerson,contactPhone:s.contactPhone};return Object.keys(P).some(a=>P[a]!==r[a])},z=r=>{const a=r.target.files[0];if(S(a),a){const t=URL.createObjectURL(a);g(t)}},J=async r=>{if(r.preventDefault(),!h){alert("You must select company"),y("/dashboard/companies");return}if(H()){if(!window.confirm("Are you sure you want to edit the basic details of the existing user? This will modify the original user's information across all documents."))return;try{const t={name:s.name,phone:s.phone,address:s.address,city:s.city,postalCode:s.postalCode,startDate:s.startDate,cvr:s.cvr,contactPerson:s.contactPerson,contactPhone:s.contactPhone},l=await fetch(`${x}/update-existing-user`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s.username,updatedData:t})});if(l.ok){const c=await l.json();alert(`User information updated successfully across ${c.totalDocumentsUpdated} documents!`)}else{alert("Failed to update existing user. Please try again.");return}}catch(t){console.error("Error updating existing user:",t),alert("Error updating existing user. Please try again.");return}}N(!0);try{const a=new FormData;Object.keys(s).forEach(l=>{a.append(l,s[l])}),w&&a.append("picture",w),D&&a.append("contactPicture",D),a.append("companyId",h),a.append("projectsId",p);const t=await fetch(`${x}/store-user`,{method:"POST",body:a});if(t.ok){const l=await t.json();y(`/dashboard/companies/view/${h}`,{state:{success:"Advisor added successfully!"}})}else console.error("Error:",t.statusText)}catch(a){console.error("Fetch error:",a)}N(!1)},M=r=>{s[r.target.name]=r.target.value,f({...s})},Y=()=>{S(null),g(null),b.current&&(b.current.value="")};d.useEffect(()=>{h&&p&&q()},[h,p]);const q=async()=>{try{const a=await(await fetch(`${x}/get-advisors?companyId=${h}`)).json(),l=await(await fetch(`${x}/get-advisors?companyId=${h}&projectId=${p}`)).json(),c=a.filter(K=>!l.some(Q=>Q._id===K._id));T(c)}catch(r){console.error("Error fetching workers:",r)}},G=async()=>{try{if(!p)return;const a={userIds:F.map(l=>l._id),projectId:p},t=await fetch(`${x}/updateUser`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(t.ok){const l=await t.json();y(`/dashboard/companies/view/${h}/projects/view/${p}`,{state:{success:"Advisor added successfully!"}})}else console.error("Error:",t.statusText)}catch(r){console.log("Error adding Advisor to project:",r)}};return e.jsxs(e.Fragment,{children:[e.jsx(te,{title:"Add Advisor"}),!p&&e.jsx("form",{onSubmit:J,children:e.jsx(o,{className:"justify-content-center",children:e.jsx(n,{children:e.jsx(ee,{title:"Add Advisor",children:e.jsxs(o,{children:[e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Email"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.username,onChange:u,name:"username",type:"email",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Name"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.name,onChange:u,name:"name",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Phone"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.phone,onChange:u,name:"phone",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Address"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.address,onChange:u,name:"address",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"City"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.city,onChange:u,name:"city",type:"text",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Post Code"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.postalCode,onChange:u,name:"postalCode",type:"number",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Start Date"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.startDate,onChange:u,name:"startDate",type:"date",defaultValue:"",id:"example-text-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{className:"col-sm-2 col-form-label text-end",children:"Select Type"}),e.jsx(n,{sm:"10",children:e.jsxs(se,{value:s.type,name:"type",onChange:M,children:[e.jsx("option",{defaultValue:"",children:"Select Type"}),e.jsx("option",{value:"Architecture",children:"Architecture"}),e.jsx("option",{value:"Engineer",children:"Engineer"}),e.jsx("option",{value:"Fire",children:"Fire"}),e.jsx("option",{value:"Acoustics",children:"Acoustics"}),e.jsx("option",{value:"Technical Subject",children:"Technical Subject"})]})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{className:"col-sm-2 col-form-label text-end",children:"CVR. NR."}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.cvr,onChange:u,name:"cvr",type:"text",id:"cvr-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{className:"col-sm-2 col-form-label text-end",children:"Contact Person"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.contactPerson,onChange:u,name:"contactPerson",type:"text",id:"contact-person-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{className:"col-sm-2 col-form-label text-end",children:"Phone (Contact)"}),e.jsx(n,{sm:"10",children:e.jsx(m,{value:s.contactPhone,onChange:u,name:"contactPhone",type:"text",id:"contact-phone-input"})})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Picture"}),e.jsxs(n,{sm:"10",children:[e.jsx(m,{type:"file",id:"file-input",name:"picture",onChange:z,accept:"image/*",ref:b}),A&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx($,{src:A,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(j,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:Y,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]})]})]})}),e.jsx(n,{lg:"6",children:e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{className:"col-sm-2 col-form-label text-end",children:"Picture (Contact)"}),e.jsxs(n,{sm:"10",children:[e.jsx(m,{type:"file",id:"contact-picture-input",name:"contactPicture",onChange:L,accept:"image/*",ref:v}),I&&e.jsxs("div",{className:"mt-3 position-relative",children:[e.jsx($,{src:I,alt:"Preview",fluid:!0,rounded:!0,style:{maxWidth:"200px",maxHeight:"200px"}}),e.jsx(j,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:B,style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]})]})]})}),e.jsx(o,{className:"mb-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(j,{disabled:C,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})}),p&&e.jsxs(o,{className:"mb-3",children:[e.jsx(i,{htmlFor:"file-input",className:"col-sm-2 col-form-label text-end",children:"Select Advisor for this Project"}),e.jsxs(n,{sm:"10",children:[e.jsx(ae,{multiple:!0,options:E,getOptionLabel:r=>r.name,value:F,onChange:(r,a)=>{U(a)},renderInput:r=>e.jsx(re,{...r,variant:"outlined",placeholder:"Search and select Advisor..."}),renderTags:(r,a)=>r.map((t,l)=>e.jsx(ne,{label:t.name,...a({index:l})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}}),e.jsx(o,{className:"mb-3 mt-3 d-flex justify-content-center",children:e.jsx(n,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(j,{disabled:C,type:"submit",variant:"primary",className:"me-1",onClick:G,children:"Submit"})})})]})]})]})};export{Ce as default};
