import{r as c,a as be,c as Ne,b as ye,j as e,R as p,C as o}from"./index-CEbbE1Sf.js";import{C as ve}from"./ComponentContainerCard-BpYspYtC.js";import{P as Se}from"./PageMetaData-qE4R9bbS.js";import{B as h}from"./urls-CvG9cD6N.js";import{D as Ce,P as Pe}from"./page-CBT_MneI.js";import{F as u}from"./FormLabel-WQTNbj7P.js";import{F as b}from"./FormControl-DFJ9Ydzw.js";import{A as N,C as y,T as v}from"./TextField-CeDJPKh1.js";import{I as P}from"./Image-ULHo9GWi.js";import{B as M}from"./Button-CWQV4UHt.js";import"./Card-mt6mV6AB.js";import"./divWithClassName-CT9nWrpT.js";import"./Modal-C5567GrF.js";import"./useWindow-Bj2vCJZa.js";import"./useEventCallback-C6szz9nn.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-PrPCoCM2.js";import"./FormRange-MzNiwPri.js";import"./FormContext-CSwRqVJr.js";import"./PDFButton-m7iMGlez.js";import"./Alert-DHIJxZou.js";import"./hook-CyH9mnqt.js";import"./Anchor-BXgEd0Ob.js";import"./useFormControl-BPpZZpE7.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const $e={comment:"",profession:null,selectBuildingParts:null,selectedDrawing:null,projectManager:null,independentController:null,worker:null,selectedType:null},es=()=>{var V,q;const[a,S]=c.useState($e),K=be(),[C,E]=c.useState([]),[Q,X]=c.useState(10),{setLoading:z}=Ne(),[D,T]=c.useState([]),[k,W]=c.useState([]),[Y,Z]=c.useState([]),[ee,se]=c.useState([]),[te,ne]=c.useState([]),[g,L]=c.useState({show:!1,imgUrl:null}),[U,ae]=c.useState(null),[m,F]=c.useState({show:!1,pdfFile:null,name:null}),[J,re]=c.useState({}),[B,le]=c.useState({}),[oe,ie]=c.useState([]),[ce,de]=c.useState([]),[pe,me]=c.useState([]),[f,O]=c.useState([]),[$,_]=c.useState([]),R=c.useRef(null),{companyId:j,projectId:w}=ye(),ue=c.useRef(),he=t=>{const{name:s,value:r}=t.target;S({...a,[s]:r})},A=(t,s)=>{S({...a,projectManager:t==="projectManager"?s:null,independentController:t==="independentController"?s:null,worker:t==="worker"?s:null,selectedType:s?t:null})},H=(t,s)=>{const r=[...f];r[t]||(r[t]=[]),r[t]=[...r[t],...s],O(r)},G=(t,s)=>{const r=[...f];r[t]&&(r[t]=r[t].filter((n,i)=>i!==s),O(r))},I=(t,s,r)=>{const n=[...$];n[t]||(n[t]=[]),n[t][s]||(n[t][s]=""),n[t][s]=r,_(n)};c.useEffect(()=>{const t=async()=>{try{const x=(await(await fetch(`${h}/get-gammas?companyId=${j}&projectId=${w}`)).json()).map(we=>we.profession);Z(x)}catch(l){console.error("Error fetching professions:",l)}},s=async()=>{try{const d=await(await fetch(`${h}/get-draws?companyId=${j}&projectId=${w}`)).json();ne(d)}catch(l){console.error("Error fetching workers:",l)}},r=async()=>{try{const d=await(await fetch(`${h}/get-project-managers?companyId=${j}&projectId=${w}`)).json();ie(d)}catch(l){console.error("Error fetching project managers:",l)}},n=async()=>{try{const d=await(await fetch(`${h}/get-independent-controllers?companyId=${j}&projectId=${w}`)).json();de(d)}catch(l){console.error("Error fetching independent controllers:",l)}},i=async()=>{try{const d=await(await fetch(`${h}/get-workers?companyId=${j}&projectId=${w}`)).json();me(d)}catch(l){console.error("Error fetching workers:",l)}};t(),s(),r(),n(),i()},[]);const fe=async()=>{var t;try{const s=`${h}/get-parts?SubjectMatterId=${(t=a==null?void 0:a.profession)==null?void 0:t.SubjectMatterId}`,n=await(await fetch(s)).json();se(n)}catch(s){console.log(s)}};c.useEffect(()=>{a.profession&&fe()},[a.profession]);const xe=t=>{const s=Array.from(t.target.files),r=[...D,...s],n=[...k,...s.map(i=>URL.createObjectURL(i))];T(r),W(n)},ge=t=>{const s=D.filter((i,l)=>l!==t),r=k.filter((i,l)=>l!==t);T(s),W(r);const n=new DataTransfer;s.forEach(i=>n.items.add(i)),R.current&&(R.current.files=n.files)},je=async t=>{t.preventDefault();try{z(!0);const s=new FormData;s.append("companyId",j),s.append("projectId",w),s.append("type",a.selectedType||""),s.append("comment",a.comment),s.append("profession",JSON.stringify(a.profession)),s.append("buildingParts",JSON.stringify(a.selectBuildingParts)),s.append("drawing",JSON.stringify(a.selectedDrawing)),s.append("projectManager",JSON.stringify(a.projectManager)),s.append("independentController",JSON.stringify(a.independentController)),s.append("worker",JSON.stringify(a.worker)),s.append("selectedType",a.selectedType||""),s.append("createdAt",new Date().toISOString()),s.append("markPictures",JSON.stringify(f)),s.append("markDescriptions",JSON.stringify($)),s.append("markers",JSON.stringify(C)),s.append("annotatedImages",JSON.stringify(J)),s.append("annotatedImagePNGs",JSON.stringify(B)),U&&s.append("annotatedImage",U),D.forEach(n=>{s.append("pictures",n)}),f.forEach((n,i)=>{n&&n.length>0&&n.forEach((l,d)=>{s.append(`markPictures_${i}_${d}`,l)})}),Object.entries(J).forEach(([n,i])=>{if(i){const x=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;s.append("annotatedPdfs",i,x)}}),Object.entries(B).forEach(([n,i])=>{if(i){const x=`${n.replace(/[^-\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}_annotated.png`;s.append("annotatedPdfImages",i,x)}});const r=await fetch(`${h}/store-special-control`,{method:"POST",body:s});if(r.ok)K(`/dashboard/companies/view/${j}/projects/view/${w}`);else{const n=await r.json();alert(`Error: ${n.message||"Failed to update task."}`)}}catch(s){console.error("Fetch error:",s)}finally{z(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(Se,{title:"Add Special Control"}),e.jsx("form",{onSubmit:je,children:e.jsx(p,{className:"justify-content-center",children:e.jsx(o,{children:e.jsx(ve,{title:"Add Special Contro",children:e.jsxs(p,{children:[e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(o,{sm:"10",children:e.jsx(b,{value:a.comment,onChange:he,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(o,{sm:"10",children:e.jsx(N,{multiple:!1,options:Y,getOptionLabel:t=>t.GroupName,value:a.profession??null,onChange:(t,s)=>{S({...a,profession:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(t,s)=>t.map((r,n)=>e.jsx(y,{label:r.GroupName,...s({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),e.jsx(o,{sm:"10",children:e.jsx(N,{multiple:!1,options:ee,getOptionLabel:t=>t.name,value:a.selectBuildingParts,onChange:(t,s)=>{S({...a,selectBuildingParts:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(t,s)=>t.map((r,n)=>e.jsx(y,{label:r.name,...s({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(o,{sm:"10",children:e.jsx(N,{multiple:!1,options:te,getOptionLabel:t=>t.original||t.name||"Unknown",value:a==null?void 0:a.selectedDrawing,onChange:(t,s)=>{S({...a,selectedDrawing:s})},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t?[e.jsx(y,{label:t.original||t.name||"Unknown",...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Project Manager"}),e.jsx(o,{sm:"10",children:e.jsx(N,{multiple:!1,options:oe,getOptionLabel:t=>t.name||t.email||"Unknown",value:a.projectManager,onChange:(t,s)=>{A("projectManager",s)},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Select project manager..."}),renderTags:(t,s)=>t?[e.jsx(y,{label:t.name||t.email,...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Independent Controller"}),e.jsx(o,{sm:"10",children:e.jsx(N,{multiple:!1,options:ce,getOptionLabel:t=>t.name||t.email||"Unknown",value:a.independentController,onChange:(t,s)=>{A("independentController",s)},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Select independent controller..."}),renderTags:(t,s)=>t?[e.jsx(y,{label:t.name||t.email,...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Worker"}),e.jsx(o,{sm:"10",children:e.jsx(N,{multiple:!1,options:pe,getOptionLabel:t=>t.name||t.email||"Unknown",value:a.worker,onChange:(t,s)=>{A("worker",s)},renderInput:t=>e.jsx(v,{...t,variant:"outlined",placeholder:"Select worker..."}),renderTags:(t,s)=>t?[e.jsx(y,{label:t.name||t.email,...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsx(o,{lg:"12",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Main Drawing"}),e.jsx(o,{sm:"10",children:e.jsx("div",{className:"d-flex flex-wrap",children:(V=a.selectedDrawing.mainDrawings)==null?void 0:V.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[t.stored.endsWith(".pdf")?e.jsxs("div",{className:"border rounded d-flex flex-column align-items-center justify-content-center",onClick:()=>{F({show:!0,pdfFile:`${h}/uploads/${t.stored}`,name:t.original})},style:{width:"150px",height:"150px",cursor:"pointer",backgroundColor:"#f8f9fa"},children:[e.jsx("i",{className:"fas fa-file-pdf text-danger",style:{fontSize:"2rem"}}),e.jsx("small",{className:"text-muted mt-2",children:"PDF Drawing"})]}):e.jsx(P,{src:`${h}/uploads/${t.stored}`,onClick:()=>{L({show:!0,imgUrl:`${h}/uploads/${t.stored}`})},alt:`Main Drawing ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"150px",maxHeight:"150px",cursor:"pointer"}}),e.jsxs("div",{className:"text-center mt-1",children:[e.jsx("small",{className:"text-muted",children:"Click to mark"}),e.jsx("div",{className:"text-muted",style:{fontSize:"10px"},children:t.original})]})]},`main-${s}`))})})]})}),((q=a==null?void 0:a.selectedDrawing)==null?void 0:q.childDrawings)&&a.selectedDrawing.childDrawings.length>0&&e.jsx(o,{lg:"12",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Child Drawings"}),e.jsx(o,{sm:"10",children:e.jsx("div",{className:"d-flex flex-wrap",children:a.selectedDrawing.childDrawings.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[t.stored.endsWith(".pdf")?e.jsxs("div",{className:"border rounded d-flex flex-column align-items-center justify-content-center",style:{width:"100px",height:"100px",backgroundColor:"#f8f9fa"},children:[e.jsx("i",{className:"fas fa-file-pdf text-danger",style:{fontSize:"1.5rem"}}),e.jsx("small",{className:"text-muted mt-1",style:{fontSize:"8px"},children:"PDF"})]}):e.jsx(P,{src:`${h}/uploads/${t.stored}`,alt:`Child Drawing ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx("div",{className:"text-center mt-1",children:e.jsx("div",{className:"text-muted",style:{fontSize:"10px"},children:t.original})})]},`child-${s}`))})})]})}),(g==null?void 0:g.show)&&e.jsx(o,{lg:"12",children:e.jsxs(p,{children:[e.jsx(o,{lg:"6",children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(Ce,{ref:ue,drawDotsOnImage:g,setDrawDotsAnImage:L,onSave:t=>{ae(t)},setMarkers:E,markers:C,dotSize:Q,setDotSize:X})})}),e.jsx(o,{lg:"6",children:e.jsxs("div",{className:"border p-3 rounded",children:[e.jsx("h6",{children:"Mark Pictures & Descriptions"}),C.map((t,s)=>e.jsxs("div",{className:"mb-3 p-2 border rounded",children:[e.jsxs("h6",{className:"text-primary",children:["Mark ",s+1]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:["Pictures for Mark ",s+1]}),e.jsx(b,{type:"file",accept:"image/*",multiple:!0,onChange:r=>{const n=Array.from(r.target.files);H(s,n)}})]}),f[s]&&f[s].length>0&&e.jsx("div",{className:"mb-2",children:e.jsx("div",{className:"d-flex flex-wrap",children:f[s].map((r,n)=>{var i;return e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(P,{src:URL.createObjectURL(r),alt:`Mark ${s+1} - Picture ${n+1}`,fluid:!0,rounded:!0,style:{maxWidth:"80px",maxHeight:"80px"}}),e.jsx(M,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>G(s,n),style:{transform:"translate(50%, -50%)",borderRadius:"50%",width:"20px",height:"20px",fontSize:"12px",padding:"0"},children:"×"}),e.jsx("div",{className:"mt-1",children:e.jsx(b,{as:"textarea",rows:2,placeholder:`Description for picture ${n+1}`,value:((i=$[s])==null?void 0:i[n])||"",onChange:l=>I(s,n,l.target.value),style:{fontSize:"12px",minHeight:"40px"}})})]},n)})})})]},s))]})})]})}),(m==null?void 0:m.show)&&e.jsx(Pe,{pdfUrl:m.pdfFile,onClose:()=>F({show:!1,pdfFile:null}),onSave:async(t,s,r)=>{const n=Array.from({length:s},(d,x)=>({x:0,y:0}));E(n);const i=Array.from({length:s},()=>[]),l=Array.from({length:s},()=>[]);if(O(i),_(l),re(d=>({...d,[m.name.endsWith(".png")?m.name:`${m.name}.png`]:t})),typeof r=="function"){const d=await r();le(x=>({...x,[m.name.endsWith(".png")?m.name:`${m.name}.png`]:d}))}F({show:!1,pdfFile:null})}}),C.length>0&&!(g!=null&&g.show)&&!(m!=null&&m.show)&&e.jsx(o,{lg:"12",children:e.jsxs("div",{className:"border p-3 rounded mb-3",children:[e.jsx("h6",{children:"Mark Pictures & Descriptions"}),C.map((t,s)=>e.jsxs("div",{className:"mb-3 p-2 border rounded",children:[e.jsxs("h6",{className:"text-primary",children:["Mark ",s+1]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:["Pictures for Mark ",s+1]}),e.jsx(b,{type:"file",accept:"image/*",multiple:!0,onChange:r=>{const n=Array.from(r.target.files);H(s,n)}})]}),f[s]&&f[s].length>0&&e.jsx("div",{className:"mb-2",children:e.jsx("div",{className:"d-flex flex-wrap",children:f[s].map((r,n)=>{var i;return e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(P,{src:URL.createObjectURL(r),alt:`Mark ${s+1} - Picture ${n+1}`,fluid:!0,rounded:!0,style:{maxWidth:"80px",maxHeight:"80px"}}),e.jsx(M,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>G(s,n),style:{transform:"translate(50%, -50%)",borderRadius:"50%",width:"20px",height:"20px",fontSize:"12px",padding:"0"},children:"×"}),e.jsx("div",{className:"mt-1",children:e.jsx(b,{as:"textarea",rows:2,placeholder:`Description for picture ${n+1}`,value:((i=$[s])==null?void 0:i[n])||"",onChange:l=>I(s,n,l.target.value),style:{fontSize:"12px",minHeight:"40px"}})})]},n)})})})]},s))]})}),e.jsx(o,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(u,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(o,{sm:"10",children:[e.jsx(b,{type:"file",id:"multiple-file-input",name:"pictures",onChange:xe,accept:"image/*",multiple:!0,ref:R}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:k.map((t,s)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(P,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(M,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ge(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},s))})]})]})}),e.jsx(p,{className:"mb-3 d-flex justify-content-center",children:e.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(M,{disabled:!(a!=null&&a.profession),type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{es as default};
