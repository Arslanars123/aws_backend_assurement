import{r as l,a as fe,b as xe,j as e,R as d,C as i}from"./index-BMHGnWcK.js";import{C as je}from"./ComponentContainerCard-DqzcDgtW.js";import{P as be}from"./PageMetaData-Bgn24qMg.js";import{B as g}from"./urls-CvG9cD6N.js";import{P as we}from"./page-XNENPzep.js";import{F as p}from"./FormLabel-BBJljh0R.js";import{F as ve}from"./FormSelect-Dr1VIvZ_.js";import{A as w,C as v,T as m}from"./TextField-CiuEKT8f.js";import{B as S}from"./Button-Dwvyfso6.js";import{I as T}from"./Image-BWlBzfxc.js";import{F as ye}from"./FormControl-BhCdWsRE.js";import"./Card-BQIi55Il.js";import"./divWithClassName-BnTSImTn.js";import"./Modal-BvTxh5Lm.js";import"./useWindow-X1vIdSxZ.js";import"./useEventCallback-aoYRPbpt.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-Cvueq9hZ.js";import"./FormRange-BUeztKfe.js";import"./FormContext-_pJuLZf_.js";import"./PDFButton-DD11AT0P.js";import"./Alert-BSTIsewH.js";import"./hook-ShtcephR.js";import"./Anchor-BpTvChcP.js";import"./useFormControl-78CrNPlx.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Se={item:null,selectedDrawing:null,projectUsers:null,projectManager:null,comment:null,profession:null,buildingPart:null,selectedWorkers:null},ss=()=>{var R,U;const[a,u]=l.useState(Se),[O,$]=l.useState(!1),[L,z]=l.useState([]),[_,B]=l.useState([]),J=fe(),{companyId:f,projectId:x}=xe(),[j,N]=l.useState([]),[y,F]=l.useState([]),[b,P]=l.useState([]),[k,A]=l.useState([]),[G,q]=l.useState([]),W=l.useRef(null),[h,C]=l.useState({show:!1,pdfFile:null,name:null}),[E,V]=l.useState({}),[H,K]=l.useState({}),[D,Q]=l.useState(0),[Ne,Pe]=l.useState({}),[ke,Ce]=l.useState(10),[X,Y]=l.useState([]),[Z,ee]=l.useState([]),[se,te]=l.useState([]),ne=async()=>{try{const t=await(await fetch(`${g}/get-company-professions?companyId=${f}&projectId=${x}`)).json();Y(t)}catch(s){console.error("Error fetching professions:",s)}},ae=async()=>{var s;try{const t=`${g}/get-parts?SubjectMatterId=${(s=a==null?void 0:a.profession)==null?void 0:s.SubjectMatterId}`,n=await(await fetch(t)).json();ee(n)}catch(t){console.log(t)}},re=async()=>{try{const s={companyId:f,projectId:x,professionsIds:a!=null&&a.profession?[a.profession._id]:[],roles:["Worker"]},r=await(await fetch(`${g}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();te(r)}catch(s){console.error("Error fetching workers:",s)}};l.useEffect(()=>{const s=async()=>{try{const o=await(await fetch(`${g}/get-draws?companyId=${f}&projectId=${x}`)).json();z(o)}catch(n){console.error("Error fetching workers:",n)}},t=async()=>{try{const n=`${g}/get-filter-users`,M=await(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:f,projectId:x})})).json();B(M)}catch(n){console.error("Error fetching users:",n)}};(async()=>{try{const n=`${g}/get-project-managers?companyId=${f}&projectId=${x}`,c=await(await fetch(n)).json();q(c)}catch(n){console.error("Error fetching project managers:",n)}})(),t(),s(),ne()},[]),l.useEffect(()=>{a.profession&&(ae(),re())},[a.profession]);const oe=Z,ie=se,le=s=>{const t=Array.from(s.target.files),r=t.map(c=>({file:c,description:""})),n=[...j,...r],o=[...y,...t.map(c=>URL.createObjectURL(c))];N(n),F(o)},ce=s=>{const t=j.filter((n,o)=>o!==s),r=y.filter((n,o)=>o!==s);N(t),F(r)},de=s=>{const{name:t,value:r}=s.target;u({...a,[t]:r})},pe=(s,t)=>{const r=[...j];r[s].description=t,N(r)},me=(s,t)=>{const r=Array.from(s.target.files);if(r.length>0){const n=[...b];r.forEach(c=>{n.push({file:c,description:"",markNumber:t})}),P(n);const o=[...k];r.forEach(c=>{o.push(URL.createObjectURL(c))}),A(o)}},ue=s=>{const t=b.filter((n,o)=>o!==s);P(t);const r=k.filter((n,o)=>o!==s);A(r)},he=(s,t)=>{const r=[...b];r[s].description=t,P(r)},ge=async s=>{s.preventDefault(),$(!0);try{const t=new FormData;t.append("companyId",f),t.append("projectsId",x),t.append("comment",a.comment),t.append("item",a.item),t.append("projectUsers",JSON.stringify(a.projectUsers)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("drawing",JSON.stringify(a.selectedDrawing)),t.append("profession",JSON.stringify(a.profession)),t.append("buildingPart",JSON.stringify(a.buildingPart)),t.append("selectedWorkers",JSON.stringify(a.selectedWorkers)),j.length>0&&j.forEach((n,o)=>{n.file&&(t.append("pictures",n.file),t.append("pictureDescriptions",n.description||""),t.append("pictureCreatedDates",new Date().toISOString()))}),b.length>0&&b.forEach((n,o)=>{var c;n.file&&(t.append("markPictures",n.file),t.append("markPictureDescriptions",n.description||""),t.append("markPictureCreatedDates",new Date().toISOString()),t.append("markNumbers",((c=n.markNumber)==null?void 0:c.toString())||""))}),Object.entries(E).forEach(([n,o])=>{const I=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",o,I)}),Object.entries(H).forEach(([n,o])=>{if(o){const I=`${n.replace(/[^-\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}_annotated.png`;t.append("annotatedPdfImages",o,I)}});const r=await fetch(`${g}/store-mention`,{method:"POST",body:t});r.ok?J(`/dashboard/companies/view/${f}/projects/view/${x}`):console.error("Error:",r.statusText)}catch(t){console.error("Fetch error:",t)}$(!1)};return console.log("annotatedImages",E),e.jsxs(e.Fragment,{children:[e.jsx(be,{title:"Add Safety Mention"}),e.jsx("form",{onSubmit:ge,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(je,{title:"Add Safety Mention",children:e.jsxs(d,{children:[e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(i,{sm:"10",children:e.jsxs(ve,{value:a.item,name:"item",onChange:de,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Work has stopped",children:"Work has stopped"}),e.jsx("option",{value:"Shielding is missing here",children:"Shielding is missing here"}),e.jsx("option",{value:"A safety hazard",children:"A safety hazard"}),e.jsx("option",{value:"Lacks cleanup",children:"Lacks cleanup"}),e.jsx("option",{value:"Security shielding inhibits my work",children:"Security shielding inhibits my work"}),e.jsx("option",{value:"Scaffolding is not done appropriately",children:"Scaffolding is not done appropriately"})]})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Profession"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:X,getOptionLabel:s=>s.GroupName,value:a==null?void 0:a.profession,onChange:(s,t)=>{u({...a,profession:t,buildingPart:null,selectedWorkers:null})},renderInput:s=>e.jsx(m,{...s,variant:"outlined",placeholder:"Select Profession..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(v,{label:r.GroupName,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Building Part"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:oe,getOptionLabel:s=>String(s.name),value:a==null?void 0:a.buildingPart,onChange:(s,t)=>{u({...a,buildingPart:t,selectedWorkers:null})},renderInput:s=>e.jsx(m,{...s,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(v,{label:String(r.name),...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Select Workers"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!0,options:ie,getOptionLabel:s=>s.name,value:(a==null?void 0:a.selectedWorkers)||[],onChange:(s,t)=>{u({...a,selectedWorkers:t})},renderInput:s=>e.jsx(m,{...s,variant:"outlined",placeholder:"Select Workers..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(v,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:_,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectUsers,onChange:(s,t)=>{u({...a,projectUsers:t})},renderInput:s=>e.jsx(m,{...s,variant:"outlined",placeholder:"search and select the receiver ..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(v,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:G,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{u({...a,projectManager:t})},renderInput:s=>e.jsx(m,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(v,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(m,{variant:"outlined",placeholder:"Add some comments...",value:a==null?void 0:a.comment,onChange:s=>{var t;u({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(w,{multiple:!1,options:L,getOptionLabel:s=>s.name?s.name:s.mainDrawings&&s.mainDrawings.length>0&&s.mainDrawings[0].original||"No name available",value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{u({...a,selectedDrawing:t})},renderInput:s=>e.jsx(m,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((r,n)=>{const o=r.name||(r.mainDrawings&&r.mainDrawings.length>0?r.mainDrawings[0].original:"No name available");return e.jsx(v,{label:o,...t({index:n})})}),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(U=(R=a==null?void 0:a.selectedDrawing)==null?void 0:R.mainDrawings)==null?void 0:U.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=s.original;C({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),e.jsx(i,{lg:"12",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(p,{className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsx(i,{sm:"10",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-muted mb-3",children:"Upload general pictures for this submission. Each picture can have its own description."}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:le,ref:W,style:{display:"none"}}),e.jsx(S,{type:"button",variant:"outline-primary",onClick:()=>W.current.click(),className:"mb-3",children:"Upload Pictures"}),y.length>0&&e.jsx("div",{className:"d-flex flex-wrap",children:y.map((s,t)=>{var r;return e.jsxs("div",{className:"me-3 mb-3 position-relative",children:[e.jsx(T,{src:s,alt:`Preview ${t+1}`,style:{width:"100px",height:"100px",objectFit:"cover"}}),e.jsx(S,{type:"button",variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ce(t),children:"×"}),e.jsx(m,{variant:"outlined",placeholder:"Description...",value:((r=j[t])==null?void 0:r.description)||"",onChange:n=>pe(t,n.target.value),size:"small",className:"mt-1",fullWidth:!0})]},t)})})]})})]})}),D>0&&e.jsx(i,{lg:"12",children:e.jsxs(d,{className:"mb-3",children:[e.jsxs(p,{className:"col-sm-2 col-form-label text-end",children:["PDF Marked Pictures (",D,")"]}),e.jsx(i,{sm:"10",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-muted mb-3",children:"Upload pictures for each mark you placed on the PDF. Each picture can have its own description."}),Array.from({length:D}).map((s,t)=>e.jsxs("div",{className:"mb-4 p-3 border rounded",children:[e.jsxs("h6",{className:"mb-2",children:["📌 Mark #",t+1," Pictures"]}),e.jsx(ye,{type:"file",name:`mark-pictures-${t+1}`,onChange:r=>me(r,t+1),accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:b.map((r,n)=>{if(r.markNumber===t+1){const o=k[n];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(T,{src:o,alt:`Mark Picture ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(m,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:c=>he(n,c.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(S,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ue(n),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},n)}return null})})]},t))]})})]})}),e.jsx(i,{lg:"12",className:"d-flex justify-content-end",children:e.jsx(S,{type:"submit",variant:"primary",disabled:O,children:O?"Submitting...":"Submit"})})]})})})})}),h.show&&e.jsx(we,{pdfUrl:h.pdfFile,onClose:()=>C({show:!1,pdfFile:null,name:null}),onSave:async(s,t,r)=>{if(Q(t),V(n=>({...n,[h.name.endsWith(".png")?h.name:`${h.name}.png`]:s})),typeof r=="function"){const n=await r();K(o=>({...o,[h.name.endsWith(".png")?h.name:`${h.name}.png`]:n}))}C({show:!1,pdfFile:null,name:null})}})]})};export{ss as default};
