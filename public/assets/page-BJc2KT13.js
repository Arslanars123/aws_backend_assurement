import{r as o,a as Ie,b as Ce,j as e,R as m,C as i}from"./index-CEbbE1Sf.js";import{C as $e}from"./ComponentContainerCard-BpYspYtC.js";import{P as Ae}from"./PageMetaData-qE4R9bbS.js";import{B as g}from"./urls-CvG9cD6N.js";import{P as Fe,D as Me}from"./page-CBT_MneI.js";import{F as u}from"./FormLabel-WQTNbj7P.js";import{F as y}from"./FormControl-DFJ9Ydzw.js";import{A as b,C as v,T as P}from"./TextField-CeDJPKh1.js";import{I as Q}from"./Image-ULHo9GWi.js";import{B as M}from"./Button-CWQV4UHt.js";import"./Card-mt6mV6AB.js";import"./divWithClassName-CT9nWrpT.js";import"./Modal-C5567GrF.js";import"./useWindow-Bj2vCJZa.js";import"./useEventCallback-C6szz9nn.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-PrPCoCM2.js";import"./FormRange-MzNiwPri.js";import"./FormContext-CSwRqVJr.js";import"./PDFButton-m7iMGlez.js";import"./Alert-DHIJxZou.js";import"./hook-CyH9mnqt.js";import"./Anchor-BXgEd0Ob.js";import"./useFormControl-BPpZZpE7.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Oe={comment:"",profession:null,selectBuildingParts:null,selectedDrawing:null,selectedWorker:null,selectedIndependentController:null,selectedProjectManager:null},cs=({type:q})=>{var J,_,Y,H;const[r,x]=o.useState(Oe),[V,O]=o.useState(!1),R=Ie(),[K,X]=o.useState([]),[j,I]=o.useState({show:!1,pdfFile:null}),[S,E]=o.useState([]),[C,W]=o.useState([]),[k,$]=o.useState({}),[A,L]=o.useState([]),[N,T]=o.useState([]),[Z,ee]=o.useState([]),[se,te]=o.useState([]),[re,ae]=o.useState([]),[ne,oe]=o.useState([]),[le,ie]=o.useState([]),[ce,de]=o.useState([]),[D,pe]=o.useState({show:!1,imgUrl:null}),[me,ue]=o.useState(10),[B,fe]=o.useState(null),F=o.useRef(null),{companyId:f,projectId:h}=Ce(),he=o.useRef();o.useRef();const[G,Re]=o.useState(null),[U,Ee]=o.useState(null),[ge,xe]=o.useState({}),[w,je]=o.useState(0),[z,we]=o.useState({}),be=t=>{const{name:s,value:n}=t.target;x({...r,[s]:n})},ve=async()=>{var t;try{const s=`${g}/get-parts?SubjectMatterId=${(t=r==null?void 0:r.profession)==null?void 0:t.SubjectMatterId}`,a=await(await fetch(s)).json();te(a)}catch(s){console.log(s)}},Pe=async()=>{if(r!=null&&r.profession)try{const t=`${g}/get-workers?companyId=${f}&projectId=${h}`;console.log("Fetching workers with URL:",t);const n=await(await fetch(t)).json();console.log("All workers data received:",n);const a=r.profession.GroupName||r.profession.name,l=n.filter(c=>c.userProfession&&Array.isArray(c.userProfession)?c.userProfession.some(d=>d.GroupName===a||d.name===a):!1);console.log("Filtered workers for profession:",a,l),oe(l)}catch(t){console.error("Error fetching workers:",t)}},Ne=async()=>{try{const t=`${g}/get-independent-controller?companyId=${f}&projectId=${h}`,n=await(await fetch(t)).json();ie(n)}catch(t){console.error("Error fetching independent controllers:",t)}},ye=async()=>{try{const t=`${g}/get-project-managers?companyId=${f}&projectId=${h}`,n=await(await fetch(t)).json();de(n)}catch(t){console.error("Error fetching project managers:",t)}};o.useEffect(()=>{r.profession&&(console.log("Profession selected:",r.profession),ve(),Pe())},[r.profession]),o.useEffect(()=>{const t=async()=>{try{const a=await(await fetch(`${g}/get-company-professions?companyId=${f}&projectId=${h}`)).json();ee(a)}catch(n){console.error("Error fetching professions:",n)}},s=async()=>{try{const a=await(await fetch(`${g}/get-draws?companyId=${f}&projectId=${h}`)).json();ae(a)}catch(n){console.error("Error fetching workers:",n)}};t(),s(),Ne(),ye()},[]);const Se=t=>{const s=Array.from(t.target.files),n=[...S,...s],a=[...C],l={...k};s.forEach((c,d)=>{if(c.type.startsWith("image/")){a.push(URL.createObjectURL(c));const p=S.length+d;l[p]=""}}),E(n),W(a),$(l)},ke=t=>{const s=S.filter((d,p)=>p!==t),n=C.filter((d,p)=>p!==t),a={...k};delete a[t];const l={};Object.keys(a).forEach(d=>{const p=parseInt(d);p>t?l[p-1]=a[d]:l[p]=a[d]}),E(s),W(n),$(l);const c=new DataTransfer;s.forEach(d=>c.items.add(d)),F.current&&(F.current.files=c.files)},De=async t=>{if(t.preventDefault(),!(r!=null&&r.profession)){alert("You must select company, project and profession"),R(`/dashboard/companies/view/${f}/projects/view/${h}`);return}O(!0);try{const s=new FormData;s.append("type",q),s.append("companyId",f),s.append("projectId",h),s.append("comment",r.comment),s.append("submittedDate",new Date().toISOString()),s.append("deviationNumber",Math.floor(1e4+Math.random()*9e4).toString()),s.append("profession",JSON.stringify(r.profession)),s.append("buildingParts",JSON.stringify(r.selectBuildingParts)),s.append("drawing",JSON.stringify(r.selectedDrawing)),s.append("selectedWorker",JSON.stringify(r.selectedWorker)),s.append("selectedIndependentController",JSON.stringify(r.selectedIndependentController)),s.append("selectedProjectManager",JSON.stringify(r.selectedProjectManager)),B&&s.append("annotatedImage",B),G&&s.append("originalPdf",G),U&&s.append("annotatedPdf",U,"marked.pdf"),S.forEach((a,l)=>{a&&(s.append("generalPictures",a),s.append("generalPictureDescriptions",k[l]||""))}),w>0&&A.forEach((a,l)=>{a&&Array.isArray(a)&&a.forEach((c,d)=>{c&&(s.append("markPictures",c),s.append("markPictureIndices",JSON.stringify({markIndex:l,pictureIndex:d})),s.append("markPictureDescriptions",z[l]||""))})}),Object.entries(ge).forEach(([a,l])=>{const p=`${a.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;s.append("annotatedPdfs",l,p)});const n=await fetch(`${g}/store-deviation`,{method:"POST",body:s});if(n.ok)R(`/dashboard/companies/view/${f}/projects/view/${h}`);else{const a=await n.json();alert(`Error: ${a.message||"Failed to update task."}`)}}catch(s){console.error("Fetch error:",s)}O(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(Ae,{title:"Add Deviation In Quality Assurance"}),e.jsx("form",{onSubmit:De,children:e.jsx(m,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx($e,{title:"Add Deviation In Quality Assurance",children:e.jsxs(m,{children:[e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(i,{sm:"10",children:e.jsx(y,{value:r.comment,onChange:be,name:"comment",type:"text",id:"example-text-input"})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Select Profession"}),e.jsx(i,{sm:"10",children:e.jsx(b,{multiple:!1,options:Z,getOptionLabel:t=>t.GroupName,value:r.profession??null,onChange:(t,s)=>{x({...r,profession:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(t,s)=>t.map((n,a)=>e.jsx(v,{label:n.GroupName,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),e.jsx(i,{sm:"10",children:e.jsx(b,{multiple:!1,options:se,getOptionLabel:t=>String(t.name),value:r.selectBuildingParts,onChange:(t,s)=>{x({...r,selectBuildingParts:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(t,s)=>t.map((n,a)=>e.jsx(v,{label:String(n.name),...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(b,{multiple:!1,options:re,getOptionLabel:t=>t.name,value:r==null?void 0:r.selectedDrawing,onChange:(t,s)=>{x({...r,selectedDrawing:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(t,s)=>t.map((n,a)=>e.jsx(v,{label:n.name,...s({index:a})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(r==null?void 0:r.profession)&&e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Select Worker"}),e.jsx(i,{sm:"10",children:e.jsx(b,{multiple:!1,options:ne,getOptionLabel:t=>`${t.name} (${t.email})`,value:r.selectedWorker,onChange:(t,s)=>{x({...r,selectedWorker:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select worker..."}),renderTags:(t,s)=>t?[e.jsx(v,{label:`${t.name} (${t.email})`,...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Independent Controller"}),e.jsx(i,{sm:"10",children:e.jsx(b,{multiple:!1,options:le,getOptionLabel:t=>`${t.name} (${t.email})`,value:r.selectedIndependentController,onChange:(t,s)=>{x({...r,selectedIndependentController:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select independent controller..."}),renderTags:(t,s)=>t?[e.jsx(v,{label:`${t.name} (${t.email})`,...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{className:"col-sm-2 col-form-label text-end",children:"Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(b,{multiple:!1,options:ce,getOptionLabel:t=>`${t.name} (${t.email})`,value:r.selectedProjectManager,onChange:(t,s)=>{x({...r,selectedProjectManager:s})},renderInput:t=>e.jsx(P,{...t,variant:"outlined",placeholder:"Search and select project manager..."}),renderTags:(t,s)=>t?[e.jsx(v,{label:`${t.name} (${t.email})`,...s({index:0})})]:[],sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(r==null?void 0:r.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(_=(J=r==null?void 0:r.selectedDrawing)==null?void 0:J.mainDrawings)==null?void 0:_.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=t.original;I({show:!0,pdfFile:`${g}/uploads/${t.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`main-${s}`))})]}),(j==null?void 0:j.show)&&e.jsx(Fe,{pdfUrl:j.pdfFile,onClose:()=>I({show:!1,pdfFile:null}),onSave:(t,s)=>{je(s),xe(n=>({...n,[j.name.endsWith(".png")?j.name:`${j.name}.png`]:t})),I({show:!1,pdfFile:null})}}),(r==null?void 0:r.selectedDrawing)&&e.jsxs(i,{lg:"12",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(H=(Y=r==null?void 0:r.selectedDrawing)==null?void 0:Y.childDrawings)==null?void 0:H.map((t,s)=>e.jsxs("div",{className:"me-2 mb-2 text-center",children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:t==null?void 0:t.original})]},`child-${s}`))})]}),(r==null?void 0:r.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"PDF Annotation & Marking"}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),e.jsx("strong",{children:"Instructions:"})," Click on any main drawing above to open the PDF annotation tool. You can add marks, annotations, and save the annotated PDF. Each mark will require a corresponding picture with description."]}),w>0&&e.jsxs("div",{className:"alert alert-success",children:[e.jsx("i",{className:"fas fa-check-circle me-2"}),e.jsx("strong",{children:"Annotation Complete:"})," You have added ",w," mark(s) to the PDF. Please upload corresponding pictures for each mark below."]})]}),(D==null?void 0:D.show)&&e.jsx(i,{lg:"6",children:e.jsx(m,{children:e.jsx("div",{className:"position-relative",style:{maxWidth:"100%",height:"auto"},children:e.jsx(Me,{ref:he,drawDotsOnImage:D,setDrawDotsAnImage:pe,onSave:t=>{fe(t)},setMarkers:X,markers:K,dotSize:me,setDotSize:ue})})})}),e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(u,{htmlFor:"general-pictures-input",className:"col-sm-2 col-form-label text-end",children:"General Pictures"}),e.jsxs(i,{sm:"10",children:[e.jsx(y,{type:"file",id:"general-pictures-input",name:"generalPictures",onChange:Se,accept:"image/*",multiple:!0,ref:F}),e.jsx("div",{className:"mt-3",children:C.map((t,s)=>e.jsx("div",{className:"mb-3 p-3 border rounded",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsxs("div",{className:"position-relative me-3",children:[e.jsx(Q,{src:t,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(M,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ke(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx(y,{type:"text",placeholder:"Add description for this picture...",value:k[s]||"",onChange:n=>{$(a=>({...a,[s]:n.target.value}))},className:"mb-2"}),e.jsxs("small",{className:"text-muted",children:["General Picture #",s+1]})]})]})},s))})]})]})}),w>0&&e.jsx(i,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsxs(u,{className:"col-sm-2 col-form-label text-end",children:["Mark Pictures (",w," marks)"]}),e.jsx(i,{sm:"10",children:e.jsx("div",{className:"mb-3",children:Array.from({length:w}).map((t,s)=>e.jsxs("div",{className:"mb-3 p-3 border rounded",children:[e.jsxs("p",{className:"mb-1 fw-bold",children:["Upload picture for mark #",s+1]}),e.jsx(y,{type:"file",id:`mark-${s}-file-input`,name:`mark-${s}-pictures`,onChange:n=>{const a=Array.from(n.target.files),l=[...A];l[s]||(l[s]=[]),l[s]=[...l[s],...a],L(l);const c=[...N];c[s]||(c[s]=[]);const d=a.map(p=>URL.createObjectURL(p));c[s]=[...c[s],...d],T(c)},accept:"image/*",multiple:!0}),e.jsx(y,{type:"text",placeholder:"Add description for mark #${index + 1}...",value:z[s]||"",onChange:n=>{we(a=>({...a,[s]:n.target.value}))},className:"mt-2"}),N[s]&&N[s].length>0&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"d-flex flex-wrap gap-2",children:N[s].map((n,a)=>e.jsxs("div",{className:"position-relative",children:[e.jsx(Q,{src:n,alt:`Mark ${s+1} Picture ${a+1}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(M,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>{const l=[...A],c=[...N];l[s]=l[s].filter((d,p)=>p!==a),c[s]=c[s].filter((d,p)=>p!==a),L(l),T(c)},style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},a))})})]},s))})})]})}),e.jsx(m,{className:"mb-3 d-flex justify-content-center",children:e.jsx(i,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(M,{disabled:V,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{cs as default};
