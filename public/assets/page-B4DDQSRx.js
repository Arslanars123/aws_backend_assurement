import{r as l,G as ee,a as te,b as se,j as t,R as d,C as o}from"./index-CF9SjLWQ.js";import{C as ae}from"./ComponentContainerCard-n9fGDRyA.js";import{B as u}from"./urls-BhGeBsON.js";import{P as ne}from"./page-kGDYU_lm.js";import{F as j}from"./FormLabel-CaO2MFER.js";import{F as T}from"./FormControl-DmgB3XQy.js";import{A as S,C,T as N}from"./TextField-FXpElbHG.js";import{I as re}from"./Image-DGQJ2Jha.js";import{B as U}from"./Button-UcXSk4np.js";import"./Card-Bx1F2r4C.js";import"./divWithClassName-13-QUwjt.js";import"./page-DbZ3f2yu.js";import"./Modal-CQeUVPXG.js";import"./useWindow-BQWBaX9C.js";import"./DataKey-KKZij2X9.js";import"./NoopTransition-BChfWke-.js";import"./FormRange-C_Mxfksa.js";import"./PDFButton-CY5rODRi.js";import"./Alert-DVLUPR3Z.js";import"./Anchor-taqs8bUs.js";import"./useFormControl-Bd5Uj6AV.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const ie={comment:"",selectBuildingParts:null,selectedDrawing:null,selectUser:null};function ke(){var $,O,E,A,B,R;const[n,x]=l.useState(ie),{clickTask:r}=l.useContext(ee),[M,L]=l.useState([]),[z,W]=l.useState([]),v=l.useRef(null),[y,P]=l.useState([]),[f,w]=l.useState([]),D=te(),{companyId:h,projectId:m,taskId:F}=se(),[p,b]=l.useState({show:!1,pdfFile:null,name:null}),[_,I]=l.useState({}),[J,q]=l.useState([]),G=e=>{const{name:s,value:a}=e.target;x({...n,[s]:a})},H=async()=>{try{const s=await(await fetch(`${u}/get-draws?companyId=${h}&projectId=${m}`)).json();L(s)}catch(e){console.error("Error fetching workers:",e)}},k=async()=>{try{const e=`${u}/get-parts?SubjectMatterId=${r==null?void 0:r.SubjectMatterId}`,a=await(await fetch(e)).json();W(a)}catch(e){console.log(e)}},V=async()=>{try{const e=`${u}/get-filter-users`,a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:h,projectId:m,taskId:F,roles:["Sub Contractor","Worker"]})});if(!a.ok)throw new Error("Failed to fetch users");const i=await a.json();q(i)}catch(e){console.error("Error fetching users:",e)}};l.useEffect(()=>{if(r){if(x({comment:r.comment||"",selectBuildingParts:r.buildingParts||null,selectedDrawing:r.drawing||null,selectUser:r.user||null}),r.pictures&&r.pictures.length>0){const e=r.pictures.map(a=>`${u}/uploads/${a}`);P(e);const s=r.pictures.map(a=>({file:null,existingFilename:a,description:""}));w(s)}if(r.annotatedPdfs&&r.annotatedPdfs.length>0){const e={};r.annotatedPdfs.forEach(s=>{e[s.originalName]=null}),I(e)}}},[r]),l.useEffect(()=>{h&&m&&(H(),k(),V())},[h,m]),l.useEffect(()=>{r&&k()},[r]);const K=e=>{const s=Array.from(e.target.files),a=s.map(c=>({file:c,description:""})),i=[...f,...a],g=[...y,...s.map(c=>URL.createObjectURL(c))];w(i),P(g)},Q=e=>{const s=f.filter((g,c)=>c!==e),a=y.filter((g,c)=>c!==e);w(s),P(a);const i=new DataTransfer;s.forEach(g=>i.items.add(g.file)),v.current&&(v.current.files=i.files)},X=(e,s)=>{const a=[...f];a[e].description=s,w(a)},Y=async()=>{if(!h||!m){D("/dashboard/companies");return}if(!n.selectedDrawing||!n.selectBuildingParts){alert("Please select both a drawing and building part.");return}try{const e=new FormData;e.append("comment",n.comment),e.append("projectId",m),e.append("taskId",F),e.append("buildingParts",JSON.stringify(n.selectBuildingParts)),e.append("drawing",JSON.stringify(n.selectedDrawing)),e.append("user",JSON.stringify(n.selectUser)),f.length>0&&f.forEach((a,i)=>{a.file&&(e.append("pictures",a.file),e.append("pictureDescriptions",a.description||""))}),Object.entries(_).forEach(([a,i])=>{if(i){const Z=`${a.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;e.append("annotatedPdfs",i,Z)}});const s=await fetch(`${u}/submit-task`,{method:"POST",body:e});if(s.ok)D(`/dashboard/companies/view/${h}/projects/view/${m}`);else{const a=await s.json();alert(`Error: ${a.message||"Failed to update task."}`)}}catch(e){console.error("Submit error:",e),alert("Something went wrong while submitting the task.")}};return t.jsx(d,{className:"justify-content-center",children:t.jsx(o,{children:t.jsx(ae,{title:"Submit Task",children:t.jsxs(d,{children:[t.jsx(o,{lg:"6",children:t.jsxs(d,{className:"mb-3",children:[t.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),t.jsx(o,{sm:"10",children:t.jsx(T,{value:n==null?void 0:n.comment,onChange:G,name:"comment",type:"text",id:"example-text-input"})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(d,{className:"mb-3",children:[t.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),t.jsx(o,{sm:"10",children:t.jsx(S,{multiple:!1,options:z,getOptionLabel:e=>e.name,value:n.selectBuildingParts,onChange:(e,s)=>{x({...n,selectBuildingParts:s})},renderInput:e=>t.jsx(N,{...e,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(e,s)=>e.map((a,i)=>t.jsx(C,{label:a.name,...s({index:i})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(d,{className:"mb-3",children:[t.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"select User"}),t.jsx(o,{sm:"10",children:t.jsx(S,{multiple:!1,options:J,getOptionLabel:e=>e.name,value:n.selectUser,onChange:(e,s)=>{x({...n,selectUser:s})},renderOption:(e,s)=>l.createElement("li",{...e,key:s._id},s.name),renderInput:e=>t.jsx(N,{...e,variant:"outlined",placeholder:"Search and select user for this task..."}),renderTags:(e,s)=>e.map((a,i)=>t.jsx(C,{label:a.name,...s({index:i})},a._id)),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),t.jsx(o,{lg:"6",children:t.jsxs(d,{className:"mb-3",children:[t.jsx(j,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),t.jsxs(o,{sm:"10",children:[t.jsx(T,{type:"file",id:"multiple-file-input",name:"pictures",onChange:K,accept:"image/*",multiple:!0,ref:v}),t.jsx("div",{className:"mt-3 d-flex flex-wrap",children:y.map((e,s)=>{var a;return t.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[t.jsx(re,{src:e,alt:`Preview ${s}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),t.jsx(N,{variant:"outlined",placeholder:"Add description...",value:((a=f[s])==null?void 0:a.description)||"",onChange:i=>X(s,i.target.value),fullWidth:!0,size:"small",className:"mt-1"}),t.jsx(U,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>Q(s),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},s)})})]})]})}),t.jsx(o,{lg:"6",children:t.jsxs(d,{className:"mb-3",children:[t.jsx(j,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),t.jsx(o,{sm:"10",children:t.jsx(S,{multiple:!1,options:M,getOptionLabel:e=>e.name,value:n==null?void 0:n.selectedDrawing,onChange:(e,s)=>{x({...n,selectedDrawing:s})},renderInput:e=>t.jsx(N,{...e,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(e,s)=>e.map((a,i)=>t.jsx(C,{label:a.name,...s({index:i})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(n==null?void 0:n.selectedDrawing)&&t.jsxs(o,{lg:"12",className:"mb-4",children:[t.jsx("h5",{children:"Main Drawings"}),t.jsx("div",{className:"d-flex flex-wrap",children:(O=($=n==null?void 0:n.selectedDrawing)==null?void 0:$.mainDrawings)==null?void 0:O.map((e,s)=>t.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=e.original;b({show:!0,pdfFile:`${u}/uploads/${e.stored}`,name:a})},style:{cursor:"pointer"},children:[t.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),t.jsx("div",{className:"small text-muted",children:e==null?void 0:e.original})]},`main-${s}`))})]}),(p==null?void 0:p.show)&&t.jsx(ne,{pdfUrl:p.pdfFile,onClose:()=>b({show:!1,pdfFile:null}),onSave:e=>{I(s=>({...s,[p.name.endsWith(".png")?p.name:`${p.name}.png`]:e})),b({show:!1,pdfFile:null})}}),(n==null?void 0:n.selectedDrawing)&&((A=(E=n==null?void 0:n.selectedDrawing)==null?void 0:E.childDrawings)==null?void 0:A.length)>0&&t.jsxs(o,{lg:"12",className:"mb-4",children:[t.jsx("h5",{children:"Child Drawings"}),t.jsx("div",{className:"d-flex flex-wrap",children:(R=(B=n==null?void 0:n.selectedDrawing)==null?void 0:B.childDrawings)==null?void 0:R.map((e,s)=>t.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=e.original;b({show:!0,pdfFile:`${u}/uploads/${e.stored}`,name:a})},style:{cursor:"pointer"},children:[t.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),t.jsx("div",{className:"small text-muted",children:e==null?void 0:e.original})]},`child-${s}`))})]}),t.jsx(d,{className:"mb-3 d-flex justify-content-center",children:t.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:t.jsx(U,{type:"submit",variant:"primary",className:"me-1",onClick:Y,children:"Submit"})})})]})})})})}export{ke as default};
