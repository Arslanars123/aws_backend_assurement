import{r as i,a as fe,b as xe,j as e,R as p,C as l}from"./index-S4cPkaXI.js";import{C as je}from"./ComponentContainerCard-CPsL5TPV.js";import{P as be}from"./PageMetaData-u0IuTTri.js";import{B as g}from"./urls-DHmWp6-I.js";import{P as we}from"./page-BL9ZqNzT.js";import{F as m}from"./FormLabel-xT7fLwVI.js";import{F as ve}from"./FormSelect--prDjbZc.js";import{A as N,C as P,T as f}from"./TextField-BSYfgtkt.js";import{B as k}from"./Button-BdLFNPe1.js";import{I as z}from"./Image-C0iuPhbd.js";import{F as Ne}from"./FormControl-DZh-Msrb.js";import"./Card-DerqaWgt.js";import"./divWithClassName-23-JlBVG.js";import"./Modal-CdPnefrM.js";import"./useWindow-BrvFrb9Q.js";import"./useEventCallback-CbKveW3s.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-DS4YuUbl.js";import"./FormRange-Dn1-Ecm8.js";import"./FormContext-3vyf8OR-.js";import"./PDFButton-1i9cSyXj.js";import"./Alert-BmsiN9DY.js";import"./hook-DAlenwRK.js";import"./Anchor-BFbjON2V.js";import"./useFormControl-CQ-iehwM.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const Pe={item:null,selectedDrawing:null,projectUsers:null,projectManager:null,comment:null,profession:null,buildingPart:null,selectedWorkers:null},ss=()=>{var U,L;const[n,x]=i.useState(Pe),[F,$]=i.useState(!1),[q,_]=i.useState([]),[B,J]=i.useState([]),G=fe(),{companyId:j,projectId:b}=xe(),[v,I]=i.useState([]),[S,A]=i.useState([]),[w,M]=i.useState([]),[C,E]=i.useState([]),[V,H]=i.useState([]),T=i.useRef(null),[u,D]=i.useState({show:!1,pdfFile:null,name:null}),[W,K]=i.useState({}),[Q,X]=i.useState({}),[R,Y]=i.useState(0),[ye,Se]=i.useState({}),[ke,Ie]=i.useState(10),[Z,ee]=i.useState([]),[se,te]=i.useState([]),[re,ne]=i.useState([]),ae=s=>{const t=Array.from(s.target.files),a=t.map(c=>({file:c,description:""})),r=[...v,...a],o=[...S,...t.map(c=>URL.createObjectURL(c))];I(r),A(o)},oe=s=>{const t=v.filter((r,o)=>o!==s),a=S.filter((r,o)=>o!==s);I(t),A(a)},ie=s=>{const{name:t,value:a}=s.target;x({...n,[t]:a})},le=(s,t)=>{const a=[...v];a[s].description=t,I(a)},ce=async()=>{try{const t=await(await fetch(`${g}/get-company-professions?companyId=${j}&projectId=${b}`)).json();ee(t)}catch(s){console.error("Error fetching professions:",s)}},de=async()=>{var s;try{const t=`${g}/get-parts?SubjectMatterId=${(s=n==null?void 0:n.profession)==null?void 0:s.SubjectMatterId}`,r=await(await fetch(t)).json();te(r)}catch(t){console.log(t)}},pe=async()=>{try{const s={companyId:j,projectId:b,professionsIds:n!=null&&n.profession?[n.profession._id]:[],roles:["Worker"]},a=await(await fetch(`${g}/get-filter-users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();ne(a)}catch(s){console.error("Error fetching workers:",s)}};i.useEffect(()=>{const s=async()=>{try{const o=await(await fetch(`${g}/get-draws?companyId=${j}&projectId=${b}`)).json();_(o)}catch(r){console.error("Error fetching workers:",r)}},t=async()=>{try{const r=`${g}/get-filter-users`,h=await(await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:j,projectId:b})})).json();J(h)}catch(r){console.error("Error fetching users:",r)}};(async()=>{try{const r=`${g}/get-project-managers?companyId=${j}&projectId=${b}`,c=await(await fetch(r)).json();H(c)}catch(r){console.error("Error fetching project managers:",r)}})(),t(),s(),ce()},[]),i.useEffect(()=>{n.profession&&(de(),pe())},[n.profession]);const me=se,ue=re,he=async s=>{s.preventDefault(),$(!0);try{const t=new FormData;t.append("companyId",j),t.append("projectsId",b),t.append("item",n.item),t.append("projectUsers",JSON.stringify(n.projectUsers)),t.append("projectManager",JSON.stringify(n.projectManager)),t.append("drawing",JSON.stringify(n.selectedDrawing)),t.append("profession",JSON.stringify(n.profession)),t.append("buildingPart",JSON.stringify(n.buildingPart)),t.append("selectedWorkers",JSON.stringify(n.selectedWorkers)),v.length>0&&v.forEach((r,o)=>{t.append("pictures",r.file),t.append("pictureDescriptions",r.description||"")}),w.length>0&&w.forEach((r,o)=>{var c;t.append("markPictures",r.file),t.append("markPictureDescriptions",r.description||""),t.append("markNumbers",((c=r.markNumber)==null?void 0:c.toString())||"")}),Object.entries(W).forEach(([r,o])=>{const d=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",o,d)}),Object.entries(Q).forEach(([r,o])=>{if(o){const d=`${r.replace(/[^-\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}_annotated.png`;t.append("annotatedPdfImages",o,d)}});const a=await fetch(`${g}/store-request`,{method:"POST",body:t});a.ok?G(`/dashboard/companies/view/${j}/projects/view/${b}`):console.error("Error:",a.statusText)}catch(t){console.error("Fetch error:",t)}$(!1)};return console.log("annotatedImages",W),e.jsxs(e.Fragment,{children:[e.jsx(be,{title:"Add Technical Request"}),e.jsx("form",{onSubmit:he,children:e.jsx(p,{className:"justify-content-center",children:e.jsx(l,{children:e.jsx(je,{title:"Add Technical Request",children:e.jsxs(p,{children:[e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(l,{sm:"10",children:e.jsxs(ve,{value:n.item,name:"item",onChange:ie,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Does not include project material.",children:"Does not include project material."}),e.jsx("option",{value:"Meeting at the construction site is required.",children:"Meeting at the construction site is required."}),e.jsx("option",{value:"There is no preparation as told.",children:"There is no preparation as told."}),e.jsx("option",{value:"A new instruction is requested here, as it is not possible",children:"A new instruction is requested here, as it is not possible"})]})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Profession"}),e.jsx(l,{sm:"10",children:e.jsx(N,{multiple:!1,options:Z,getOptionLabel:s=>s.GroupName,value:n==null?void 0:n.profession,onChange:(s,t)=>{x({...n,profession:t,buildingPart:null,selectedWorkers:null})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Select Profession..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.GroupName,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Building Part"}),e.jsx(l,{sm:"10",children:e.jsx(N,{multiple:!1,options:me,getOptionLabel:s=>String(s.name),value:n==null?void 0:n.buildingPart,onChange:(s,t)=>{x({...n,buildingPart:t,selectedWorkers:null})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:String(a.name),...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Select Workers"}),e.jsx(l,{sm:"10",children:e.jsx(N,{multiple:!0,options:ue,getOptionLabel:s=>s.name,value:(n==null?void 0:n.selectedWorkers)||[],onChange:(s,t)=>{x({...n,selectedWorkers:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Select Workers..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(l,{sm:"10",children:e.jsx(N,{multiple:!1,options:V,getOptionLabel:s=>s.name,value:n==null?void 0:n.projectManager,onChange:(s,t)=>{x({...n,projectManager:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(l,{sm:"10",children:e.jsx(N,{multiple:!1,options:B,getOptionLabel:s=>s.name,value:n==null?void 0:n.projectUsers,onChange:(s,t)=>{x({...n,projectUsers:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"search and select the receiver ..."}),renderTags:(s,t)=>s.map((a,r)=>e.jsx(P,{label:a.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(l,{sm:"10",children:e.jsx(N,{multiple:!1,options:q,getOptionLabel:s=>s.name?s.name:s.mainDrawings&&s.mainDrawings.length>0&&s.mainDrawings[0].original||"No name available",value:n==null?void 0:n.selectedDrawing,onChange:(s,t)=>{x({...n,selectedDrawing:t})},renderInput:s=>e.jsx(f,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((a,r)=>{const o=a.name||(a.mainDrawings&&a.mainDrawings.length>0?a.mainDrawings[0].original:"No name available");return e.jsx(P,{label:o,...t({index:r})})}),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(n==null?void 0:n.selectedDrawing)&&e.jsxs(l,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(L=(U=n==null?void 0:n.selectedDrawing)==null?void 0:U.mainDrawings)==null?void 0:L.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=s.original;D({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:a})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),e.jsx(l,{lg:"12",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(l,{sm:"10",children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:ae,ref:T,style:{display:"none"}}),e.jsx(k,{type:"button",variant:"outline-primary",onClick:()=>T.current.click(),className:"mb-3",children:"Upload Pictures"}),S.length>0&&e.jsx("div",{className:"d-flex flex-wrap",children:S.map((s,t)=>{var a;return e.jsxs("div",{className:"me-3 mb-3 position-relative",children:[e.jsx(z,{src:s,alt:`Preview ${t+1}`,style:{width:"100px",height:"100px",objectFit:"cover"}}),e.jsx(k,{type:"button",variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>oe(t),children:"Ã—"}),e.jsx(f,{variant:"outlined",placeholder:"Description...",value:((a=v[t])==null?void 0:a.description)||"",onChange:r=>le(t,r.target.value),size:"small",className:"mt-1",fullWidth:!0})]},t)})})]})]})}),R>0&&e.jsx(l,{lg:"12",children:e.jsxs(p,{className:"mb-3",children:[e.jsx(m,{className:"col-sm-2 col-form-label text-end",children:"PDF Marked Pictures"}),e.jsx(l,{sm:"10",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-muted mb-3",children:"Upload multiple pictures for each mark you placed on the PDF. Each picture can have its own description."}),Array.from({length:R},(s,t)=>{const a=w.filter(r=>r.markNumber===t+1);return e.jsxs("div",{className:"mb-4 p-3 border rounded",children:[e.jsxs("h6",{className:"mb-2",children:["ðŸ“Œ Mark #",t+1," Pictures"]}),e.jsx(Ne,{type:"file",name:`picture-mark-${t+1}`,onChange:r=>{const o=Array.from(r.target.files);if(o.length>0){const c=[...w];o.forEach(d=>{c.push({file:d,description:"",markNumber:t+1})}),M(c);const h=[...C];o.forEach(d=>{h.push(URL.createObjectURL(d))}),E(h)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:a.map((r,o)=>{const c=w.findIndex(d=>d===r),h=C[c];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(z,{src:h,alt:`Preview ${o}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(f,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:d=>{const y=[...w];y[c]={...y[c],description:d.target.value},M(y)},fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(k,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>{const d=w.filter((ge,O)=>O!==c);M(d);const y=C.filter((ge,O)=>O!==c);E(y)},style:{transform:"translate(50%, -50%)"},children:"Ã—"})]},o)})})]},t)})]})})]})}),e.jsx(l,{lg:"12",className:"d-flex justify-content-end",children:e.jsx(k,{type:"submit",variant:"primary",disabled:F,children:F?"Submitting...":"Submit"})})]})})})})}),u.show&&e.jsx(we,{pdfUrl:u.pdfFile,onClose:()=>D({show:!1,pdfFile:null,name:null}),onSave:async(s,t,a)=>{if(Y(t),K(r=>({...r,[u.name.endsWith(".png")?u.name:`${u.name}.png`]:s})),typeof a=="function"){const r=await a();X(o=>({...o,[u.name.endsWith(".png")?u.name:`${u.name}.png`]:r}))}D({show:!1,pdfFile:null,name:null})}})]})};export{ss as default};
