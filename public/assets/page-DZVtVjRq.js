import{r as c,a as Q,b as X,j as e,R as m,C as l}from"./index-DXGzwTDX.js";import{C as Y}from"./ComponentContainerCard-BdqSoKWJ.js";import{P as Z}from"./PageMetaData-DqMiWj9r.js";import{B as g}from"./urls-BhGeBsON.js";import{P as ee}from"./page-DEewqJvp.js";import{F as x}from"./FormLabel-MRPFOBK0.js";import{F as te}from"./FormSelect-BwnGZFNn.js";import{A as S,C,T as w}from"./TextField-DD5ZZLTe.js";import{F as se}from"./FormControl-gHzxXlg1.js";import{I as ae}from"./Image-DXZMDITT.js";import{B as $}from"./Button-Q8P5klcO.js";import"./Card-BF03U0a9.js";import"./divWithClassName-WthjuUgX.js";import"./page-DRHJaXUb.js";import"./Modal-pNXPnpNb.js";import"./useWindow-D1WaCGvc.js";import"./DataKey-DeFhA7Nw.js";import"./NoopTransition-CDGbDsLX.js";import"./FormRange-B5lnwdc-.js";import"./PDFButton-CA3UgHlN.js";import"./Alert-BIE78wlt.js";import"./Anchor-OB-3XvKs.js";import"./useFormControl-BMCg-VWj.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const ne={item:null,selectedDrawing:null,projectUsers:null,projectManager:null,comment:null},Te=()=>{var T,F,I,M;const[a,u]=c.useState(ne),[E,D]=c.useState(!1),[R,U]=c.useState([]),[O,B]=c.useState([]),L=Q(),{companyId:j,projectId:f}=X(),[h,v]=c.useState([]),[y,k]=c.useState([]),[z,W]=c.useState([]),A=c.useRef(null),[p,N]=c.useState({show:!1,pdfFile:null,name:null}),[P,_]=c.useState({}),[b,J]=c.useState(0);c.useEffect(()=>{const s=async()=>{try{const o=await(await fetch(`${g}/get-draws?companyId=${j}&projectId=${f}`)).json();U(o)}catch(n){console.error("Error fetching workers:",n)}},t=async()=>{try{const n=`${g}/get-filter-users`,d=await(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:j,projectId:f})})).json();B(d)}catch(n){console.error("Error fetching users:",n)}};(async()=>{try{const n=`${g}/get-project-managers?companyId=${j}&projectId=${f}`,i=await(await fetch(n)).json();W(i)}catch(n){console.error("Error fetching project managers:",n)}})(),t(),s()},[]);const V=s=>{const t=h.filter((o,i)=>i!==s),r=y.filter((o,i)=>i!==s);v(t),k(r);const n=new DataTransfer;t.forEach(o=>n.items.add(o.file)),A.current&&(A.current.files=n.files)},q=s=>{const{name:t,value:r,multiple:n,options:o}=s.target;if(n){const i=Array.from(o).filter(d=>d.selected).map(d=>d.value);u({...a,[t]:i})}else u({...a,[t]:r})},H=(s,t)=>{const r=[...h];r[s].description=t,v(r)},G=async s=>{s.preventDefault(),D(!0);try{const t=new FormData;t.append("companyId",j),t.append("projectsId",f),t.append("comment",a.comment),t.append("item",a.item),t.append("projectUsers",JSON.stringify(a.projectUsers)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("drawing",JSON.stringify(a.selectedDrawing)),h.length>0&&h.forEach((n,o)=>{t.append("pictures",n.file),t.append("pictureDescriptions",n.description||"")}),Object.entries(P).forEach(([n,o])=>{const K=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",o,K)});const r=await fetch(`${g}/store-note`,{method:"POST",body:t});r.ok?L(`/dashboard/companies/view/${j}/projects/view/${f}`):console.error("Error:",r.statusText)}catch(t){console.error("Fetch error:",t)}D(!1)};return console.log("annotatedImages",P),e.jsxs(e.Fragment,{children:[e.jsx(Z,{title:"Add Address Note"}),e.jsx("form",{onSubmit:G,children:e.jsx(m,{className:"justify-content-center",children:e.jsx(l,{children:e.jsx(Y,{title:"Add Address Note",children:e.jsxs(m,{children:[e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(l,{sm:"10",children:e.jsxs(te,{value:a.item,name:"item",onChange:q,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"The work does not follow the schedule.",children:"The work does not follow the schedule."}),e.jsx("option",{value:"The work is not completed.",children:"The work is not completed."}),e.jsx("option",{value:"The relationship causes delays",children:"The relationship causes delays"}),e.jsx("option",{value:"The interfaces cannot receive in that state.",children:"The interfaces cannot receive in that state."}),e.jsx("option",{value:"Manpower must be provided here if the schedule is to be adhered to.",children:"Manpower must be provided here if the schedule is to be adhered to."}),e.jsx("option",{value:"Someone has destroyed my work after final inspection.",children:"Someone has destroyed my work after final inspection."}),e.jsx("option",{value:"Conditions that are taken up at the next building meeting",children:"Conditions that are taken up at the next building meeting"}),e.jsx("option",{value:"The work is notified to be stopped in 3 days, due to non-payment. cf. AB18",children:"The work is notified to be stopped in 3 days, due to non-payment. cf. AB18"})]})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(l,{sm:"10",children:e.jsx(S,{multiple:!1,options:z,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{u({...a,projectManager:t})},renderInput:s=>e.jsx(w,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(C,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(l,{sm:"10",children:e.jsx(S,{multiple:!1,options:O,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectUsers,onChange:(s,t)=>{u({...a,projectUsers:t})},renderInput:s=>e.jsx(w,{...s,variant:"outlined",placeholder:"search and select the receiver ..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(C,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(l,{sm:"10",children:e.jsx(w,{variant:"outlined",placeholder:"Add some comments...",value:a==null?void 0:a.comment,onChange:s=>{var t;u({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(l,{sm:"10",children:e.jsx(S,{multiple:!1,options:R,getOptionLabel:s=>s.name,value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{u({...a,selectedDrawing:t})},renderInput:s=>e.jsx(w,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(C,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(l,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(F=(T=a==null?void 0:a.selectedDrawing)==null?void 0:T.mainDrawings)==null?void 0:F.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=s.original;N({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(p==null?void 0:p.show)&&e.jsx(ee,{pdfUrl:p.pdfFile,onClose:()=>N({show:!1,pdfFile:null}),onSave:(s,t)=>{J(t),_(r=>({...r,[p.name.endsWith(".png")?p.name:`${p.name}.png`]:s})),N({show:!1,pdfFile:null})}}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(l,{lg:"12",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(M=(I=a==null?void 0:a.selectedDrawing)==null?void 0:I.childDrawings)==null?void 0:M.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:b>0?`Pictures (${b} marks)`:"Pictures"}),e.jsx(l,{sm:"10",children:b>0?e.jsx("div",{className:"mb-3",children:Array.from({length:b}).map((s,t)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),e.jsx(se,{type:"file",name:`picture-mark-${t+1}`,onChange:r=>{const n=Array.from(r.target.files);if(n.length>0){const o=[...h];n.forEach(d=>{o.push({file:d,description:"",markNumber:t+1})}),v(o);const i=[...y];n.forEach(d=>{i.push(URL.createObjectURL(d))}),k(i)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:h.map((r,n)=>{if(r.markNumber===t+1){const o=y[n];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(ae,{src:o,alt:`Preview ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(w,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:i=>H(n,i.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx($,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>V(n),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},n)}return null})})]},t))}):null})]})}),e.jsx(m,{className:"mb-3 d-flex justify-content-center",children:e.jsx(l,{sm:"12",className:"d-flex justify-content-end",children:e.jsx($,{disabled:E,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Te as default};
