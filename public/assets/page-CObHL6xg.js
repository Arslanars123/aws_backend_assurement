import{r as o,a as ee,b as se,j as e,R as d,C as i}from"./index-CF9SjLWQ.js";import{C as te}from"./ComponentContainerCard-n9fGDRyA.js";import{P as ae}from"./PageMetaData-B4Fb5zJ6.js";import{B as u}from"./urls-BhGeBsON.js";import{P as ne}from"./page-kGDYU_lm.js";import{F as g}from"./FormLabel-CaO2MFER.js";import{F as re}from"./FormSelect-C4POiLCt.js";import{A as S,C as D,T as b}from"./TextField-FXpElbHG.js";import{F as ie}from"./FormControl-DmgB3XQy.js";import{I as oe}from"./Image-DGQJ2Jha.js";import{B as T}from"./Button-UcXSk4np.js";import"./Card-Bx1F2r4C.js";import"./divWithClassName-13-QUwjt.js";import"./page-DbZ3f2yu.js";import"./Modal-CQeUVPXG.js";import"./useWindow-BQWBaX9C.js";import"./DataKey-KKZij2X9.js";import"./NoopTransition-BChfWke-.js";import"./FormRange-C_Mxfksa.js";import"./PDFButton-CY5rODRi.js";import"./Alert-DVLUPR3Z.js";import"./Anchor-taqs8bUs.js";import"./useFormControl-Bd5Uj6AV.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const le={item:null,selectedDrawing:null,projectUsers:null,projectManager:null},Te=()=>{var I,P,M,A,$,R;const[a,h]=o.useState(le),[O,C]=o.useState(!1),E=ee(),{companyId:x,projectId:j}=se(),[U,q]=o.useState([]),[k,L]=o.useState([]),[z,B]=o.useState([]),[m,v]=o.useState([]),[N,F]=o.useState([]),y=o.useRef(null),[p,f]=o.useState({show:!1,pdfFile:null,name:null}),[W,J]=o.useState({}),_=s=>{const t=Array.from(s.target.files),n=t.map(c=>({file:c,description:""})),r=[...m,...n],l=[...N,...t.map(c=>URL.createObjectURL(c))];v(r),F(l)},V=s=>{const t=m.filter((l,c)=>c!==s),n=N.filter((l,c)=>c!==s);v(t),F(n);const r=new DataTransfer;t.forEach(l=>r.items.add(l.file)),y.current&&(y.current.files=r.files)},H=(s,t)=>{const n=[...m];n[s].description=t,v(n)},G=s=>{const{name:t,value:n,multiple:r,options:l}=s.target;if(r){const c=Array.from(l).filter(w=>w.selected).map(w=>w.value);h({...a,[t]:c})}else h({...a,[t]:n})},K=async()=>{try{const s=`${u}/get-project-managers?companyId=${x}&projectId=${j}`,n=await(await fetch(s)).json();q(n)}catch(s){console.error("Error fetching project managers:",s)}},Q=async()=>{try{const t=await(await fetch(`${u}/get-draws?companyId=${x}&projectId=${j}`)).json();B(t)}catch(s){console.error("Error fetching workers:",s)}},X=async()=>{try{const s=`${u}/get-filter-users`,r=await(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:x,projectId:j})})).json();L(r)}catch(s){console.error("Error fetching users:",s)}};o.useEffect(()=>{K(),X(),Q()},[]);const Y=async s=>{s.preventDefault(),C(!0);try{const t=new FormData;t.append("companyId",x),t.append("projectsId",j),t.append("item",a.item),t.append("projectUsers",JSON.stringify(a.projectUsers)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("drawing",JSON.stringify(a.selectedDrawing)),m.length>0&&m.forEach((r,l)=>{t.append("pictures",r.file),t.append("pictureDescriptions",r.description||"")}),Object.entries(W).forEach(([r,l])=>{const Z=`${r.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",l,Z)});const n=await fetch(`${u}/store-request`,{method:"POST",body:t});if(n.ok){const r=await n.json();E(`/dashboard/companies/view/${x}/projects/view/${j}`)}else console.error("Error:",n.statusText)}catch(t){console.error("Fetch error:",t)}C(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(ae,{title:"Add Technical Request"}),e.jsx("form",{onSubmit:Y,children:e.jsx(d,{className:"justify-content-center",children:e.jsx(i,{children:e.jsx(te,{title:"Add Technical Request",children:e.jsxs(d,{children:[e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(g,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(i,{sm:"10",children:e.jsxs(re,{value:a.item,name:"item",onChange:G,children:[e.jsx("option",{defaultValue:"",children:"Select Item"}),e.jsx("option",{value:"Does not include project material.",children:"Does not include project material."}),e.jsx("option",{value:"Meeting at the construction site is required.",children:"Meeting at the construction site is required."}),e.jsx("option",{value:"There is no preparation as told.",children:"There is no preparation as told."}),e.jsx("option",{value:"A new instruction is requested here, as it is not possible",children:"A new instruction is requested here, as it is not possible"})]})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(i,{sm:"10",children:e.jsx(S,{multiple:!1,options:U,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{h({...a,projectManager:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(D,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(i,{sm:"10",children:e.jsx(S,{multiple:!1,options:k,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectUsers,onChange:(s,t)=>{h({...a,projectUsers:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and project Users drawing..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(D,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(g,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(i,{sm:"10",children:e.jsx(S,{multiple:!1,options:z,getOptionLabel:s=>s.name,value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{h({...a,selectedDrawing:t})},renderInput:s=>e.jsx(b,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((n,r)=>e.jsx(D,{label:n.name,...t({index:r})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(P=(I=a==null?void 0:a.selectedDrawing)==null?void 0:I.mainDrawings)==null?void 0:P.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;f({show:!0,pdfFile:`${u}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(p==null?void 0:p.show)&&e.jsx(ne,{pdfUrl:p.pdfFile,onClose:()=>f({show:!1,pdfFile:null}),onSave:s=>{J(t=>({...t,[p.name.endsWith(".png")?p.name:`${p.name}.png`]:s})),f({show:!1,pdfFile:null})}}),(a==null?void 0:a.selectedDrawing)&&((A=(M=a==null?void 0:a.selectedDrawing)==null?void 0:M.childDrawings)==null?void 0:A.length)>0&&e.jsxs(i,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(R=($=a==null?void 0:a.selectedDrawing)==null?void 0:$.childDrawings)==null?void 0:R.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const n=s.original;f({show:!0,pdfFile:`${u}/uploads/${s.stored}`,name:n})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),e.jsx(i,{lg:"6",children:e.jsxs(d,{className:"mb-3",children:[e.jsx(g,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:"Pictures"}),e.jsxs(i,{sm:"10",children:[e.jsx(ie,{type:"file",id:"multiple-file-input",name:"pictures",onChange:_,accept:"image/*",multiple:!0,ref:y}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:N.map((s,t)=>{var n;return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(oe,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(b,{variant:"outlined",placeholder:"Add description...",value:((n=m[t])==null?void 0:n.description)||"",onChange:r=>H(t,r.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(T,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>V(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"Ã—"})]},t)})})]})]})}),e.jsx(d,{className:"mb-3 d-flex justify-content-center",children:e.jsx(i,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(T,{disabled:O,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{Te as default};
