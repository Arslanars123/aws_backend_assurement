import{r as l,G as ae,a as re,b as ne,j as s,R as p,C as o}from"./index-DXGzwTDX.js";import{C as ie}from"./ComponentContainerCard-BdqSoKWJ.js";import{B as f}from"./urls-BhGeBsON.js";import{P as le}from"./page-DEewqJvp.js";import{F as N}from"./FormLabel-MRPFOBK0.js";import{F as k}from"./FormControl-gHzxXlg1.js";import{A as D,C as $,T as v}from"./TextField-DD5ZZLTe.js";import{I as _}from"./Image-DXZMDITT.js";import{B as F}from"./Button-Q8P5klcO.js";import"./Card-BF03U0a9.js";import"./divWithClassName-WthjuUgX.js";import"./page-DRHJaXUb.js";import"./Modal-pNXPnpNb.js";import"./useWindow-D1WaCGvc.js";import"./DataKey-DeFhA7Nw.js";import"./NoopTransition-CDGbDsLX.js";import"./FormRange-B5lnwdc-.js";import"./PDFButton-CA3UgHlN.js";import"./Alert-BIE78wlt.js";import"./Anchor-OB-3XvKs.js";import"./useFormControl-BMCg-VWj.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const oe={comment:"",selectBuildingParts:null,selectedDrawing:null,selectUser:null};function Ee(){var B,T,M,L,z,W;const[r,x]=l.useState(oe),{clickTask:i}=l.useContext(ae),[J,q]=l.useState([]),[G,H]=l.useState([]),S=l.useRef(null),[j,y]=l.useState([]),[m,w]=l.useState([]),I=re(),{companyId:g,projectId:u,taskId:E}=ne(),[h,P]=l.useState({show:!1,pdfFile:null,name:null}),[V,A]=l.useState({}),[K,Q]=l.useState([]),[C,X]=l.useState(0),Y=e=>{const{name:t,value:a}=e.target;x({...r,[t]:a})},Z=async()=>{try{const t=await(await fetch(`${f}/get-draws?companyId=${g}&projectId=${u}`)).json();q(t)}catch(e){console.error("Error fetching workers:",e)}},O=async()=>{try{const e=`${f}/get-parts?SubjectMatterId=${i==null?void 0:i.SubjectMatterId}`,a=await(await fetch(e)).json();H(a)}catch(e){console.log(e)}},ee=async()=>{try{const e=`${f}/get-filter-users`,a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:g,projectId:u,taskId:E,roles:["Sub Contractor","Worker"]})});if(!a.ok)throw new Error("Failed to fetch users");const n=await a.json();Q(n)}catch(e){console.error("Error fetching users:",e)}};l.useEffect(()=>{if(i){if(x({comment:i.comment||"",selectBuildingParts:i.buildingParts||null,selectedDrawing:i.drawing||null,selectUser:i.user||null}),i.pictures&&i.pictures.length>0){const e=i.pictures.map(a=>`${f}/uploads/${a}`);y(e);const t=i.pictures.map(a=>({file:null,existingFilename:a,description:""}));w(t)}if(i.annotatedPdfs&&i.annotatedPdfs.length>0){const e={};i.annotatedPdfs.forEach(t=>{e[t.originalName]=null}),A(e)}}},[i]),l.useEffect(()=>{g&&u&&(Z(),O(),ee())},[g,u]),l.useEffect(()=>{i&&O()},[i]);const se=e=>{const t=Array.from(e.target.files),a=t.map(d=>({file:d,description:""})),n=[...m,...a],c=[...j,...t.map(d=>URL.createObjectURL(d))];w(n),y(c)},R=e=>{const t=m.filter((c,d)=>d!==e),a=j.filter((c,d)=>d!==e);w(t),y(a);const n=new DataTransfer;t.forEach(c=>n.items.add(c.file)),S.current&&(S.current.files=n.files)},U=(e,t)=>{const a=[...m];a[e].description=t,w(a)},te=async()=>{if(!g||!u){I("/dashboard/companies");return}if(!r.selectedDrawing||!r.selectBuildingParts){alert("Please select both a drawing and building part.");return}try{const e=new FormData;e.append("comment",r.comment),e.append("projectId",u),e.append("taskId",E),e.append("buildingParts",JSON.stringify(r.selectBuildingParts)),e.append("drawing",JSON.stringify(r.selectedDrawing)),e.append("user",JSON.stringify(r.selectUser)),m.length>0&&m.forEach((a,n)=>{if(a.file){e.append("pictures",a.file);const c=a.markNumber?`Mark #${a.markNumber}: ${a.description||""}`:a.description||"";e.append("pictureDescriptions",c)}}),Object.entries(V).forEach(([a,n])=>{if(n){const b=`${a.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;e.append("annotatedPdfs",n,b)}});const t=await fetch(`${f}/submit-task`,{method:"POST",body:e});if(t.ok)I(`/dashboard/companies/view/${g}/projects/view/${u}`);else{const a=await t.json();alert(`Error: ${a.message||"Failed to update task."}`)}}catch(e){console.error("Submit error:",e),alert("Something went wrong while submitting the task.")}};return s.jsx(p,{className:"justify-content-center",children:s.jsx(o,{children:s.jsx(ie,{title:"Submit Task",children:s.jsxs(p,{children:[s.jsx(o,{lg:"6",children:s.jsxs(p,{className:"mb-3",children:[s.jsx(N,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Comment"}),s.jsx(o,{sm:"10",children:s.jsx(k,{value:r==null?void 0:r.comment,onChange:Y,name:"comment",type:"text",id:"example-text-input"})})]})}),s.jsx(o,{lg:"6",children:s.jsxs(p,{className:"mb-3",children:[s.jsx(N,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Building Parts"}),s.jsx(o,{sm:"10",children:s.jsx(D,{multiple:!1,options:G,getOptionLabel:e=>e.name,value:r.selectBuildingParts,onChange:(e,t)=>{x({...r,selectBuildingParts:t})},renderInput:e=>s.jsx(v,{...e,variant:"outlined",placeholder:"Search and select building parts..."}),renderTags:(e,t)=>e.map((a,n)=>s.jsx($,{label:a.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),s.jsx(o,{lg:"6",children:s.jsxs(p,{className:"mb-3",children:[s.jsx(N,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"select User"}),s.jsx(o,{sm:"10",children:s.jsx(D,{multiple:!1,options:K,getOptionLabel:e=>e.name,value:r.selectUser,onChange:(e,t)=>{x({...r,selectUser:t})},renderOption:(e,t)=>l.createElement("li",{...e,key:t._id},t.name),renderInput:e=>s.jsx(v,{...e,variant:"outlined",placeholder:"Search and select user for this task..."}),renderTags:(e,t)=>e.map((a,n)=>s.jsx($,{label:a.name,...t({index:n})},a._id)),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),s.jsx(o,{lg:"6",children:s.jsxs(p,{className:"mb-3",children:[s.jsx(N,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:C>0?`Pictures (${C} marks)`:"Pictures"}),s.jsx(o,{sm:"10",children:C>0?s.jsx("div",{className:"mb-3",children:Array.from({length:C}).map((e,t)=>s.jsxs("div",{className:"mb-3",children:[s.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),s.jsx(k,{type:"file",name:`picture-mark-${t+1}`,onChange:a=>{const n=Array.from(a.target.files);if(n.length>0){const c=[...m];n.forEach(b=>{c.push({file:b,description:"",markNumber:t+1})}),w(c);const d=[...j];n.forEach(b=>{d.push(URL.createObjectURL(b))}),y(d)}},accept:"image/*",multiple:!0}),s.jsx("div",{className:"mt-3 d-flex flex-wrap",children:m.map((a,n)=>{if(a.markNumber===t+1){const c=j[n];return s.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[s.jsx(_,{src:c,alt:`Preview ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),s.jsx(v,{variant:"outlined",placeholder:"Add description...",value:a.description,onChange:d=>U(n,d.target.value),fullWidth:!0,size:"small",className:"mt-1"}),s.jsx(F,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>R(n),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},n)}return null})})]},t))}):s.jsxs(s.Fragment,{children:[s.jsx(k,{type:"file",id:"multiple-file-input",name:"pictures",onChange:se,accept:"image/*",multiple:!0,ref:S}),s.jsx("div",{className:"mt-3 d-flex flex-wrap",children:j.map((e,t)=>{var a;return s.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[s.jsx(_,{src:e,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),s.jsx(v,{variant:"outlined",placeholder:"Add description...",value:((a=m[t])==null?void 0:a.description)||"",onChange:n=>U(t,n.target.value),fullWidth:!0,size:"small",className:"mt-1"}),s.jsx(F,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>R(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)})})]})})]})}),s.jsx(o,{lg:"6",children:s.jsxs(p,{className:"mb-3",children:[s.jsx(N,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),s.jsx(o,{sm:"10",children:s.jsx(D,{multiple:!1,options:J,getOptionLabel:e=>e.name,value:r==null?void 0:r.selectedDrawing,onChange:(e,t)=>{x({...r,selectedDrawing:t})},renderInput:e=>s.jsx(v,{...e,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(e,t)=>e.map((a,n)=>s.jsx($,{label:a.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(r==null?void 0:r.selectedDrawing)&&s.jsxs(o,{lg:"12",className:"mb-4",children:[s.jsx("h5",{children:"Main Drawings"}),s.jsx("div",{className:"d-flex flex-wrap",children:(T=(B=r==null?void 0:r.selectedDrawing)==null?void 0:B.mainDrawings)==null?void 0:T.map((e,t)=>s.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=e.original;P({show:!0,pdfFile:`${f}/uploads/${e.stored}`,name:a})},style:{cursor:"pointer"},children:[s.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),s.jsx("div",{className:"small text-muted",children:e==null?void 0:e.original})]},`main-${t}`))})]}),(h==null?void 0:h.show)&&s.jsx(le,{pdfUrl:h.pdfFile,onClose:()=>P({show:!1,pdfFile:null}),onSave:(e,t)=>{X(t),A(a=>({...a,[h.name.endsWith(".png")?h.name:`${h.name}.png`]:e})),P({show:!1,pdfFile:null})}}),(r==null?void 0:r.selectedDrawing)&&((L=(M=r==null?void 0:r.selectedDrawing)==null?void 0:M.childDrawings)==null?void 0:L.length)>0&&s.jsxs(o,{lg:"12",className:"mb-4",children:[s.jsx("h5",{children:"Child Drawings"}),s.jsx("div",{className:"d-flex flex-wrap",children:(W=(z=r==null?void 0:r.selectedDrawing)==null?void 0:z.childDrawings)==null?void 0:W.map((e,t)=>s.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const a=e.original;P({show:!0,pdfFile:`${f}/uploads/${e.stored}`,name:a})},style:{cursor:"pointer"},children:[s.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),s.jsx("div",{className:"small text-muted",children:e==null?void 0:e.original})]},`child-${t}`))})]}),s.jsx(p,{className:"mb-3 d-flex justify-content-center",children:s.jsx(o,{sm:"12",className:"d-flex justify-content-end",children:s.jsx(F,{type:"submit",variant:"primary",className:"me-1",onClick:te,children:"Submit"})})})]})})})})}export{Ee as default};
