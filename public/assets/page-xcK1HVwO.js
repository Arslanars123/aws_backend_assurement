import{r as c,a as oe,b as le,ab as ce,j as e,R as m,C as l}from"./index-CEbbE1Sf.js";import{C as de}from"./ComponentContainerCard-BpYspYtC.js";import{P as me}from"./PageMetaData-qE4R9bbS.js";import{B as g}from"./urls-CvG9cD6N.js";import{P as pe}from"./page-CBT_MneI.js";import{F as x}from"./FormLabel-WQTNbj7P.js";import{F as ue}from"./FormSelect-Dmi-PE_I.js";import{A as E,C as U,T as v}from"./TextField-CeDJPKh1.js";import{F as H}from"./FormControl-DFJ9Ydzw.js";import{I}from"./Image-ULHo9GWi.js";import{B as P}from"./Button-CWQV4UHt.js";import"./Card-mt6mV6AB.js";import"./divWithClassName-CT9nWrpT.js";import"./Modal-C5567GrF.js";import"./useWindow-Bj2vCJZa.js";import"./useEventCallback-C6szz9nn.js";import"./DataKey-COGXBUcQ.js";import"./NoopTransition-PrPCoCM2.js";import"./FormRange-MzNiwPri.js";import"./FormContext-CSwRqVJr.js";import"./PDFButton-m7iMGlez.js";import"./Alert-DHIJxZou.js";import"./hook-CyH9mnqt.js";import"./Anchor-BXgEd0Ob.js";import"./useFormControl-BPpZZpE7.js";import"./assertThisInitialized-B9jnkVVz.js";import"./createPopper-C8K2eoCJ.js";const ze=()=>{var z,B,W,J;const[a,p]=c.useState(null),[q,T]=c.useState(!1),[N,Q]=c.useState([]),[y,G]=c.useState([]),K=oe(),{companyId:f,projectId:j,noteId:$}=le(),[V]=ce(),[u,D]=c.useState([]),[w,M]=c.useState([]),[S,X]=c.useState([]),k=c.useRef(null),[h,F]=c.useState({show:!1,pdfFile:null,name:null}),[Y,Z]=c.useState({}),[C,ee]=c.useState(0),[te,A]=c.useState(!0),[R,O]=c.useState([]),L=V.get("report");c.useEffect(()=>{const s=async()=>{try{const o=await(await fetch(`${g}/get-note-detail/${$}`)).json(),d={item:o.item||"",selectedDrawing:o.drawing||o.selectedDrawing||null,projectUsers:o.projectUsers||o.users||null,projectManager:o.projectManager||null,comment:o.comment||""};p(d),o.pictures&&o.pictures.length>0&&O(o.pictures.map(b=>`${g}/uploads/${b}`)),A(!1)}catch(i){console.error("Error fetching note:",i),A(!1)}},t=async()=>{try{const o=await(await fetch(`${g}/get-draws?companyId=${f}&projectId=${j}`)).json();Q(o)}catch(i){console.error("Error fetching drawings:",i)}},r=async()=>{try{const i=`${g}/get-filter-users`,b=await(await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:f,projectId:j})})).json();G(b)}catch(i){console.error("Error fetching users:",i)}},n=async()=>{try{const i=`${g}/get-project-managers?companyId=${f}&projectId=${j}`,d=await(await fetch(i)).json();X(d)}catch(i){console.error("Error fetching project managers:",i)}};s(),n(),r(),t()},[$,f,j]),c.useEffect(()=>{if(a&&N.length>0&&y.length>0&&S.length>0){let s={...a},t=!1;if(a.selectedDrawing&&typeof a.selectedDrawing=="string"&&a.selectedDrawing.trim()!==""){const r=N.find(n=>n._id===a.selectedDrawing||n.id===a.selectedDrawing);r&&(s.selectedDrawing=r,t=!0)}if(a.projectUsers&&typeof a.projectUsers=="string"&&a.projectUsers.trim()!==""){const r=y.find(n=>n._id===a.projectUsers||n.id===a.projectUsers);r&&(s.projectUsers=r,t=!0)}if(a.projectManager&&typeof a.projectManager=="string"&&a.projectManager.trim()!==""){const r=S.find(n=>n._id===a.projectManager||n.id===a.projectManager);r&&(s.projectManager=r,t=!0)}t&&p(s)}},[N,y,S]);const se=s=>{const t=Array.from(s.target.files),r=t.map(o=>({file:o,description:""})),n=[...u,...r],i=[...w,...t.map(o=>URL.createObjectURL(o))];D(n),M(i)},_=s=>{const t=u.filter((i,o)=>o!==s),r=w.filter((i,o)=>o!==s);D(t),M(r);const n=new DataTransfer;t.forEach(i=>n.items.add(i.file)),k.current&&(k.current.files=n.files)},ae=s=>{const{name:t,value:r}=s.target;p({...a,[t]:r})},re=(s,t)=>{const r=[...u];r[s].description=t,D(r)},ne=s=>{const t=R.filter((r,n)=>n!==s);O(t)},ie=async s=>{s.preventDefault(),T(!0);try{const t=new FormData;t.append("companyId",f),t.append("projectsId",j),t.append("comment",a.comment),t.append("item",a.item),t.append("projectUsers",JSON.stringify(a.projectUsers)),t.append("projectManager",JSON.stringify(a.projectManager)),t.append("drawing",JSON.stringify(a.selectedDrawing)),u.length>0&&u.forEach((n,i)=>{t.append("pictures",n.file),t.append("pictureDescriptions",n.description||"")}),Object.entries(Y).forEach(([n,i])=>{const b=`${n.replace(/[^\w\s.-]/g,"").replace(/\s+/g,"_").split("/").pop().split(".")[0]}.png`;t.append("annotatedPdfs",i,b)});const r=await fetch(`${g}/update-note/${$}`,{method:"POST",body:t});if(r.ok){const n=L?`?report=${encodeURIComponent(L)}`:"";K(`/dashboard/companies/view/${f}/projects/view/${j}${n}`)}else console.error("Error:",r.statusText)}catch(t){console.error("Fetch error:",t)}T(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(me,{title:"Edit Address Note"}),te||!a?e.jsxs("div",{className:"text-center p-4",children:[e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{className:"mt-2",children:"Loading note data..."})]}):e.jsx("form",{onSubmit:ie,children:e.jsx(m,{className:"justify-content-center",children:e.jsx(l,{children:e.jsx(de,{title:"Edit Address Note",children:e.jsxs(m,{children:[e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Select Item"}),e.jsx(l,{sm:"10",children:e.jsxs(ue,{value:a.item||"",name:"item",onChange:ae,children:[e.jsx("option",{value:"",children:"Select Item"}),e.jsx("option",{value:"The work does not follow the schedule.",children:"The work does not follow the schedule."}),e.jsx("option",{value:"The work is not completed.",children:"The work is not completed."}),e.jsx("option",{value:"The relationship causes delays",children:"The relationship causes delays"}),e.jsx("option",{value:"The interfaces cannot receive in that state.",children:"The interfaces cannot receive in that state."}),e.jsx("option",{value:"Manpower must be provided here if the schedule is to be adhered to.",children:"Manpower must be provided here if the schedule is to be adhered to."}),e.jsx("option",{value:"Someone has destroyed my work after final inspection.",children:"Someone has destroyed my work after final inspection."}),e.jsx("option",{value:"Conditions that are taken up at the next building meeting",children:"Conditions that are taken up at the next building meeting"}),e.jsx("option",{value:"The work is notified to be stopped in 3 days, due to non-payment. cf. AB18",children:"The work is notified to be stopped in 3 days, due to non-payment. cf. AB18"})]})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Project Manager"}),e.jsx(l,{sm:"10",children:e.jsx(E,{multiple:!1,options:S,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectManager,onChange:(s,t)=>{p({...a,projectManager:t})},renderInput:s=>e.jsx(v,{...s,variant:"outlined",placeholder:"Search and select Project Manager..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(U,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Recipients"}),e.jsx(l,{sm:"10",children:e.jsx(E,{multiple:!1,options:y,getOptionLabel:s=>s.name,value:a==null?void 0:a.projectUsers,onChange:(s,t)=>{p({...a,projectUsers:t})},renderInput:s=>e.jsx(v,{...s,variant:"outlined",placeholder:"search and select the receiver ..."}),renderTags:(s,t)=>s.map((r,n)=>e.jsx(U,{label:r.name,...t({index:n})})),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{className:"col-sm-2 col-form-label text-end",children:"Comment"}),e.jsx(l,{sm:"10",children:e.jsx(v,{variant:"outlined",placeholder:"Add some comments...",value:(a==null?void 0:a.comment)||"",onChange:s=>{var t;p({...a,comment:(t=s==null?void 0:s.target)==null?void 0:t.value})}})})]})}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"example-text-input",className:"col-sm-2 col-form-label text-end",children:"Select Drawing"}),e.jsx(l,{sm:"10",children:e.jsx(E,{multiple:!1,options:N,getOptionLabel:s=>s.name?s.name:s.mainDrawings&&s.mainDrawings.length>0&&s.mainDrawings[0].original||"No name available",value:a==null?void 0:a.selectedDrawing,onChange:(s,t)=>{p({...a,selectedDrawing:t})},renderInput:s=>e.jsx(v,{...s,variant:"outlined",placeholder:"Search and select drawing..."}),renderTags:(s,t)=>s.map((r,n)=>{const i=r.name||(r.mainDrawings&&r.mainDrawings.length>0?r.mainDrawings[0].original:"No name available");return e.jsx(U,{label:i,...t({index:n})})}),sx:{"& .MuiOutlinedInput-root":{borderRadius:"6px",backgroundColor:"#f8f9fa",padding:"5px"}}})})]})}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(l,{lg:"12",className:"mb-4",children:[e.jsx("h5",{children:"Main Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(B=(z=a==null?void 0:a.selectedDrawing)==null?void 0:z.mainDrawings)==null?void 0:B.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",onClick:()=>{const r=s.original;F({show:!0,pdfFile:`${g}/uploads/${s.stored}`,name:r})},style:{cursor:"pointer"},children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`main-${t}`))})]}),(h==null?void 0:h.show)&&e.jsx(pe,{pdfUrl:h.pdfFile,onClose:()=>F({show:!1,pdfFile:null}),onSave:(s,t)=>{ee(t),Z(r=>({...r,[h.name.endsWith(".png")?h.name:`${h.name}.png`]:s})),F({show:!1,pdfFile:null})}}),(a==null?void 0:a.selectedDrawing)&&e.jsxs(l,{lg:"12",children:[e.jsx("h5",{children:"Child Drawings"}),e.jsx("div",{className:"d-flex flex-wrap",children:(J=(W=a==null?void 0:a.selectedDrawing)==null?void 0:W.childDrawings)==null?void 0:J.map((s,t)=>e.jsxs("div",{className:"me-2 mb-2 text-center",children:[e.jsx("i",{className:"fas fa-file-pdf",style:{fontSize:"2rem",color:"#dc3545"}}),e.jsx("div",{className:"small text-muted",children:s==null?void 0:s.original})]},`child-${t}`))})]}),e.jsx(l,{lg:"6",children:e.jsxs(m,{className:"mb-3",children:[e.jsx(x,{htmlFor:"multiple-file-input",className:"col-sm-2 col-form-label text-end",children:C>0?`Pictures (${C} marks)`:"Pictures"}),e.jsx(l,{sm:"10",children:C>0?e.jsx("div",{className:"mb-3",children:Array.from({length:C}).map((s,t)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"mb-1",children:["Upload pictures for mark #",t+1]}),e.jsx(H,{type:"file",name:`picture-mark-${t+1}`,onChange:r=>{const n=Array.from(r.target.files);if(n.length>0){const i=[...u];n.forEach(d=>{i.push({file:d,description:"",markNumber:t+1})}),D(i);const o=[...w];n.forEach(d=>{o.push(URL.createObjectURL(d))}),M(o)}},accept:"image/*",multiple:!0}),e.jsx("div",{className:"mt-3 d-flex flex-wrap",children:u.map((r,n)=>{if(r.markNumber===t+1){const i=w[n];return e.jsxs("div",{className:"position-relative me-2 mb-3",style:{width:"200px"},children:[e.jsx(I,{src:i,alt:`Preview ${n}`,fluid:!0,rounded:!0,style:{maxWidth:"100%",maxHeight:"100px"}}),e.jsx(v,{variant:"outlined",placeholder:"Add description...",value:r.description,onChange:o=>re(n,o.target.value),fullWidth:!0,size:"small",className:"mt-1"}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>_(n),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},n)}return null})})]},t))}):e.jsxs(e.Fragment,{children:[e.jsx(H,{type:"file",id:"multiple-file-input",name:"pictures",onChange:se,accept:"image/*",multiple:!0,ref:k}),e.jsxs("div",{className:"mt-3 d-flex flex-wrap",children:[w.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(I,{src:s,alt:`Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>_(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},t)),R.map((s,t)=>e.jsxs("div",{className:"position-relative me-2 mb-2",children:[e.jsx(I,{src:s,alt:`Existing Preview ${t}`,fluid:!0,rounded:!0,style:{maxWidth:"100px",maxHeight:"100px"}}),e.jsx(P,{variant:"danger",size:"sm",className:"position-absolute top-0 end-0",onClick:()=>ne(t),style:{transform:"translate(50%, -50%)",borderRadius:"50%"},children:"×"})]},`existing-${t}`))]})]})})]})}),e.jsx(m,{className:"mb-3 d-flex justify-content-center",children:e.jsx(l,{sm:"12",className:"d-flex justify-content-end",children:e.jsx(P,{disabled:q,type:"submit",variant:"primary",className:"me-1",children:"Submit"})})})]})})})})})]})};export{ze as default};
